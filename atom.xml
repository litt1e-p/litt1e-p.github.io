<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[litt1e-p]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="https://litt1e-p.github.io/"/>
  <updated>2018-03-07T13:05:43.542Z</updated>
  <id>https://litt1e-p.github.io/</id>
  
  <author>
    <name><![CDATA[litt1e-p]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[Elegant Swift -- Use @autoclosure to simplify swift syntax]]></title>
    <link href="https://litt1e-p.github.io/2018/03/07/Elegant-Swift-Use-autoclosure-to-simplify-swift-syntax/"/>
    <id>https://litt1e-p.github.io/2018/03/07/Elegant-Swift-Use-autoclosure-to-simplify-swift-syntax/</id>
    <published>2018-03-07T10:07:10.000Z</published>
    <updated>2018-03-07T13:05:43.542Z</updated>
    <content type="html"><![CDATA[<h2 id="ä¼˜é›…çš„Swift-ä½¿ç”¨@autoclosureç®€åŒ–è¯­æ³•">ä¼˜é›…çš„Swift-ä½¿ç”¨@autoclosureç®€åŒ–è¯­æ³•</h2><p>åœ¨swiftä¸­ï¼Œ@autoclosureå±æ€§å¸¸ç”¨äºclosureé—­åŒ…ä¸­å‚æ•°ä¼ é€’å€¼æ—¶çš„ç®€åŒ–è¡¨è¾¾ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå¯ä»¥åœ¨é—­åŒ…å‚æ•°ä¼ é€’æ—¶ä¸ç”¨å†ä½¿ç”¨èŠ±æ‹¬å·{}ã€‚</p>
<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">foo1</span><span class="params">(<span class="number">_</span> lhs: <span class="params">()</span></span></span> -&gt; <span class="type">Int</span>, <span class="number">_</span> rhs: () -&gt; <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(lhs)</span> &amp; <span class="subst">\(rhs)</span>"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">foo2</span><span class="params">(<span class="number">_</span> lhs: @autoclosure <span class="params">()</span></span></span> -&gt; <span class="type">String</span>, <span class="number">_</span> rhs: <span class="preprocessor">@autoclosure</span> () -&gt; <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(lhs)</span> &amp; <span class="subst">\(rhs)</span>"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‹¥ä¸ä½¿ç”¨<code>@autoclosure</code>å±æ€§ï¼Œå¦‚foo1, è°ƒç”¨æ—¶ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">foo1</span><span class="params">(&#123;<span class="number">1</span>&#125;, &#123;<span class="string">"true"</span>&#125;)</span></span></span><br></pre></td></tr></table></figure>
<p>å‡å¦‚åŠ å…¥äº†<code>@autoclosure</code>å±æ€§ï¼Œå¦‚foo2, åˆ™ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">foo2</span><span class="params">(<span class="number">1</span>+<span class="number">2</span>, <span class="string">"true"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸æ˜¯ç®€å•å¤šäº†ï¼Ÿ</p>
<h4 id="@autoclosureé»‘é­”æ³•">@autoclosureé»‘é­”æ³•</h4><blockquote>
<p><strong>åŠ¨æ€ç±»å‹æŒ‡å®š</strong></p>
</blockquote>
<p>å½“æˆ‘ä»¬ä¸çŸ¥é“æŸäº›å˜é‡çš„ç±»å‹æ—¶ï¼Œå¦‚åœ¨UserDefaultä¸­ã€åœ¨æ•°æ®åº“ä¸­ã€åœ¨Dictionaryä¸­æ—¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨è§£åŒ…å–å€¼çš„æ—¶å€™èµ‹å€¼ä¸€ä¸ªé»˜è®¤å€¼å¹¶ä¸”æŒ‡å®šç±»å‹ï¼š</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> score = (UserDefaults.standard.<span class="keyword">value</span>(forKey: <span class="string">"SomeKey"</span>) <span class="keyword">as</span>? Int) ?? <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„å†™æ³•ï¼Œä¸ä»…å¯è¯»æ€§éå¸¸å·®ï¼Œè€Œä¸”è¿˜ä¸å¤ªä¼˜é›…ã€‚å¦‚æœåˆ©ç”¨<code>@autoclosure</code>å±æ€§ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UserDefaults</span> </span>&#123;</span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">value</span><span class="generics">&lt;T&gt;</span><span class="params">(forKey key: String, defaultValue: @autoclosure <span class="params">()</span></span></span> -&gt; <span class="type">T</span>) -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> value = <span class="keyword">self</span>.value(forKey: key) <span class="keyword">as</span>? <span class="type">T</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defaultValue()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">val</span> = <span class="type">UserDefaults</span>.standard.<span class="keyword">value</span>(forKey: <span class="string">"SomeKey"</span>, defaultValue: <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>ç»“æœä¸­çš„valçš„ç±»å‹åˆ™ç”±defaultValueå‚æ•°çš„ç±»å‹å†³å®šã€‚å¯¹æ¯”å¸¸è§„å†™æ³•ï¼Œæ˜¯ä¸æ˜¯ä¼˜é›…å¤šäº†ï¼Ÿ</p>
<h4 id="æ³¨æ„ç‚¹">æ³¨æ„ç‚¹</h4><p><code>@autoclosure</code>é»˜è®¤æ˜¯<code>nonescape</code>çš„ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨<code>@autoclosure</code>çš„åŸºç¡€ä¸Šåšè¿›ä¸€æ­¥çš„è¯´æ˜ï¼ŒæŒ‡æ˜è¿™ä¸ªé—­åŒ…å‚æ•°æ˜¯å¯é€ƒé€¸çš„ã€‚</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func foo<span class="function"><span class="params">(f: <span class="property">@autoclosure</span>(escaping) () -&gt; ())</span> &#123;</span><br><span class="line">    <span class="title">f</span><span class="params">()</span></span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h5><blockquote>
<p><a href="https://medium.com/@johnsundell/using-autoclosure-when-designing-swift-apis-67fe20a8b2e" target="_blank" rel="external">https://medium.com/@johnsundell/using-autoclosure-when-designing-swift-apis-67fe20a8b2e</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä¼˜é›…çš„Swift-ä½¿ç”¨@autoclosureç®€åŒ–è¯­æ³•">ä¼˜é›…çš„Swift-ä½¿ç”¨@autoclosureç®€åŒ–è¯­æ³•</h2><p>åœ¨swiftä¸­ï¼Œ@autoclosureå±æ€§å¸¸ç”¨äºclosureé—­åŒ…ä¸­å‚æ•°ä¼ é€’å€¼æ—¶çš„ç®€åŒ–è¡¨è¾¾ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå¯ä»¥åœ¨é—­åŒ…å‚æ•°ä¼ é€’æ—¶ä¸ç”¨å†ä½¿ç”¨èŠ±]]>
    </summary>
    
      <category term="elegant swift" scheme="https://litt1e-p.github.io/tags/elegant-swift/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Elegant Swift -- URL]]></title>
    <link href="https://litt1e-p.github.io/2018/02/18/Elegant-Swift-URL/"/>
    <id>https://litt1e-p.github.io/2018/02/18/Elegant-Swift-URL/</id>
    <published>2018-02-18T11:29:13.000Z</published>
    <updated>2018-03-07T12:59:44.060Z</updated>
    <content type="html"><![CDATA[<h2 id="ä¼˜é›…çš„Swift_â€“_çƒ¦äººçš„URL">ä¼˜é›…çš„Swift â€“ çƒ¦äººçš„URL</h2><p>åœ¨æ—¥å¸¸codingä¸­ï¼Œå¯¹äºURLä¼ å‚ï¼Œæ—¶å¸¸ä¼šè¯¯ä¼ äº†stringç±»å‹çš„urlï¼Œå¦‚ï¼š</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="string">"https://www.github.com"</span></span><br><span class="line"><span class="keyword">let</span> task = URLSession.<span class="keyword">shared</span>.dataTask(<span class="keyword">with</span>: url)</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯ç¼–è¯‘å™¨æŠ¥é”™ï¼Œç„¶ååˆæ‚»æ‚»åŠ ä¸Š<code>URL(string: &quot;url address&quot;)</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let url = <span class="string">"https://www.github.com"</span></span><br><span class="line">let task = URLSession<span class="class">.shared</span><span class="class">.dataTask</span>(with: <span class="function"><span class="title">URL</span><span class="params">(string: url)</span></span>)</span><br></pre></td></tr></table></figure>
<p>æœ‰æ²¡æœ‰ä¸€ç§ä¼˜é›…çš„æ–¹å¼ï¼Œè®©æˆ‘ä»¬ç›´æ¥å°±è¾“å…¥Stringç±»å‹çš„ç½‘å€urlï¼Œè‡ªåŠ¨è¯†åˆ«è½¬æ¢æˆä¸ºURLç±»å‹çš„å‚æ•°å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯æœ‰çš„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">URL</span>: <span class="title">ExpressibleByStringLiteral</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// By using 'StaticString' we disable string interpolation, for safety</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(stringLiteral value: <span class="type">StaticString</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span> = <span class="type">URL</span>(string: <span class="string">"<span class="subst">\(value)</span>"</span>).require(hint: <span class="string">"Invalid URL string literal: <span class="subst">\(value)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let task = URLSession<span class="class">.shared</span><span class="class">.dataTask</span>(with: <span class="string">"https://www.github.com"</span>)</span><br></pre></td></tr></table></figure>
<p>ä¼˜é›…ä¸€å¥è¯æå®šï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘å¿˜è®°å†™<code>URL(string:)</code>äº†ã€‚</p>
<blockquote>
<p>è¿™é‡Œçš„requireä¹Ÿæ˜¯ä¸€ä¸ªextensionæ–¹æ³•ï¼Œä¸ºäº†å¢åŠ å®‰å…¨æ€§åˆ¤æ–­</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Optional</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// å¼ºåˆ¶è¦æ±‚è¿™ä¸ª optional ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">/// - hint: ä¸ºç©ºæŠ›å‡ºçš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Returns: optional çš„å€¼.</span></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">require</span><span class="params">(hint hintExpression: @autoclosure<span class="params">()</span></span></span> -&gt; <span class="type">String</span>? = <span class="literal">nil</span>, file: <span class="type">StaticString</span> = #file, line: <span class="type">UInt</span> = #line) -&gt; <span class="type">Wrapped</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> unwrapped = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> message = <span class="string">"required value was nil <span class="subst">\(file)</span>, at line <span class="subst">\(line)</span>"</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> hint = hintExpression() &#123;</span><br><span class="line">                message.append(<span class="string">". Debugging hit: <span class="subst">\(hint)</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            #<span class="keyword">if</span> !os(<span class="type">Linux</span>)</span><br><span class="line">            <span class="keyword">let</span> exception = <span class="type">NSException</span>(name: .invalidArgumentException,</span><br><span class="line">                                        reason: message,</span><br><span class="line">                                        userInfo: <span class="literal">nil</span>)</span><br><span class="line">            exception.raise()</span><br><span class="line">            #endif</span><br><span class="line"></span><br><span class="line">            <span class="built_in">preconditionFailure</span>(message)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unwrapped</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ€»ç»“">æ€»ç»“</h4><p>è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„æ€è·¯ï¼ŒæŠ›ç –å¼•ç‰ï¼Œå¤§å®¶å¯ä»¥å‘æ•£å¼€æ¥ï¼Œä¸ºå…¶ä»–ç±»å‹æˆ–è€…æ–¹æ³•å†™æ›´å¤šæ›´ä¼˜é›…çš„ä»£ç ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä¼˜é›…çš„Swift_â€“_çƒ¦äººçš„URL">ä¼˜é›…çš„Swift â€“ çƒ¦äººçš„URL</h2><p>åœ¨æ—¥å¸¸codingä¸­ï¼Œå¯¹äºURLä¼ å‚ï¼Œæ—¶å¸¸ä¼šè¯¯ä¼ äº†stringç±»å‹çš„urlï¼Œå¦‚ï¼š</p>
<figure class="highlight vbnet"><table><tr>]]>
    </summary>
    
      <category term="elegant swift" scheme="https://litt1e-p.github.io/tags/elegant-swift/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Elegant Swift -- UnWrapped or Default Value]]></title>
    <link href="https://litt1e-p.github.io/2018/02/01/Elegant-Swift-UnWrapped-or-Default-Value/"/>
    <id>https://litt1e-p.github.io/2018/02/01/Elegant-Swift-UnWrapped-or-Default-Value/</id>
    <published>2018-02-01T14:18:10.000Z</published>
    <updated>2018-03-07T12:58:52.626Z</updated>
    <content type="html"><![CDATA[<h2 id="ä¼˜é›…çš„Swiftâ€“è§£åŒ…">ä¼˜é›…çš„Swiftâ€“è§£åŒ…</h2><p>é€šå¸¸æˆ‘ä»¬åœ¨swiftä¸­å¯¹å¯é€‰å€¼ç±»å‹(optional)è¿›è¡Œè§£åŒ…(unwrapped)æ“ä½œæ—¶ï¼Œ<br>ä¼šè¿›è¡Œä¸€äº›å¸¸è§„çš„åˆ¤æ–­ï¼Œå¦‚ï¼š</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a: <span class="built_in">String</span>?</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> _ = a &#123;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå†è¿›è¡Œè§£åŒ…æ“ä½œã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´åŠ ä¼˜é›…çš„æ–¹å¼å‘¢ï¼Ÿ</p>
<ul>
<li>åˆ©ç”¨extensionè¿›è¡Œè§£åŒ…</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Optional</span> </span>&#123;</span><br><span class="line">@discardableResult</span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">ifSome</span><span class="params">(<span class="number">_</span> closure: <span class="params">(Wrapped)</span></span></span> -&gt; <span class="type">Void</span>) -&gt; <span class="type">Optional</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> .some(<span class="keyword">let</span> wrapped): closure(wrapped); <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    <span class="keyword">case</span> .<span class="keyword">none</span>: <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@discardableResult</span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">ifNone</span><span class="params">(<span class="number">_</span> closure: <span class="params">()</span></span></span> -&gt; ()) -&gt; <span class="type">Optional</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> .some: <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">case</span> .<span class="keyword">none</span>: closure(); <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼š <code>ifSome</code>æ–¹æ³•åˆ©ç”¨äº†extensionç»™å¯é€‰å€¼è¿›è¡Œå†…éƒ¨è§£åŒ…æ“ä½œï¼Œé€šè¿‡ä¼ å…¥ä¸€ä¸ªclosureè¿›è¡Œæ˜¯å¦éœ€è¦è§£åŒ…çš„åˆ¤æ–­ä¹‹åæ‰§è¡Œclosureï¼Œ<code>ifNone</code>äº¦åŒç†ã€‚</p>
<p>ä½¿ç”¨æ–¹æ³•</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let <span class="operator">a</span>: String? = <span class="string">"str"</span></span><br><span class="line"><span class="operator">a</span>.ifSome(&#123;</span><br><span class="line"><span class="comment"> //do something</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="operator">a</span>.ifNone(&#123;</span><br><span class="line"><span class="comment"> //do something</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ©ç”¨extensionèµ‹äºˆé»˜è®¤å€¼</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Optional</span> </span>&#123;</span><br><span class="line">    <span class="func"><span class="keyword">func</span> `<span class="title">or</span>`<span class="params">(<span class="number">_</span> value: Wrapped)</span></span> -&gt; <span class="type">Wrapped</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span> ?? value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼šä¸è§£é‡Šäº†ï¼Œç®€å•ã€‚</p>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a: <span class="built_in">String</span>? = nil</span><br><span class="line"><span class="keyword">let</span> v = a.or(<span class="string">"b"</span>)</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œæœ‰äººå°±ä¼šé—®äº†ï¼Œç›´æ¥ä½¿ç”¨<code>??</code>è¿›è¡Œè§£åŒ…åŠé»˜è®¤å€¼èµ‹å€¼ä¸æ›´ç®€å•å—ï¼Ÿ</p>
<p>æ²¡é”™ï¼Œçœ‹èµ·æ¥æ˜¯å†™æ›´å°‘çš„ä»£ç çœ‹èµ·æ¥æ›´ç®€å•äº†ï¼Œå®é™…ä¸Šä½¿ç”¨extensionçš„è¿™æ ·çš„æ–¹æ³•åœ¨å†™æ³•ä¸Šä¼šå¢åŠ å¯è¯»æ€§ï¼Œå› ä¸ºæœ¬æ¥çš„å¯é€‰ç±»å‹(Optional)è§£åŒ…æ—¶å°±å¸¦äº†ä¸ª<code>?</code>, å¤ªå¤š<code>?</code>å†™åœ¨ä¸€èµ·æ¯”è¯­ä¹‰åŒ–çš„<code>or</code>ä¼šé™ä½ä»£ç çš„å¯è¯»æ€§ã€‚ä¸ç®¡å¦‚ä½•ï¼Œè§ä»è§æ™ºäº†ã€‚</p>
<h5 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h5><blockquote>
<p><a href="https://medium.com/swift-snippets/swift-snippet-7-optional-cd9869b8b569" target="_blank" rel="external">https://medium.com/swift-snippets/swift-snippet-7-optional-cd9869b8b569</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä¼˜é›…çš„Swiftâ€“è§£åŒ…">ä¼˜é›…çš„Swiftâ€“è§£åŒ…</h2><p>é€šå¸¸æˆ‘ä»¬åœ¨swiftä¸­å¯¹å¯é€‰å€¼ç±»å‹(optional)è¿›è¡Œè§£åŒ…(unwrapped)æ“ä½œæ—¶ï¼Œ<br>ä¼šè¿›è¡Œä¸€äº›å¸¸è§„çš„åˆ¤æ–­ï¼Œå¦‚ï¼š</p>
<figure class="highlight lasso">]]>
    </summary>
    
      <category term="elegant swift" scheme="https://litt1e-p.github.io/tags/elegant-swift/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Elegant Swift -- Range]]></title>
    <link href="https://litt1e-p.github.io/2018/01/17/Elegant-Swift-Range/"/>
    <id>https://litt1e-p.github.io/2018/01/17/Elegant-Swift-Range/</id>
    <published>2018-01-17T12:56:45.000Z</published>
    <updated>2018-03-07T12:57:45.854Z</updated>
    <content type="html"><![CDATA[<h2 id="ä¼˜é›…çš„Swiftâ€“èŒƒå›´åˆ¤æ–­(ï½=æ“ä½œç¬¦)">ä¼˜é›…çš„Swiftâ€“èŒƒå›´åˆ¤æ–­(ï½=æ“ä½œç¬¦)</h2><p>æˆ‘ä»¬å¯¹æ•°ç»„å–å€¼æ˜¯å¦è¶Šç•Œè¿›è¡Œåˆ¤æ–­ï¼Œé€šå¸¸çš„å†™æ³•æ˜¯ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">item</span><span class="params">(at index: Int, array: Array&lt;Element&gt;)</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">    <span class="keyword">guard</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; array.<span class="built_in">count</span> - <span class="number">1</span> &#123; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> array[index]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä¼˜é›…ä¸€ç‚¹å†™æˆè¿™æ ·ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span> </span>&#123;</span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">item</span><span class="params">(at index: Int)</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">        <span class="keyword">guard</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; <span class="keyword">self</span>.<span class="built_in">count</span> - <span class="number">1</span> &#123; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>[index]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰æ²¡æœ‰æ›´ä¼˜é›…çš„å†™æ³•å‘¢ï¼Ÿçœ‹çœ‹ä¸‹é¢è¿™æ ·å†™ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span> </span>&#123;</span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">item</span><span class="params">(at index: Int)</span></span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">        <span class="keyword">guard</span> startIndex..&lt;endIndex ~= index <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>[index]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸æ˜¯æ›´åŠ ä¼˜é›…ç‚¹äº†å‘¢ï¼Ÿ</p>
<p>æ“ä½œç¬¦Operator<code>~=</code>å…¶å®æ˜¯ç”¨äºåŒ¹é…caseæ“ä½œçš„ï¼Œä¸‹é¢ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<ol>
<li>å…ˆå®šä¹‰ä¸€ä¸ªstruct</li>
</ol>
<figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    let name: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>å†implement<code>~=</code>æ–¹æ³•</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> ~=<span class="params">(pattern: String, value: Pet)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> value.name == pattern</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>ä½¿ç”¨</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="type">Pet</span>(name: <span class="string">"Poly"</span>)</span><br><span class="line"><span class="keyword">switch</span> p &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"Poly"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"I am Poly"</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"no me"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å½“è°ƒç”¨<code>case</code>æ—¶ï¼Œä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>~=</code>æ–¹æ³•è¿›è¡Œåˆ¤æ–­</strong></p>
<p>æˆ–è€…è¿™æ ·åˆ¤æ–­ä¹Ÿä¼šè°ƒç”¨è‡ªå®šä¹‰çš„<code>~=</code>æ–¹æ³•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">case</span> <span class="string">"Poly"</span> = p &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"It's still me!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±æ­¤å¾—çŸ¥Arrayçš„extensionæ–¹æ³•ä¸­çš„<code>startIndex..&lt;endIndex ~= index</code>åŒæ ·æ˜¯è°ƒç”¨äº†åœ¨å…¶å†…éƒ¨å®ç°çš„<code>~=</code>æ–¹æ³•ã€‚</p>
<h4 id="~=_çš„æ›´å¤šç¤ºä¾‹"><code>~=</code> çš„æ›´å¤šç¤ºä¾‹</h4><ul>
<li>1 æ£€æµ‹å˜é‡næ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…(10~100)</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let n: Int = <span class="number">100</span></span><br><span class="line"><span class="comment">// using "patterns"</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">10.</span>.<span class="number">.100</span> ~= n&#123;</span><br><span class="line">    print(<span class="string">"inside!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>2 æ£€æµ‹httpå“åº”å€¼</li>
</ul>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="built_in">response</span> = <span class="built_in">response</span> as? HTTPURLResponse , <span class="number">200.</span>.<span class="number">.299</span> ~= <span class="built_in">response</span>.statusCode &#123;</span><br><span class="line">    <span class="keyword">let</span> contentLength : Int64 = <span class="built_in">response</span>.expectedContentLength</span><br><span class="line">    completionHandler(contentLength)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    completionHandler(nil)</span><br></pre></td></tr></table></figure>
<h5 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h5><blockquote>
<p><a href="https://stackoverflow.com/questions/38371870/operator-in-swift" target="_blank" rel="external">https://stackoverflow.com/questions/38371870/operator-in-swift</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä¼˜é›…çš„Swiftâ€“èŒƒå›´åˆ¤æ–­(ï½=æ“ä½œç¬¦)">ä¼˜é›…çš„Swiftâ€“èŒƒå›´åˆ¤æ–­(ï½=æ“ä½œç¬¦)</h2><p>æˆ‘ä»¬å¯¹æ•°ç»„å–å€¼æ˜¯å¦è¶Šç•Œè¿›è¡Œåˆ¤æ–­ï¼Œé€šå¸¸çš„å†™æ³•æ˜¯ï¼š</p>
<figure class="highlight swift"><table><tr><td class="]]>
    </summary>
    
      <category term="elegant swift" scheme="https://litt1e-p.github.io/tags/elegant-swift/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Elegant Swift -- Operator]]></title>
    <link href="https://litt1e-p.github.io/2018/01/14/Elegant-Swift-Operator/"/>
    <id>https://litt1e-p.github.io/2018/01/14/Elegant-Swift-Operator/</id>
    <published>2018-01-14T15:54:58.000Z</published>
    <updated>2018-03-07T12:56:18.457Z</updated>
    <content type="html"><![CDATA[<h2 id="ä¼˜é›…çš„Swift_â€“_è‡ªå®šä¹‰æ“ä½œç¬¦(Operator)">ä¼˜é›…çš„Swift â€“ è‡ªå®šä¹‰æ“ä½œç¬¦(Operator)</h2><p>è‡ªä»æœ‰äº†extensionåï¼Œswiftå†™å‡ºçš„ä»£ç å˜å¾—ä¼˜é›…äº†è®¸å¤šã€‚æˆ‘ä»¬å¸¸ä¼šçœ‹åˆ°ä¸€äº›å¼€æºçš„ç¬¬ä¸‰æ–¹åº“ä¼šå‡ºç°ä¸€äº›è¯¡å¼‚çš„ç¬¦å·ã€‚æ¯”å¦‚è‘—åçš„jsonè§£æåº“<a href="https://github.com/hkellaway/Gloss" target="_blank" rel="external">gloss</a>ä¸­çš„<code>~~&gt;</code>ã€<code>&lt;~~</code>ï¼Œè¿˜æœ‰<a href="https://github.com/thoughtbot/Argo" target="_blank" rel="external">Argo</a>ä¸­çš„<code>&lt;^&gt;</code>ã€<code>&lt;*&gt;</code>ã€<code>&lt;|</code>ã€<code>&lt;|?</code>ã€<code>&lt;||</code>ç­‰ç­‰ã€‚</p>
<p>è¿™ç§å«åšæ“ä½œç¬¦(Operator)çš„ä¸œè¥¿å®é™…ä¸Šæ¯”extensionæ›´åŠ åœ°ä¼˜é›…ï¼Œå› ä¸ºä¸ç”¨å†å†™ä¸ªæ–¹æ³•åæ¥è°ƒç”¨ï¼Œç®€å•ä¸€ä¸ªç¬¦å·å³å¯ç¥å¥‡åœ°è¾¾åˆ°è°ƒç”¨çš„ç›®çš„ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸ªæ“ä½œç¬¦ï¼Œæ¥å®ç°ç®€å•base64åŠ å¯†çš„åŠŸèƒ½ã€‚</p>
<h5 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h5><p>1.è¿ç®—ç¬¦å®šä¹‰</p>
<ul>
<li>prefix è¡¨ç¤ºå®šä¹‰ä¸€ä¸ªå‰ä½æ“ä½œç¬¦ï¼ˆå‰æ˜¯è¾“å…¥ï¼‰</li>
<li>infix è¡¨ç¤ºå®šä¹‰ä¸€ä¸ªä¸­ä½æ“ä½œç¬¦ï¼ˆå‰åéƒ½æ˜¯è¾“å…¥ï¼‰</li>
<li>postfix è¡¨ç¤ºå®šä¹‰ä¸€ä¸ªåä½æ“ä½œç¬¦ï¼ˆåæ˜¯è¾“å…¥ï¼‰</li>
</ul>
<p>2.ç»“åˆå¾‹ associativity (è®¡ç®—é¡ºåº)</p>
<ul>
<li>left ï¼ˆä»å·¦å¾€å³çš„é¡ºåºï¼‰</li>
<li>rightï¼ˆä»å³å¾€å·¦çš„é¡ºåºï¼‰</li>
<li>noneï¼ˆé»˜è®¤å°±ä¸º noneï¼Œä¸ä¼šå†ç»“åˆï¼‰</li>
</ul>
<p>3.ä¼˜å…ˆçº§ Precedence</p>
<ul>
<li>higherThan ä¼˜å…ˆçº§é«˜äº</li>
<li>lowerThan ä¼˜å…ˆçº§ä½äº</li>
</ul>
<p>å¸¸ç”¨çš„Precedenceï¼Œè¯¦è§<a href="https://developer.apple.com/documentation/swift/operator_declarations" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a></p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªPrecedenceã€‚</p>
<h5 id="å®æˆ˜">å®æˆ˜</h5><p>ç®€å•ç”¨ä¸€ä¸ªè‡ªå®šä¹‰æ“ä½œç¬¦ï¼Œå®ç°base64åŠ å¯†å’Œè§£å¯†åŠŸèƒ½ã€‚</p>
<ol>
<li><p>å…ˆå®šä¹‰ä¸€ä¸ªä¼˜å…ˆçº§group</p>
 <figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">precedencegroup</span> <span class="tag">MyPrecedence</span> &#123;</span><br><span class="line"> <span class="attribute">associativity</span>: none</span><br><span class="line"> <span class="attribute">higherThan</span>: AdditionPrecedence</span><br><span class="line"> <span class="attribute">lowerThan</span>: MultiplicationPrecedence</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> è¿™é‡Œassociativityå› ä¸ºæ²¡æœ‰å‰åè¾“å…¥é¡ºåºå°±ç›´æ¥ä½¿ç”¨é»˜è®¤çš„noneï¼ŒPrecedenceæˆ‘ä»¬æ¯”åŠ æ³•(AdditionPrecedence)é«˜ï¼Œæ¯”ä¹˜æ³•(MultiplicationPrecedence)ä½å°±è¡Œäº†ï¼Œå› ä¸ºå¦‚æœæ˜¯æ•°å­—é‡åˆ°è¿ç®—éœ€è¦è¿›è¡Œä¼˜å…ˆçº§çš„åˆ¤æ–­ã€‚</p>
</li>
<li><p>å®šä¹‰ä¸€ä¸ªæ“ä½œç¬¦</p>
 <figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="infix"><span class="keyword">infix</span> operator *=* : MyPrecedence</span></span><br></pre></td></tr></table></figure>
<p> è¿™é‡Œå®šä¹‰ä¸€ä¸ªä¸­ä½æ“ä½œç¬¦</p>
</li>
<li><p>å®ç°åŠŸèƒ½çš„æ–¹æ³•</p>
 <figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> enum CryptoType &#123;</span><br><span class="line">    <span class="keyword">case</span> encrypt, decrypt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func *=* (input: <span class="built_in">String</span>, <span class="keyword">type</span>: CryptoType) <span class="subst">-&gt; </span><span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">type</span> == <span class="built_in">.</span>encrypt &#123;</span><br><span class="line">        guard <span class="keyword">let</span> utf8Data = input<span class="built_in">.</span><span class="built_in">data</span>(using: <span class="built_in">String</span><span class="built_in">.</span>Encoding<span class="built_in">.</span>utf8) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">String</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> utf8Data<span class="built_in">.</span>base64EncodedString()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        guard <span class="keyword">let</span> utf8Data = <span class="built_in">Data</span>(base64Encoded: input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">String</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">String</span>(<span class="built_in">data</span>: utf8Data, encoding: <span class="built_in">.</span>utf8) ?? <span class="built_in">String</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> è¿™é‡Œå£°æ˜ä¸€ä¸ªæšä¸¾ï¼ŒåŠ¨æ€åˆ‡æ¢åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚</p>
</li>
<li><p>æµ‹è¯•</p>
 <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let <span class="operator">a</span> = <span class="string">"1234567890"</span> *=* .<span class="built_in">encrypt</span></span><br><span class="line">print(<span class="operator">a</span>)<span class="comment"> // MTIzNDU2Nzg5MA==</span></span><br><span class="line">let b = <span class="operator">a</span> *=* .<span class="built_in">decrypt</span></span><br><span class="line">print(b)<span class="comment"> // 1234567890</span></span><br></pre></td></tr></table></figure>
<p> å¤§åŠŸå‘Šæˆã€‚æ’’èŠ±ğŸ‰ğŸ‰ğŸ‰</p>
</li>
</ol>
<h5 id="æ€»ç»“">æ€»ç»“</h5><p>ä½¿ç”¨è‡ªå®šä¹‰æ“ä½œç¬¦ï¼Œå¯ä»¥å¤§å¤§æé«˜ä»£ç ä¼˜(zhuang)é›…(bi)æ€§ï¼Œç›¸å¯¹äºextensionæ›´åŠ ç®€æ´æ˜äº†ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œè‡ªå®šä¹‰æ“ä½œç¬¦çš„ä½œç”¨åŸŸæ˜¯å…¨å±€çš„ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä¸€äº›é£é™©ï¼Œæ…é‡ä½¿ç”¨ã€‚</p>
<h5 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h5><blockquote>
<p><a href="https://developer.apple.com/documentation/swift/operator_declarations#topic-content" target="_blank" rel="external">https://developer.apple.com/documentation/swift/operator_declarations#topic-content</a></p>
<p><a href="https://stackoverflow.com/questions/45134496/understanding-precedence-groups-assignment-in-swift-3-1" target="_blank" rel="external">https://stackoverflow.com/questions/45134496/understanding-precedence-groups-assignment-in-swift-3-1</a>;</p>
<p><a href="https://github.com/NSCookies/articles/blob/master/publish/%E8%A3%85%E4%B8%AA%E9%80%BC%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%89%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6.md" target="_blank" rel="external">https://github.com/NSCookies/articles/blob/master/publish/%E8%A3%85%E4%B8%AA%E9%80%BC%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%89%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6.md</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä¼˜é›…çš„Swift_â€“_è‡ªå®šä¹‰æ“ä½œç¬¦(Operator)">ä¼˜é›…çš„Swift â€“ è‡ªå®šä¹‰æ“ä½œç¬¦(Operator)</h2><p>è‡ªä»æœ‰äº†extensionåï¼Œswiftå†™å‡ºçš„ä»£ç å˜å¾—ä¼˜é›…äº†è®¸å¤šã€‚æˆ‘ä»¬å¸¸ä¼šçœ‹åˆ°ä¸€äº›å¼€æºçš„ç¬¬ä¸‰æ–¹åº“ä¼šå‡ºç°ä¸€äº›è¯¡å¼‚çš„ç¬¦å·ã€‚æ¯”å¦‚è‘—åçš„json]]>
    </summary>
    
      <category term="Operator" scheme="https://litt1e-p.github.io/tags/Operator/"/>
    
      <category term="elegant swift" scheme="https://litt1e-p.github.io/tags/elegant-swift/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Elegant Swift -- Generic typealias in closure]]></title>
    <link href="https://litt1e-p.github.io/2018/01/09/Elegant-Swift-Generic-typealias-in-closure/"/>
    <id>https://litt1e-p.github.io/2018/01/09/Elegant-Swift-Generic-typealias-in-closure/</id>
    <published>2018-01-09T12:33:39.000Z</published>
    <updated>2018-03-07T12:34:40.868Z</updated>
    <content type="html"><![CDATA[<h2 id="ä¼˜é›…çš„Swift_â€“_é—­åŒ…ä¸­çš„èŒƒå‹">ä¼˜é›…çš„Swift â€“ é—­åŒ…ä¸­çš„èŒƒå‹</h2><p>ä»swift 3å¼€å§‹æœ‰äº†èŒƒå‹(Generic type), èŒƒå‹é™¤äº†å¸¸ç”¨åœ¨æ–¹æ³•é‡Œä½œå‚æ•°çš„å£°æ˜ä¹‹å¤–ï¼Œå…¶å®è¿˜å¯ä»¥ä½¿ç”¨äºé—­åŒ…(Closure)å›è°ƒä¸­ï¼Œæ®æ­¤å¯ä»¥ä½¿ç”¨ä»»ä½•ç±»å‹åœ¨closureä¸­ã€‚</p>
<h4 id="ç¤ºä¾‹">ç¤ºä¾‹</h4><p>æˆ‘ä»¬å¯ä»¥å…ˆå®šä¹‰ä¸€ä¸ªç®€å•çš„closure:</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typealias Closure&lt;T&gt; = <span class="function"><span class="params">(T)</span> -&gt;</span> Void</span><br><span class="line"><span class="regexp">//</span>è¿”å›å€¼ä¸ºç©º</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li>1 ä½¿ç”¨Boolç±»å‹</li>
</ul>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> boolClosure: Closure&lt;<span class="built_in">Bool</span>&gt; = &#123; boolValue <span class="keyword">in</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">boolClosure(<span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>2 ä½¿ç”¨Stringç±»å‹</li>
</ul>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> strClosure: Closure&lt;<span class="built_in">String</span>&gt; = &#123; strValue <span class="keyword">in</span></span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br><span class="line">strClosure(<span class="string">"I am string"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>3 å…¶ä»–ç±»å‹åŒç†</li>
</ul>
<h4 id="æ›´å¤šClosureç¤ºä¾‹">æ›´å¤šClosureç¤ºä¾‹</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typealias Closure&lt;T, U&gt; = <span class="function"><span class="params">(T)</span> -&gt;</span> (U)</span><br><span class="line"></span><br><span class="line">typealias Closure&lt;T&gt; = <span class="function"><span class="params">(T)</span> -&gt;</span> Void</span><br><span class="line"></span><br><span class="line">typealias Closure&lt;T&gt; = <span class="function"><span class="params">()</span> -&gt;</span> T</span><br><span class="line"></span><br><span class="line">typealias Closure = <span class="function"><span class="params">()</span> -&gt;</span> Void</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä¼˜é›…çš„Swift_â€“_é—­åŒ…ä¸­çš„èŒƒå‹">ä¼˜é›…çš„Swift â€“ é—­åŒ…ä¸­çš„èŒƒå‹</h2><p>ä»swift 3å¼€å§‹æœ‰äº†èŒƒå‹(Generic type), èŒƒå‹é™¤äº†å¸¸ç”¨åœ¨æ–¹æ³•é‡Œä½œå‚æ•°çš„å£°æ˜ä¹‹å¤–ï¼Œå…¶å®è¿˜å¯ä»¥ä½¿ç”¨äºé—­åŒ…(Closure)å›è°ƒä¸­ï¼Œæ®æ­¤å¯ä»¥ä½¿ç”¨ä»»ä½•ç±»å‹åœ¨closu]]>
    </summary>
    
      <category term="Generic type" scheme="https://litt1e-p.github.io/tags/Generic-type/"/>
    
      <category term="elegant swift" scheme="https://litt1e-p.github.io/tags/elegant-swift/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Use ES7 async&await in Wechat app]]></title>
    <link href="https://litt1e-p.github.io/2018/01/07/Use-ES7-async-await-in-Wechat-app/"/>
    <id>https://litt1e-p.github.io/2018/01/07/Use-ES7-async-await-in-Wechat-app/</id>
    <published>2018-01-07T11:06:45.000Z</published>
    <updated>2018-03-07T12:25:54.256Z</updated>
    <content type="html"><![CDATA[<h2 id="åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨_ES7_async&amp;await">åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨ ES7 async&amp;await</h2><p>å¾®ä¿¡å°ç¨‹åºè™½ç„¶å·²ç»æ”¯æŒPromissï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£äº†è‡­åæ˜­è‘—çš„callback hellï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            resolve(&#123;data: <span class="string">"Hello,World"</span>&#125;)</span><br><span class="line">        &#125;, <span class="number">5000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä»ä¸å¤Ÿè§£è€¦ä¸å¤Ÿä¼˜é›…ï¼Œè‹¥æ˜¯æ”¯æŒES7çš„asyncå’Œawaitå°±å¥½äº†ï¼Œå¯æƒœå¾®ä¿¡MINA IDEè¿˜ä¸æ”¯æŒè¿™ä¸ªç‰¹æ€§ï¼Œåªèƒ½è‡ªå·±åŠ¨æ‰‹å®ç°äº†ã€‚</p>
<h4 id="åŸç†">åŸç†</h4><p>é¦–å…ˆï¼Œasync/awaitä¹Ÿæ˜¯å’ŒPromiseé…åˆä½¿ç”¨çš„ã€‚å…·ä½“è¯­æ³•ä¸ä¸€ä¸€èµ˜è¿°ï¼Œè¯¦è§<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="external">ES7 Async Await</a></p>
<p>è¿™é‡Œä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wxLogin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        wx.login(&#123;</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (r.code) &#123;</span><br><span class="line">                    resolve(r)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    reject(<span class="string">'è·å–ç”¨æˆ·ç™»å½•çŠ¶æ€å¤±è´¥ï¼'</span> + r.errMsg)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            fail: <span class="function"><span class="keyword">function</span> <span class="title">fail</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                reject(<span class="string">'è·å–ç”¨æˆ·ç™»å½•çŠ¶æ€å¤±è´¥'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">tryLogin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> rs = <span class="keyword">await</span> wxLogin().catch(e =&gt; &#123;</span><br><span class="line">            <span class="built_in">console</span>.info(e)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">"logined!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tryLogin()</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸æ˜¯ä¼˜é›…å¤šäº†ã€‚è·Ÿcallback hell say byebye.</p>
<h4 id="é…ç½®">é…ç½®</h4><p>é‚£ä¹ˆåˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿå¾®ä¿¡MINAè‡ªå¸¦äº†Babelè½¬æ¢å·¥å…·ï¼Œä½†ä¸å¤Ÿå¼ºå¤§ï¼Œè¿™é‡Œæˆ‘ä»¬è‡ªå·±æ¥é…ç½®ä¸€ä¸ªBabelæ¥è½¬æ¢ç¼–è¯‘æˆ‘ä»¬çš„ä»£ç ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆæŠŠMINAé‡Œçš„<code>å¼€å¯ES6è½¬ES5</code>å…³é—­ï¼Œæˆ‘ä»¬ç”¨è‡ªå·±çš„Babelã€‚</p>
<p><img src="http://ww4.sinaimg.cn/large/006tKfTcgy1fp32ylaplyj311c0ak75l.jpg" alt=""></p>
<p>ç„¶åç”¨Gulpæ¥å†™æˆ‘çš„è„šæœ¬ï¼Œä»Gulpä¸­è°ƒç”¨Babelæ¥ç¼–è¯‘æˆ‘çš„ä»£ç ã€‚zåœ¨è°ƒç”¨Babelæ—¶ï¼Œéœ€è¦ç»™æˆ‘ä»¬çš„Babelé…ç½®æ’ä»¶ä»¥æ”¯æŒasync/awaitï¼Œæ¯”å¦‚async-to-generatorï¼Œasync-generator-functionsç­‰æ’ä»¶ã€‚</p>
<ol>
<li><p>Babelçš„é…ç½®</p>
<p> ç¼–è¾‘Babelçš„é…ç½®æ–‡ä»¶ï¼š.babelrcï¼Œè¿™é‡Œç›´æ¥ç”¨<code>latest</code>ï¼Œä¾¿æ”¯æŒES7ã€‚</p>
 <figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//.<span class="atom">babelrc</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"presets"</span>: [ <span class="string">"latest"</span> ],  </span><br><span class="line">  <span class="string">"plugins"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Glupçš„é…ç½®</p>
<p> æŠŠæˆ‘ä»¬å°ç¨‹åºé¡¹ç›®ä¸‹æ‰€æœ‰çš„jsæ–‡ä»¶éƒ½é€šè¿‡Babelç¼–è¯‘ï¼š</p>
 <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">gulp.<span class="keyword">task</span>(<span class="string">'scripts'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src([<span class="string">'./src/**/*.js'</span>])</span><br><span class="line">        .pipe(babel())</span><br><span class="line">        .pipe(gulpAddRequireRuntime())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./dist'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">function gulpAddRequireRuntime() &#123;</span><br><span class="line">    <span class="keyword">return</span> through.obj(function(<span class="keyword">file</span>, enc, cb) &#123;</span><br><span class="line">        var prefixText = ``;</span><br><span class="line">        var rel = path.relative(path.dirname(<span class="keyword">file</span>.path), path.<span class="keyword">join</span>(<span class="keyword">file</span>.base, <span class="string">'lib/runtime.js'</span>));</span><br><span class="line">        rel = rel.replace(<span class="regexp">/\\/g</span>, <span class="string">'/'</span>);</span><br><span class="line">        <span class="keyword">if</span> (rel === <span class="string">'runtime.js'</span>) &#123;</span><br><span class="line">            prefixText = <span class="keyword">new</span> Buffer(prefixText);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prefixText = `var regeneratorRuntime = require(<span class="string">"$&#123;rel&#125;"</span>);`;</span><br><span class="line">            prefixText = <span class="keyword">new</span> Buffer(prefixText);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">file</span>.isNull()) &#123;</span><br><span class="line">            cb(<span class="keyword">null</span>, <span class="keyword">file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">file</span>.isBuffer()) &#123;</span><br><span class="line">            <span class="keyword">file</span>.contents = Buffer.concat([prefixText, <span class="keyword">file</span>.contents]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">file</span>.isStream()) &#123;</span><br><span class="line">            <span class="keyword">file</span>.contents = <span class="keyword">file</span>.contents.pipe(prefixStream(prefixText));</span><br><span class="line">        &#125;</span><br><span class="line">        cb(<span class="keyword">null</span>, <span class="keyword">file</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="ä½¿ç”¨">ä½¿ç”¨</h4><ol>
<li>é¡¹ç›®ç›®å½•ç»“æ„</li>
</ol>
<p><img src="http://ww2.sinaimg.cn/large/006tKfTcgy1fp3384dryfj30mu0e675n.jpg" alt=""></p>
<p>å¦‚å›¾ï¼Œè¿™é‡Œdistç›®å½•æ­£æ˜¯Gulpç¼–è¯‘è¾“å‡ºç›®å½•ï¼Œåœ¨å¾®ä¿¡MINAä¸­ç›´æ¥ç”¨è¿™ä¸ªç›®å½•å³å¯ï¼Œè€Œsrcç›®å½•åˆ™ä¸ºæˆ‘ä»¬æ„‰å¿«ç¼–å†™ES7çš„async&amp;awaitçš„ç›®å½•å•¦ã€‚</p>
<ol>
<li>ä¾èµ–åº“</li>
</ol>
<p>ç»è¿‡Babelè½¬è¯‘åçš„ä»£ç æ˜¯é€šè¿‡ç±»ä¼¼coåº“çš„æ–¹å¼æ¥å®ç°çš„ï¼Œå³éœ€è¦ä½¿ç”¨åˆ°generatorï¼Œæ‰€ä»¥ï¼Œå’Œæˆ‘ä»¬ä½¿ç”¨coçš„æ—¶å€™ä¸€æ ·ï¼Œéœ€è¦ä¾èµ–ä¸€ä¸ªregeneratorRuntimeï¼Œæ‰èƒ½æ”¯æŒgeneratorç‰¹æ€§ã€‚æˆ‘ä»¬è¿™ä½¿ç”¨Facebookå¼€æºçš„<a href="https://github.com/facebook/regenerator/" target="_blank" rel="external">regenerator</a>ã€‚</p>
<p>å®‰è£…regenerator</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> regenerator</span></span><br></pre></td></tr></table></figure>
<ol>
<li>å¼•å…¥</li>
</ol>
<p>æŠŠåˆšæ‰npmå®‰è£…çš„regeneratorä¸‹çš„<code>rumtime.js</code>å¤åˆ¶åˆ°æˆ‘ä»¬çš„src/libä¸‹ï¼Œç„¶ååœ¨éœ€è¦ä½¿ç”¨çš„åœ°æ–¹å¼•å…¥å³å¯æ„‰å¿«åˆä¼˜é›…åœ°å†™æˆ‘ä»¬çš„async/awaitä»£ç å•¦ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const RUNTIME = <span class="function"><span class="title">require</span><span class="params">(<span class="string">"/lib/runtime"</span>)</span></span></span><br></pre></td></tr></table></figure>
<h5 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h5><blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="external">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function</a><br><a href="https://www.jianshu.com/p/270f129e5af3" target="_blank" rel="external">https://www.jianshu.com/p/270f129e5af3</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨_ES7_async&amp;await">åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨ ES7 async&amp;await</h2><p>å¾®ä¿¡å°ç¨‹åºè™½ç„¶å·²ç»æ”¯æŒPromissï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£äº†è‡­åæ˜­è‘—çš„callback hellï¼š</p>
<figure clas]]>
    </summary>
    
      <category term="javascript" scheme="https://litt1e-p.github.io/tags/javascript/"/>
    
      <category term="wechat app" scheme="https://litt1e-p.github.io/tags/wechat-app/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Build a notification center for wechat app]]></title>
    <link href="https://litt1e-p.github.io/2017/12/30/Build-a-notification-center-for-wechat-app/"/>
    <id>https://litt1e-p.github.io/2017/12/30/Build-a-notification-center-for-wechat-app/</id>
    <published>2017-12-30T02:30:15.000Z</published>
    <updated>2018-03-07T12:31:37.676Z</updated>
    <content type="html"><![CDATA[<h2 id="ä¸ºå¾®ä¿¡å°ç¨‹åºå»ºç«‹é€šçŸ¥ä¸­å¿ƒ">ä¸ºå¾®ä¿¡å°ç¨‹åºå»ºç«‹é€šçŸ¥ä¸­å¿ƒ</h2><p>å¾®ä¿¡å°ç¨‹åºç›®å‰ä¸ºæ­¢ï¼Œé¡µé¢ä¼ å€¼çš„æ–¹å¼ä¸»è¦æœ‰ï¼š</p>
<ul>
<li>globalData å…¨å±€å…±äº«å˜é‡</li>
<li>wx.navigateToç­‰é¡µé¢ä¹‹é—´è·³è½¬çš„urlä¼ å€¼ï¼Œåœ¨ç›®æ ‡é¡µ<code>onLoad</code>ä¸­è·å–</li>
<li>wx.setStorageç¼“å­˜å˜é‡</li>
<li>å…¶ä»–ï¼Ÿ(æ¬¢è¿è¡¥å……)</li>
</ul>
<p>åšè¿‡appï¼Œç‰¹åˆ«æ˜¯iOS appçš„åŒå­¦è‚¯å®šçŸ¥é“åŸç”Ÿappé™¤äº†ä¸Šè¿°çš„æ–¹å¼è¿˜æœ‰ä¼—å¤šçš„ä¼ å€¼ç”šè‡³åå‘ä¼ å€¼æ–¹å¼ï¼Œå¦‚blockï¼Œdelegateä¼ å€¼ï¼Œkvoç­‰ï¼Œå…¶ä¸­æœ€å°‘ä¸äº†çš„æ˜¯ä¸€å¯¹å¤šçš„<code>NotificationCenter/NSNotificationCenter</code>ï¼ŒåšWeChat appæ—¶æ€ä¹ˆå¯ä»¥æ²¡æœ‰é€šçŸ¥ä¸­å¿ƒå‘¢ï¼ŒGitHubä¸Šä¹Ÿæœ‰ä¸€ä½<br>å›½å†…çš„ç¨‹åºå‘˜å†™ä¸€ä¸ªç±»ä¼¼é€šçŸ¥ä¸­å¿ƒçš„jsåº“å«<a href="https://github.com/binnng/broadcast.js" target="_blank" rel="external">broadcast.js</a>ï¼ŒåŸç†ä¹Ÿæ˜¯å¤§è‡´ç›¸åŒï¼Œä»æ³¨å†Œé€šçŸ¥åˆ°é€šçŸ¥ä¸­å¿ƒå‘é€é€šçŸ¥ã€æ”¶åˆ°é€šçŸ¥ï¼Œæºç æ¯”è¾ƒç®€å•ï¼Œåªæœ‰30è¡Œå·¦å³ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> WIN, broadcast;</span><br><span class="line"></span><br><span class="line">WIN = <span class="built_in">window</span>;</span><br><span class="line"></span><br><span class="line">broadcast = &#123;</span><br><span class="line">  on: <span class="function"><span class="keyword">function</span>(<span class="params">name, fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> eventData;</span><br><span class="line">    eventData = broadcast.data;</span><br><span class="line">    <span class="keyword">if</span> (eventData.hasOwnProperty(name)) &#123;</span><br><span class="line">      eventData[name].push(fn);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      eventData[name] = [fn];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  fire: <span class="function"><span class="keyword">function</span>(<span class="params">name, data, thisArg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fn, fnList, i, len;</span><br><span class="line">    thisArg = thisArg || WIN;</span><br><span class="line">    fnList = broadcast.data[name];</span><br><span class="line">    <span class="keyword">if</span> (!fnList.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Cannot find broadcast event "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, len = fnList.length; i &lt; len; i++) &#123;</span><br><span class="line">      fn = fnList[i];</span><br><span class="line">      fn.apply(thisArg, [data, name]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  data: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">"undefined"</span> &amp;&amp; <span class="built_in">module</span>.exports) &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = broadcast;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  WIN.broadcast = broadcast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§ä½“ä¸Šæ€è·¯æ˜¯æ­£ç¡®çš„ï¼Œä½†å­˜åœ¨bugï¼Œåœ¨åˆ¤æ–­å¾…é€šçŸ¥çš„äº‹ä»¶æ•°ç»„fnListæ—¶ï¼Œæºç ç›´æ¥åˆ¤æ–­<code>if (!fnList.length)</code>å°±throw errorï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ä¼šcrashï¼Œå› ä¸ºå¯èƒ½æ‰¾ä¸åˆ°å¯¹åº”äº‹ä»¶çš„åå­—ï¼Œä¹Ÿå°±æ˜¯è¯´å‘é€é€šçŸ¥æ—¶å¦‚æœå‘é€ä¸€ä¸ªæœªæ³¨å†Œçš„é€šçŸ¥çš„è¯ï¼ŒfnListéƒ½è¿˜æ˜¯nullæˆ–è€…undefinedçš„ã€‚</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨è°ƒç”¨å‘é€é€šçŸ¥å‰ï¼Œå¿…é¡»å…ˆæ³¨å†Œè¯¥é€šçŸ¥</span></span><br><span class="line">broadcast.reg(config.kAppTestNotificationKey, <span class="function"><span class="keyword">function</span> <span class="params">(cb)</span> </span>&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>è¿™å…¶å®ç›¸å½“å°´å°¬ï¼Œæˆ‘å†³å®šæŠŠå®ƒä¿®æ”¹ä¸€ä¸‹ï¼Œé¡ºä¾¿æŠŠæ–¹æ³•åä¹Ÿä¸€èµ·ä¿®æ”¹ä¸€ä¸‹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> WIN, notificationCenter;</span><br><span class="line">WIN = <span class="built_in">window</span>;</span><br><span class="line"></span><br><span class="line">notificationCenter = &#123;</span><br><span class="line">    addObserver: <span class="function"><span class="keyword">function</span>(<span class="params">name, fn</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> eventData;</span><br><span class="line">        eventData = notificationCenter.data;</span><br><span class="line">        <span class="keyword">if</span> (eventData.hasOwnProperty(name)) &#123;</span><br><span class="line">            eventData[name].push(fn);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            eventData[name] = [fn];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    post: <span class="function"><span class="keyword">function</span>(<span class="params">name, data, thisArg</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> fn, fnList, i, len;</span><br><span class="line">        thisArg = thisArg || WIN;</span><br><span class="line">        fnList = notificationCenter.data[name];</span><br><span class="line">        <span class="keyword">if</span> (!fnList || !fnList.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Cannot find notificationCenter event "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>, len = fnList.length; i &lt; len; i++) &#123;</span><br><span class="line">            fn = fnList[i];</span><br><span class="line">            fn.apply(thisArg, [data, name]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    data: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">"undefined"</span> &amp;&amp; <span class="built_in">module</span>.exports) &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = notificationCenter;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    WIN.notificationCenter = notificationCenter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å‘é€ä¸€ä¸ªæœªæ³¨å†Œçš„é€šçŸ¥æ—¶ä¹Ÿä¸ä¼šthrow erroräº†ï¼Œå¯æ˜¯ï¼Œè¿™ä»£ç ä»ç„¶è¿˜æœ‰bugï¼šè¿™ä¸ªnotificationCenterè‡ªèº«çš„äº‹ä»¶å¯¹è±¡<code>data</code>ä¸­å‚¨å­˜ç€æ‰€æœ‰äº‹ä»¶ï¼Œå…¶å®æ•°æ®ç»“æ„ä¸ºï¼š</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"noti1"</span>: [<span class="literal">k1</span>, <span class="literal">k2</span>, ...],</span><br><span class="line">    <span class="string">"noti2"</span>: [<span class="literal">k1</span>, <span class="literal">k2</span>, ...],</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¹¶æ²¡æœ‰æä¾›removeObserverç§»é™¤äº‹ä»¶é€šçŸ¥çš„æ–¹æ³•ï¼Œå…¶é€ æˆå¯¹è±¡å†…éƒ¨æ•°ç»„çš„æ— é™å¢åŠ ï¼Œåœ¨æ¯ä¸€æ¬¡å‘é€é€šçŸ¥æ—¶éå†æ—¶é—´ä¼šæ— é™å¢åŠ ï¼Œæ—¶é—´å¤æ‚åº¦O(n)ä¼šéšç€é€šçŸ¥å¯¹è±¡åŠå…¶å†…éƒ¨äº‹ä»¶æ•°ç»„æ•°é‡å¢åŠ è€Œå¢åŠ ã€‚ä¸ºæ­¤åº”è¯¥å†ä¿®æ”¹ä¸€ä¸‹ï¼Œå¢åŠ ä¸€ä¸ªç§»é™¤äº‹ä»¶é€šçŸ¥çš„æ–¹æ³•ï¼š</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">removeObserver: <span class="function"><span class="keyword">function</span><span class="params">(name, fn)</span> &#123;</span></span><br><span class="line">    var eventData, fnList, <span class="built_in">i</span>, len;</span><br><span class="line">    eventData = notificationCenter.data;</span><br><span class="line">    fnList = notificationCenter.data<span class="matrix">[name]</span>;</span><br><span class="line">    <span class="keyword">if</span> (!fnList || !fnList.<span class="built_in">length</span>) <span class="cell">&#123;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">i</span> = <span class="number">0</span>, len = fnList.<span class="built_in">length</span>; <span class="built_in">i</span> &lt; len; <span class="built_in">i</span>++) <span class="cell">&#123;</span><br><span class="line">        if (fnList[i] == fn) &#123;</span><br><span class="line">            fnList.splice(i, <span class="number">1</span>)</span><br><span class="line">        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> this;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å¥½äº†ï¼Œæœ‰<code>addObserver</code>ã€<code>post</code>ã€<code>removeObserver</code>æ–¹æ³•äº†ï¼Œå¤§ä½“ä¸Šæ»¡è¶³äº†æˆ‘ä»¬çš„ä½¿ç”¨è¦æ±‚ï¼Œæ˜¯å¦å·²ç»å®Œç¾äº†å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸å¦¨æƒ³æƒ³çœ‹ï¼Œè¿™ä¸ªé€šçŸ¥ä¸­å¿ƒåº“ï¼Œåœ¨æ¯ä¸€ä¸ªéœ€è¦ä½¿ç”¨çš„pageé‡Œéƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡å¼•å…¥æ“ä½œï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">var</span> notificationCenter = <span class="function"><span class="title">require</span><span class="params">(<span class="string">"./lib/notificationCenter"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>æœ‰äº›äººå°±ä¼šç–‘è™‘äº†ï¼šè¿™æ¯requireä¸€æ¬¡ï¼Œæ˜¯ä¸æ˜¯éƒ½newäº†ä¸€æ¬¡è¿™ä¸ªnotificationCenterï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œæ„å‘³ç€è¿™ä¸ªnotificationCenterå¹¶ä¸æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œç„¶åä¸åŒåœ°æ–¹requireç”Ÿæˆä¸åŒçš„å¯¹è±¡ï¼Œç”šè‡³è¿˜æœ‰çº¿ç¨‹äº‰å¤ºçš„é—®é¢˜â€¦â€¦</p>
<p>äº‹å®çœŸçš„å¦‚æ­¤å—ï¼Ÿå…¶å®åœ¨node.jså®˜æ–¹æ–‡æ¡£ä¸­ï¼Œè¯´æ˜äº†requireæ˜¯å¼•å…¥ä¸€ä¸ªå•ä¾‹</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Every call <span class="built_in">to</span> <span class="built_in">require</span>(<span class="string">'foo'</span>) will <span class="built_in">get</span> exactly <span class="operator">the</span> same object returned, <span class="keyword">if</span> <span class="keyword">it</span> would <span class="built_in">resolve</span> <span class="built_in">to</span> <span class="operator">the</span> same <span class="built_in">file</span>.</span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¸ª<a href="https://medium.com/@lazlojuly/are-node-js-modules-singletons-764ae97519af" target="_blank" rel="external">medium</a>ä¾‹å­ï¼š</p>
<p>å®šä¹‰ä¸€ä¸ªç±»</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> counter.js</span><br><span class="line"></span><br><span class="line">let value = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attribute">increment</span>: <span class="function"><span class="params">()</span> =&gt;</span> value++,</span><br><span class="line">  <span class="attribute">get</span>: <span class="function"><span class="params">()</span> =&gt;</span> value,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†requireæµ‹è¯•ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-singleton.js</span></span><br><span class="line"></span><br><span class="line">const counter1 = <span class="function"><span class="title">require</span><span class="params">(â€˜./counter.jsâ€™)</span></span></span><br><span class="line">const counter2 = <span class="function"><span class="title">require</span><span class="params">(â€˜./counter.jsâ€™)</span></span></span><br><span class="line"></span><br><span class="line">counter1.<span class="function"><span class="title">increment</span><span class="params">()</span></span></span><br><span class="line">counter1.<span class="function"><span class="title">increment</span><span class="params">()</span></span></span><br><span class="line">counter2.<span class="function"><span class="title">increment</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">console.<span class="function"><span class="title">log</span><span class="params">(counter1.get()</span></span>) <span class="comment">// prints 3</span></span><br><span class="line">console.<span class="function"><span class="title">log</span><span class="params">(counter2.get()</span></span>) <span class="comment">// also prints 3</span></span><br></pre></td></tr></table></figure>
<p>è¯æ˜äº†requireæ˜¯å•æ¬¡å¼•å…¥ï¼Œæœ¬è´¨ä¸Šè·Ÿå•ä¾‹ä¸€è‡´ã€‚æ‰€ä»¥ä¸ç”¨æ‹…å¿ƒè¿™ä¸ªnotificationCenteréå…¨å±€å•ä¾‹çš„ç–‘è™‘ã€‚è‡³æ­¤ï¼Œè¿™ä¸ªé€šçŸ¥ä¸­å¿ƒä¹Ÿå·®ä¸å¤šå®Œæˆäº†ã€‚</p>
<h5 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h5><blockquote>
<p><a href="http://imweb.io/topic/582293894067ce9726778be9" target="_blank" rel="external">http://imweb.io/topic/582293894067ce9726778be9</a><br><a href="https://github.com/binnng/broadcast.js/blob/master/broadcast.js" target="_blank" rel="external">https://github.com/binnng/broadcast.js/blob/master/broadcast.js</a><br><a href="https://medium.com/@lazlojuly/are-node-js-modules-singletons-764ae97519af" target="_blank" rel="external">https://medium.com/@lazlojuly/are-node-js-modules-singletons-764ae97519af</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä¸ºå¾®ä¿¡å°ç¨‹åºå»ºç«‹é€šçŸ¥ä¸­å¿ƒ">ä¸ºå¾®ä¿¡å°ç¨‹åºå»ºç«‹é€šçŸ¥ä¸­å¿ƒ</h2><p>å¾®ä¿¡å°ç¨‹åºç›®å‰ä¸ºæ­¢ï¼Œé¡µé¢ä¼ å€¼çš„æ–¹å¼ä¸»è¦æœ‰ï¼š</p>
<ul>
<li>globalData å…¨å±€å…±äº«å˜é‡</li>
<li>wx.navigateToç­‰é¡µé¢ä¹‹é—´è·³è½¬çš„urlä¼ å€¼ï¼Œåœ¨ç›®æ ‡é¡µ<code]]>
    </summary>
    
      <category term="javascript" scheme="https://litt1e-p.github.io/tags/javascript/"/>
    
      <category term="notification" scheme="https://litt1e-p.github.io/tags/notification/"/>
    
      <category term="wechat app" scheme="https://litt1e-p.github.io/tags/wechat-app/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Use git hooks to deploy automatically]]></title>
    <link href="https://litt1e-p.github.io/2017/09/07/Use%20git%20hooks%20to%20deploy%20automatically/"/>
    <id>https://litt1e-p.github.io/2017/09/07/Use git hooks to deploy automatically/</id>
    <published>2017-09-07T14:55:47.000Z</published>
    <updated>2018-03-07T12:51:47.410Z</updated>
    <content type="html"><![CDATA[<h4 id="git_hooks_å®ç°è‡ªåŠ¨éƒ¨ç½²">git hooks å®ç°è‡ªåŠ¨éƒ¨ç½²</h4><p>å½“æˆ‘ä»¬åœ¨æœ¬åœ°æ‰§è¡Œpushå‘½ä»¤åˆ°gitæœåŠ¡å™¨çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨è§¦å‘post-receiveé’©å­ã€‚</p>
<p>å‡å¦‚æœ‰ä¸€ä¸ªgitæœåŠ¡å™¨ä»“åº“ç›®å½• ä¾‹å¦‚: /home/git/test.git<br>å’Œä¸€ä¸ªwebæœåŠ¡å™¨ç›®å½•ï¼Œä¾‹å¦‚: /home/wwwroot/default/testRoot</p>
<p>å…ˆåœ¨webç›®å½•é‡Œcloneä¸€ä»½ä»“åº“<br>cd /home/wwwroot/default/testRoot<br>git clone /home/git/test.git</p>
<p>ç„¶åä½¿ç”¨æœåŠ¡ç«¯gité’©å­ post-receiveï¼Œå®ƒä½äº/home/git/test.git/hooks<br>cd /home/git/test.git/hooks/<br>è¿™é‡Œæœ‰post-receive.sample<br>cp post-receive.sample post-receive<br>vi post-receive<br>å†™å…¥å¦‚ä¸‹ä»£ç :</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">unset GIT_DIR </span><br><span class="line">echo <span class="string">'copying to web deploy directory...'</span></span><br><span class="line">CurrentPath=`pwd`</span><br><span class="line">echo <span class="variable">$CurrentPath</span></span><br><span class="line">DeployPath=<span class="string">"/home/wwwroot/default/testRoot"</span></span><br><span class="line">cd <span class="variable">$DeployPath</span> || exit</span><br><span class="line">git pull origin master</span><br><span class="line">echo <span class="string">"update will be completed soon"</span></span><br><span class="line">cd <span class="variable">$CurrentPath</span></span><br><span class="line">exit <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><code>å¦‚æœä¸åŠ  unset GIT_DIR #è¿˜åŸç¯å¢ƒå˜é‡ å°±ä¼šæŠ¥å‡º remote: fatal: not git respository:â€™.â€™ é”™è¯¯</code><br>ä¿å­˜åèµ‹äºˆå¯æ‰§è¡Œæƒé™<br>chmod +x /home/git/test.git/hooks/post-receive</p>
<p>ä¿®æ”¹webæœåŠ¡å™¨æ ¹ç›®å½•çš„æƒé™<br>å› ä¸ºæ‰§è¡Œæ‹‰å–çš„æ—¶å€™æ˜¯gitç”¨æˆ·æ‰€ä»¥è¦æŠŠwebæœåŠ¡å™¨æ ¹ç›®å½•(/home/wwwroot/default/testRoot) çš„æƒé™è®¾å®šä¸ºgitç”¨æˆ·</p>
<p>chown -R git:git /home/wwwroot/default/testRoot</p>
<p>å‚è€ƒç½‘å€ï¼š<br><a href="http://www.jianshu.com/p/f9312b51e011" target="_blank" rel="external">git hooks å®ç°è‡ªåŠ¨éƒ¨ç½²</a><br><a href="http://robin-front.github.io/2016/08/11/%E7%94%A8Git-Hooks%E8%BF%9B%E8%A1%8C%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2-%E8%AE%A9%E6%8F%90%E4%BA%A4%E5%8F%91%E5%B8%83%E8%87%AA%E5%8A%A8%E5%8C%96/" target="_blank" rel="external">ç”¨Git-Hooksè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²,è®©æäº¤å‘å¸ƒè‡ªåŠ¨åŒ–</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h4 id="git_hooks_å®ç°è‡ªåŠ¨éƒ¨ç½²">git hooks å®ç°è‡ªåŠ¨éƒ¨ç½²</h4><p>å½“æˆ‘ä»¬åœ¨æœ¬åœ°æ‰§è¡Œpushå‘½ä»¤åˆ°gitæœåŠ¡å™¨çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨è§¦å‘post-receiveé’©å­ã€‚</p>
<p>å‡å¦‚æœ‰ä¸€ä¸ªgitæœåŠ¡å™¨ä»“åº“ç›®å½• ä¾‹å¦‚: /home/git/test]]>
    </summary>
    
      <category term="git" scheme="https://litt1e-p.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Build a git repo server]]></title>
    <link href="https://litt1e-p.github.io/2017/08/25/Build-a-git-repo-server/"/>
    <id>https://litt1e-p.github.io/2017/08/25/Build-a-git-repo-server/</id>
    <published>2017-08-25T13:12:54.000Z</published>
    <updated>2018-03-07T12:14:18.729Z</updated>
    <content type="html"><![CDATA[<h4 id="æ­¥éª¤">æ­¥éª¤</h4><p>yum install git</p>
<p>groupadd git<br>adduser git -g git<br>passwd git //è®¾ç½®å¯†ç </p>
<p>// gitç”¨æˆ·çš„ï½ç›®å½•: /home/git</p>
<p>mkdir /home/git/.ssh &amp;&amp; touch /home/git/.ssh/authorized_keys<br>chmod 700 /home/git/.ssh<br>chmod 600 /home/git/.ssh/authorized_keys</p>
<p>//æŠŠæœ¬åœ°ç”µè„‘çš„.ssh/id_rsa.pubé‡Œçš„å†…å®¹å¤åˆ¶å¹¶ç²˜è´´åˆ°è¿œç¨‹çš„/home/git/.ssh/authorized_keys, è‹¥æœ‰å¤šä¸ªåˆ™ä¸€è¡Œä¸€ä¸ª</p>
<p>//åˆå§‹åŒ–ä¸€ä¸ªå«åštestçš„ä»“åº“<br>cd /home/git &amp; git init â€“bare test.git</p>
<p>chown -R git:git test.git</p>
<p>//ç¦ç”¨shellç™»å½•<br>//1.å…ˆæ‰¾åˆ°git-shellçš„è·¯å¾„<br>grep git-shell /etc/shells || su -c â€œecho <code>which git-shell</code> &gt;&gt; /etc/shellsâ€<br>eg.æ§åˆ¶å°è¾“å‡ºï¼š/usr/bin/git-shell<br>//2.ä¿®æ”¹gitç”¨æˆ·çš„shellç™»å½•<br>vi /etc/passwd<br>//æ‰¾åˆ°ç±»ä¼¼ä¸‹é¢çš„ä¸€è¡Œï¼š<br>git:x:1001:1001:,,,:/home/git:/bin/bash<br>//æ”¹æˆ<br>git:x:1001:1001:,,,:/home/git:/usr/bin/git-shell<br>//è¿™æ ·ï¼Œgitç”¨æˆ·å¯ä»¥æ­£å¸¸é€šè¿‡sshä½¿ç”¨gitï¼Œä½†æ— æ³•ç™»å½•shellï¼Œå› ä¸ºæˆ‘ä»¬ä¸ºgitç”¨æˆ·æŒ‡å®šçš„git-shellæ¯æ¬¡ä¸€ç™»å½•å°±è‡ªåŠ¨é€€å‡º<br>//æµ‹è¯•ï¼š<br>ssh git@your-server-name-or-ip<br>//è¾“å…¥å¯†ç åæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯å³æˆåŠŸ<br>fatal: What do you think I am? A shell?<br>Connection to <code>your-server-name-or-ip</code> closed.<br>//ç»™gitç”¨æˆ·å¢åŠ pushæƒé™<br>usermod -s /bin/bash git</p>
<p>//åœ¨æœ¬åœ°ç”µè„‘ä¸­cloneä»“åº“<br>git clone git@your-server-name-or-ip:test.git</p>
<p>//ps. è¿™é‡Œè‹¥æœåŠ¡å™¨æ”¹äº†é»˜è®¤çš„ssh 22ç«¯å£, å¯ä»¥åœ¨æœ¬åœ°ç”µè„‘ä¸­(~/.ssh/)æ–°å»ºconfigæ–‡ä»¶<br>vi ~/.ssh/config<br>//configå†…å®¹ï¼š<br>host your-server-name-or-ip<br>hostname  your-server-name-or-ip<br>port your-server-port</p>
<p>å‡è®¾windowsä¸Šå·²ç»æœ‰ä¸ªæœ¬åœ°ä»“åº“ï¼Œå¹¶ä¸”ä¸åˆ«åå«originçš„è¿œç¨‹ä»“åº“è¿›è¡Œäº†å…³è”ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦å°†originæ‰€æŒ‡å‘çš„è¿œç¨‹ä»“åº“çš„é“¾æ¥æ”¹ä¸ºæˆ‘ä»¬åˆšæ­å»ºçš„gitæœåŠ¡å™¨ï¼š<br>git remote set-url origin git@your-server-name-or-ip:my-project.git<br>å¦‚æœæ˜¯æœ¬åœ°è¿˜æ²¡æœ‰ä»“åº“ï¼Œå¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¹¶å°†å…¶ä¸è¿œç¨‹ä»“åº“è¿›è¡Œå…³è”ï¼š<br>git init &amp;&amp; git remote add origin git@your-server-name-or-ip:my-project.git</p>
<p>å‚è€ƒç½‘å€ï¼š<br><a href="https://git-scm.com/book/zh/v1/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-%E6%9E%B6%E8%AE%BE%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="external">æœåŠ¡å™¨ä¸Šçš„ Git - æ¶è®¾æœåŠ¡å™¨</a><br><a href="http://www.dabu.info/vps-set-private-git-server.html" target="_blank" rel="external">ç”¨vpsæ­å»ºç§æœ‰çš„gitæœåŠ¡å™¨</a><br><a href="http://www.pubyun.com/blog/deveops/%E6%9C%AC%E5%9C%B0ssh%E9%9D%9E%E6%A0%87%E5%87%86%E7%AB%AF%E5%8F%A3%E6%97%B6%EF%BC%8C%E8%BF%9E%E6%8E%A5github-com/" target="_blank" rel="external">æœ¬åœ°sshéæ ‡å‡†ç«¯å£æ—¶ï¼Œè¿æ¥github.com</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h4 id="æ­¥éª¤">æ­¥éª¤</h4><p>yum install git</p>
<p>groupadd git<br>adduser git -g git<br>passwd git //è®¾ç½®å¯†ç </p>
<p>// gitç”¨æˆ·çš„ï½ç›®å½•: /home/git</p>
<p>m]]>
    </summary>
    
      <category term="git" scheme="https://litt1e-p.github.io/tags/git/"/>
    
      <category term="git server" scheme="https://litt1e-p.github.io/tags/git-server/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Lock in iOS]]></title>
    <link href="https://litt1e-p.github.io/2017/06/17/Lock-in-iOS/"/>
    <id>https://litt1e-p.github.io/2017/06/17/Lock-in-iOS/</id>
    <published>2017-06-17T02:05:08.000Z</published>
    <updated>2018-03-07T12:06:21.094Z</updated>
    <content type="html"><![CDATA[<h2 id="iOSé”">iOSé”</h2><h4 id="æ­»é”">æ­»é”</h4><p>ä¸€ä¸ªç¤ºä¾‹<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)run &#123;</span><br><span class="line">    <span class="function">NSLog</span>(<span class="at_rule">@<span class="string">"1"</span>);</span></span><br><span class="line">    <span class="comment">//ä¸»é˜Ÿåˆ—çš„åŒæ­¥çº¿ç¨‹ï¼ŒæŒ‰ç…§FIFOçš„åŸåˆ™ï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰ï¼Œ2æ’åœ¨3åé¢ä¼šç­‰3æ‰§è¡Œå®Œï¼Œä½†å› ä¸ºåŒæ­¥çº¿ç¨‹ï¼Œ3åˆè¦ç­‰2æ‰§è¡Œå®Œï¼Œç›¸äº’ç­‰å¾…æˆä¸ºæ­»é”ã€‚</span></span><br><span class="line">    <span class="function">dispatch_sync</span>(<span class="function">dispatch_get_main_queue</span>(), ^&#123;</span><br><span class="line">        <span class="function">NSLog</span>(<span class="at_rule">@<span class="string">"2"</span>);</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="function">NSLog</span>(<span class="at_rule">@<span class="string">"3"</span>);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡º1ä¹‹åå‘ç”Ÿæ­»é”ï¼Œsyncåˆ°å½“å‰ä¸»çº¿ç¨‹(ä¸²è¡Œé˜Ÿåˆ—)çš„blockå°†ä¼šå¼•èµ·æ­»é”ã€‚åŸå› æ˜¯dispatch_syncå°†ä¸€ä¸ªblockæ’å…¥åˆ°main queueä¸­ï¼Œsyncä¼šç­‰å¾…åˆ°è¿™ä¸ªblockæ‰§è¡Œå®Œæˆåæ‰è¿”å›ç»§ç»­æ‰§è¡Œ(asyncåˆ™ä¸ä¼šç­‰å¾…)ï¼Œè€Œè¿™ä¸ªblockçš„æ‰§è¡Œè¿˜ç­‰å¾…ç€runä¸­dispatch_syncè°ƒç”¨çš„ç»“æŸï¼Œæ‰€ä»¥é€ æˆäº†å¾ªç¯ç­‰å¾…ï¼Œå¯¼è‡´æ­»é”ã€‚</p>
<h4 id="äº’æ–¥é”POSIX">äº’æ–¥é”POSIX</h4><p>POSIXå’Œ<code>dispatch_semaphore_t</code>å¾ˆåƒï¼Œä½†æ˜¯å®Œå…¨ä¸åŒã€‚POSIXæ˜¯Unix/Linuxå¹³å°ä¸Šæä¾›çš„ä¸€å¥—æ¡ä»¶äº’æ–¥é”çš„APIã€‚<br>ä¸ºäº†é”ä½å’Œè§£é”ä¸€ä¸ªäº’æ–¥é”ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>pthread_mutex_lock</code>å’Œ<code>pthread_mutex_unlock</code>å‡½æ•°ã€‚å½“ä½ ç”¨å®Œä¸€ä¸ªé”ä¹‹åï¼Œåªè¦ç®€å•çš„è°ƒç”¨<code>pthread_mutex_destroy</code>æ¥é‡Šæ”¾è¯¥é”çš„æ•°æ®ç»“æ„ã€‚<br>äº’æ–¥é”æä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼Œä»å‡½æ•°åå°±å¯ä»¥çŸ¥é“ä»–ä»¬çš„ä½œç”¨ï¼š<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(pthread_mutex_t *mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_trylock</span><span class="params">(pthread_mutex_t *mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(pthread_mutex_t *mutex)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>å‡½æ•°<code>pthread_mutex_trylock</code>å’Œ<code>pthread_mutex_lock</code>çš„åŠŸèƒ½ç›¸ä¼¼ï¼Œåªä¸è¿‡å‰è€…åœ¨è·å–é”å¤±è´¥çš„æƒ…å†µä¸‹ä¼šç«‹å³è¿”å›ï¼Œè€Œåè€…åˆ™ä¼šä¸€ç›´é˜»å¡åœ¨é‚£é‡Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢<br>ã€‚</p>
<p>ä¸¾ä¾‹<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">POSIXViewController</span> () </span>&#123;</span><br><span class="line">    pthread_mutex_t mutex;  <span class="comment">//å£°æ˜pthread_mutex_tçš„ç»“æ„</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">POSIXViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    pthread_mutex_destroy(&amp;mutex);  <span class="comment">//é‡Šæ”¾è¯¥é”çš„æ•°æ®ç»“æ„</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  åˆå§‹åŒ–</span><br><span class="line">     *</span><br><span class="line">     */</span></span><br><span class="line">    pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)getImageName:(<span class="built_in">NSMutableArray</span> *)imageNames &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *imageName;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  åŠ é”</span><br><span class="line">     */</span></span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    <span class="keyword">if</span> (imageNames<span class="variable">.count</span>&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        imageName = [imageNames firstObject];</span><br><span class="line">        [imageNames removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  è§£é”</span><br><span class="line">     */</span></span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>POSIXè¿˜å¯ä»¥åˆ›å»ºæ¡ä»¶é”ï¼Œæä¾›äº†å’ŒNSConditionä¸€æ ·çš„æ¡ä»¶æ§åˆ¶ï¼Œåˆå§‹åŒ–äº’æ–¥é”åŒæ—¶ä½¿ç”¨pthread_cond_initæ¥åˆå§‹åŒ–æ¡ä»¶æ•°æ®ç»“æ„ï¼Œ<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_init</span> <span class="params">(pthread_cond_t *cond, pthread_condattr_t *attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…ï¼ˆä¼šé˜»å¡ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_wait</span> <span class="params">(pthread_cond_t *cond, pthread_mutex_t *mut)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šæ—¶ç­‰å¾…</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_timedwait</span> <span class="params">(pthread_cond_t *cond, pthread_mutex_t *mut, <span class="keyword">const</span> <span class="keyword">struct</span> timespec *abstime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å”¤é†’</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_signal</span> <span class="params">(pthread_cond_t *cond)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¿æ’­å”¤é†’</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_broadcast</span> <span class="params">(pthread_cond_t *cond)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”€æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_destroy</span> <span class="params">(pthread_cond_t *cond)</span></span>;</span><br></pre></td></tr></table></figure></p>
<h4 id="äº’æ–¥é”NSLock">äº’æ–¥é”NSLock</h4><p>NSLockä¸­å®ç°äº†ä¸€ä¸ªç®€å•çš„äº’æ–¥é”ã€‚æ‰€æœ‰é”ï¼ˆåŒ…æ‹¬NSLockï¼‰çš„æ¥å£å®é™…ä¸Šéƒ½æ˜¯é€šè¿‡NSLockingåè®®å®šä¹‰çš„ï¼Œå®ƒå®šä¹‰äº†lockå’Œunlockæ–¹æ³•ã€‚ä½ ä½¿ç”¨è¿™äº›æ–¹æ³•æ¥è·å–å’Œé‡Šæ”¾è¯¥é”ã€‚NSLockç±»ä½¿ç”¨çš„æ˜¯POSIXçº¿ç¨‹æ¥å®ç°å®ƒçš„é”æ“ä½œã€‚</p>
<p>NSLockä¸èƒ½è¢«ç”¨æ¥å®ç°è¿­ä»£é”ï¼Œå› ä¸ºå¦‚æœå‘ç”Ÿlockæ¶ˆæ¯ä¸¤æ¬¡çš„è¯ï¼Œæ•´ä¸ªçº¿ç¨‹å°†è¢«æ°¸ä¹…é”ä½ã€‚</p>
<p>é™¤äº†æ ‡å‡†çš„é”è¡Œä¸ºï¼ŒNSLockç±»è¿˜å¢åŠ äº†tryLockå’ŒlockBeforeDate:æ–¹æ³•ã€‚æ–¹æ³•tryLockè¯•å›¾è·å–ä¸€ä¸ªé”ï¼Œä½†æ˜¯å¦‚æœé”ä¸å¯ç”¨çš„æ—¶å€™ï¼Œå®ƒä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚ç›¸åï¼Œå®ƒåªæ˜¯è¿”å›NOã€‚è€ŒlockBeforeDate:æ–¹æ³•è¯•å›¾è·å–ä¸€ä¸ªé”ï¼Œä½†æ˜¯å¦‚æœé”æ²¡æœ‰åœ¨è§„å®šçš„æ—¶é—´å†…è¢«è·å¾—ï¼Œå®ƒä¼šè®©çº¿ç¨‹ä»é˜»å¡çŠ¶æ€å˜ä¸ºéé˜»å¡çŠ¶æ€ï¼ˆæˆ–è€…è¿”å›NOï¼‰ã€‚</p>
<p>NSLockçš„æ‰§è¡ŒåŸç†ï¼š<br>æŸä¸ªçº¿ç¨‹Aè°ƒç”¨lockæ–¹æ³•ã€‚è¿™æ ·ï¼ŒNSLockå°†è¢«ä¸Šé”ã€‚å¯ä»¥æ‰§è¡Œâ€œå…³é”®éƒ¨åˆ†â€ï¼Œå®Œæˆåï¼Œè°ƒç”¨unlockæ–¹æ³•ã€‚å¦‚æœï¼Œåœ¨çº¿ç¨‹A è°ƒç”¨unlockæ–¹æ³•ä¹‹å‰ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹Bè°ƒç”¨äº†åŒä¸€é”å¯¹è±¡çš„lockæ–¹æ³•ã€‚é‚£ä¹ˆï¼Œçº¿ç¨‹Båªæœ‰ç­‰å¾…ã€‚ç›´åˆ°çº¿ç¨‹Aè°ƒç”¨äº†unlockã€‚</p>
<p>ä½¿ç”¨æ—¶ï¼ŒåŸºæœ¬æ–¹æ³•å°±æ˜¯ï¼š<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NSLock *<span class="keyword">lock</span> = [[NSLock alloc] init];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">lock</span> <span class="keyword">lock</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//do something</span></span><br><span class="line"></span><br><span class="line">[<span class="keyword">lock</span> unlock];</span><br></pre></td></tr></table></figure></p>
<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä¸ºNSLockè®¾ç½®nameï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)newName</span><br><span class="line">- (<span class="built_in">NSString</span> *)name <span class="comment">//è¿”å›é”æŒ‡å®šçš„Name</span></span><br></pre></td></tr></table></figure></p>
<h4 id="æŒ‡ä»¤@synchronized">æŒ‡ä»¤@synchronized</h4><p>@synchronizedæ˜¯åœ¨Objective-Cä¸­æœ€ç®€å•æ–¹æ³•ï¼Œåªè¦æœ‰ä¸ªObjective-Cå¯¹è±¡å°±å¯ä»¥å®Œæˆçº¿ç¨‹åŒæ­¥æ“ä½œã€‚@synchronizedæŒ‡ä»¤åšå’Œå…¶ä»–äº’æ–¥é”ä¸€æ ·çš„å·¥ä½œï¼ˆå®ƒé˜²æ­¢ä¸åŒçš„çº¿ç¨‹åœ¨åŒä¸€æ—¶é—´è·å–åŒä¸€ä¸ªé”ï¼‰ã€‚ä½ ä¸éœ€è¦ç›´æ¥åˆ›å»ºä¸€ä¸ªäº’æ–¥é”æˆ–é”å¯¹è±¡ã€‚ç›¸åï¼Œä½ åªéœ€è¦ç®€å•çš„ä½¿ç”¨Objective-Cå¯¹è±¡ä½œä¸ºé”çš„ä»¤ç‰Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ@synchronizedä¼šéšå¼åœ°æ·»åŠ å¼‚å¸¸å¤„ç†ä»£ç ï¼Œä¹Ÿå°±æ˜¯å½“å‘ç”Ÿå¼‚å¸¸æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾äº’æ–¥é”ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æŸè€—ã€‚</p>
<p>ç¤ºä¾‹ï¼š<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (void)<span class="function"><span class="keyword">method</span>:</span>(id)anObj <span class="comment">&#123;</span><br><span class="line">    @synchronized(anObj) &#123;</span><br><span class="line">        // Everything between the braces is protected by the @synchronized directive.</span><br><span class="line">    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//swift å†™æ³•</span></span><br><span class="line">objc_sync_enter(<span class="keyword">self</span>)</span><br><span class="line"><span class="comment">//éœ€è¦æ‰§è¡Œçš„ä»£ç å—</span></span><br><span class="line">objc_sync_exit(<span class="keyword">self</span>)</span><br></pre></td></tr></table></figure></p>
<p>ä¼ ç»™@synchronizedæŒ‡ä»¤çš„å¯¹è±¡æ˜¯ç”¨æ¥åŒºåˆ«ä¿æŠ¤å—çš„å”¯ä¸€æ ‡ç¤ºï¼Œå¦‚æœä½ åœ¨ä¸¤ä¸ªä¸åŒçš„çº¿ç¨‹é‡Œé¢æ‰§è¡Œä¸Šè¿°æ–¹æ³•ï¼Œæ¯æ¬¡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¼ é€’äº†ä¸€ä¸ªä¸åŒçš„å¯¹è±¡ç»™anObjå‚æ•°ï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½å°†ä¼šæ‹¥æœ‰å®ƒçš„é”ï¼Œå¹¶æŒç»­å¤„ç†ï¼Œä¸­é—´ä¸è¢«å…¶ä»–çº¿ç¨‹é˜»å¡ã€‚ç„¶è€Œï¼Œå¦‚æœä½ ä¼ é€’çš„æ˜¯<code>åŒä¸€ä¸ªå¯¹è±¡</code>ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ä¼šé¦–å…ˆè·å¾—è¯¥é”ï¼Œè€Œå…¶ä»–çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ç›´åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹å®Œæˆã€‚</p>
<p>ä½œä¸ºä¸€ç§é¢„é˜²æªæ–½ï¼Œ@synchronizedå—éšå¼çš„æ·»åŠ ä¸€ä¸ªå¼‚å¸¸å¤„ç†ä¾‹ç¨‹æ¥ä¿æŠ¤ä»£ç ã€‚è¯¥å¤„ç†ä¾‹ç¨‹ä¼šåœ¨å¼‚å¸¸æŠ›å‡ºçš„æ—¶å€™è‡ªåŠ¨çš„é‡Šæ”¾äº’æ–¥é”ã€‚è¿™æ„å‘³ç€ä¸ºäº†ä½¿ç”¨@synchronizedæŒ‡ä»¤ï¼Œä½ å¿…é¡»åœ¨ä½ çš„ä»£ç ä¸­å¯ç”¨å¼‚å¸¸å¤„ç†ã€‚å¦‚æœä½ ä¸æƒ³è®©éšå¼çš„å¼‚å¸¸å¤„ç†ä¾‹ç¨‹å¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œä½ åº”è¯¥è€ƒè™‘ä½¿ç”¨é”çš„ç±»ã€‚</p>
<h4 id="GCDä¿¡å·é‡é”_dispatch_semaphore_tå’Œdispatch_semaphore_wait">GCDä¿¡å·é‡é” dispatch_semaphore_tå’Œdispatch_semaphore_wait</h4><p>dispatch_semaphore ä¿¡å·é‡åŸºäºè®¡æ•°å™¨çš„ä¸€ç§å¤šçº¿ç¨‹åŒæ­¥æœºåˆ¶ã€‚dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER); å¦‚æœsemaphoreè®¡æ•°å¤§äºç­‰äº1.è®¡æ•°ï¼1ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚å¦‚æœè®¡æ•°ä¸º0ï¼Œåˆ™ç­‰å¾…ã€‚è¿™é‡Œè®¾ç½®çš„ç­‰å¾…æ—¶é—´æ˜¯ä¸€ç›´ç­‰å¾…ã€‚dispatch_semaphore_signal(semaphore);è®¡æ•°ï¼‹1.åœ¨è¿™ä¸¤å¥ä»£ç ä¸­é—´çš„æ‰§è¡Œä»£ç ï¼Œæ¯æ¬¡åªä¼šå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œè¿™æ ·å°±æœ‰æ•ˆçš„ä¿è¯äº†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>); <span class="comment">//è·å–å…¨å±€å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">dispatch_semaphore_t</span> semaphore = dispatch_semaphore_create(<span class="number">1</span>); <span class="comment">//åˆ›å»ºä¿¡å·é‡</span></span><br><span class="line">NSMutableArray *<span class="built_in">array</span> = [NSMutableArrayarray];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="number">100000</span>; index++) &#123;</span><br><span class="line">    dispatch_async(<span class="built_in">queue</span>, ^()&#123; <span class="comment">//å¹¶å‘é˜Ÿåˆ—é‡Œæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER); <span class="comment">// semaphoreè®¡æ•°å¤§äºç­‰äº1.è®¡æ•°ï¼1ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚å¦‚æœè®¡æ•°ä¸º0ï¼Œåˆ™ç­‰å¾…</span></span><br><span class="line">        NSLog(@<span class="string">"addd :%d"</span>, index);</span><br><span class="line">        [<span class="built_in">array</span> addObject:[NSNumber numberWithInt:index]];</span><br><span class="line">        dispatch_semaphore_signal(semaphore); <span class="comment">//è®¡æ•°ï¼‹1</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="é€’å½’é”_NSRecursiveLock">é€’å½’é” NSRecursiveLock</h4><p>NSRecursiveLockè¿™ä¸ªé”å¯ä»¥è¢«åŒä¸€çº¿ç¨‹å¤šæ¬¡è¯·æ±‚ï¼Œè€Œä¸ä¼šå¼•èµ·æ­»é”ã€‚NSRecursiveLocké€šå¸¸è¢«ç”¨åœ¨ä¸€ä¸ªé€’å½’å‡½æ•°é‡Œé¢æ¥é˜²æ­¢é€’å½’é€ æˆé˜»å¡çº¿ç¨‹ï¼Œåªæœ‰å½“å¤šæ¬¡è·å–çš„é”å…¨éƒ¨é‡Šæ”¾æ—¶ï¼ŒNSRecursiveLockæ‰èƒ½è¢«å…¶ä»–çº¿ç¨‹è·å–ã€‚</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">NSLock *<span class="keyword">lock</span> = [[NSLock alloc] init];</span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">void</span> (<span class="params">^RecursiveMethod</span>)(<span class="params"><span class="keyword">int</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">    RecursiveMethod = ^(<span class="keyword">int</span> <span class="keyword">value</span>) &#123;</span><br><span class="line">        [<span class="keyword">lock</span> <span class="keyword">lock</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">value</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            NSLog(<span class="string">@"value = %d"</span>, <span class="keyword">value</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            RecursiveMethod(<span class="keyword">value</span> - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">lock</span> unlock];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    RecursiveMethod(<span class="number">5</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªå…¸å‹çš„æ­»é”æƒ…å†µã€‚åœ¨æˆ‘ä»¬çš„çº¿ç¨‹ä¸­ï¼ŒRecursiveMethodæ˜¯é€’å½’è°ƒç”¨çš„ã€‚æ‰€ä»¥æ¯æ¬¡è¿›å…¥è¿™ä¸ªblockæ—¶ï¼Œéƒ½ä¼šå»åŠ ä¸€æ¬¡é”ï¼Œè€Œä»ç¬¬äºŒæ¬¡å¼€å§‹ï¼Œç”±äºé”å·²ç»è¢«ä½¿ç”¨äº†ä¸”æ²¡æœ‰è§£é”ï¼Œæ‰€ä»¥å®ƒéœ€è¦ç­‰å¾…é”è¢«è§£é™¤ï¼Œè¿™æ ·å°±å¯¼è‡´äº†æ­»é”ï¼Œçº¿ç¨‹è¢«é˜»å¡ä½äº†ã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨NSRecursiveLockï¼Œåªéœ€è¦æŠŠ<code>NSLock *lock = [[NSLock alloc] init];</code>æ”¹æˆ<code>NSRecursiveLock *lock = [[NSRecursiveLock alloc] init];</code>å³å¯ã€‚</p>
<p>ä¸NSLockä¸€æ ·ï¼Œæ‹¥æœ‰<code>tryLock</code>å’Œ<code>lockBeforeDate:</code>åŠ<code>setName</code>ç­‰æ–¹æ³•</p>
<h4 id="æ¡ä»¶é”_NSConditionLock">æ¡ä»¶é” NSConditionLock</h4><p>ä¹Ÿæœ‰äººè¯´è¿™æ˜¯ä¸ªäº’æ–¥é”<br>NSConditionLockåŒæ ·å®ç°äº†NSLockingåè®®ï¼Œè¯•éªŒè¿‡ç¨‹ä¸­å‘ç°æ€§èƒ½å¾ˆä½</p>
<p>ç¤ºä¾‹ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line">synchronizationQueue = dispatch_queue_create([@<span class="string">"com.mac.synchronization"</span> cStringUsingEncoding:NSASCIIStringEncoding], DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)remove:(NSMutableArray *)data &#123;</span><br><span class="line">    NSString *str;</span><br><span class="line">    [lock lockWhenCondition:<span class="number">1</span>];    <span class="comment">//æ¡ä»¶åŠ é”</span></span><br><span class="line">    <span class="keyword">if</span> (data.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        str = [data lastObject];</span><br><span class="line">        [data removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    [lock unlockWithCondition:<span class="number">0</span>];     <span class="comment">//æ”¹å˜æ¡ä»¶è§£é”</span></span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)add:(NSMutableArray *)data &#123;</span><br><span class="line">    [lock lockWhenCondition:<span class="number">0</span>]; <span class="comment">//æ¡ä»¶åŠ é”</span></span><br><span class="line">    [data addObject:@<span class="string">"0"</span>];</span><br><span class="line">    [lock unlockWithCondition:<span class="number">1</span>]; <span class="comment">//æ”¹å˜æ¡ä»¶è§£é”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> mark - å¤šçº¿ç¨‹å–å‡ºæ•°æ®ååˆ é™¤</span></span><br><span class="line">- (<span class="keyword">void</span>)getDataInMultiThread &#123;</span><br><span class="line">    NSMutableArray *data = [NSMutableArray <span class="built_in">array</span>];</span><br><span class="line">    <span class="keyword">dispatch_group_t</span> dispatchGroup = dispatch_group_create();</span><br><span class="line">    __block <span class="keyword">double</span> then, now;</span><br><span class="line">    then = CFAbsoluteTimeGetCurrent();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10000</span>; i++) &#123;</span><br><span class="line">        dispatch_group_async(dispatchGroup, synchronizationQueue, ^()&#123;</span><br><span class="line">            [self remove:data];</span><br><span class="line">        &#125;);</span><br><span class="line">        dispatch_group_async(dispatchGroup, synchronizationQueue, ^()&#123;</span><br><span class="line">            [self add:data];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_group_notify(dispatchGroup, synchronizationQueue, ^()&#123;</span><br><span class="line">        now = CFAbsoluteTimeGetCurrent();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"thread_lock: %f sec\n data count: %ld\n"</span>, now-then, data.count);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ¡ä»¶é”çš„åˆå§‹çŠ¶æ€æ˜¯<code>&quot;0&quot;</code>ï¼Œæ‰€ä»¥<code>add</code>çº¿ç¨‹åœ¨è¿™ä¸ªæ—¶å€™å°±ä¼šè·å–åˆ°é”ï¼Œæ‰§è¡Œå®Œæˆåå†æŠŠçŠ¶æ€è®¾ç½®ä¸º<code>&quot;1&quot;</code>ï¼›è¿™æ—¶<code>remove</code>çº¿ç¨‹å‘ç°æ¡ä»¶å˜æˆ<code>&quot;1&quot;</code>åå°±å¯ä»¥è·å–åˆ°é”ï¼Œç›´åˆ°æ‰§è¡Œç»“æŸåå†æŠŠçŠ¶æ€è®¾ç½®æˆ<code>&quot;0&quot;</code>ã€‚</p>
<h4 id="æ¡ä»¶é”ä¸äº’æ–¥é”ç»“åˆä½“_NSCondition">æ¡ä»¶é”ä¸äº’æ–¥é”ç»“åˆä½“ NSCondition</h4><p>NSConditionç±»æ˜¯äº’æ–¥é”å’Œæ¡ä»¶é”çš„ç»“åˆä½“ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ä¿¡å·è€Œé˜»å¡æ—¶ï¼Œå¯ä»¥è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹å”¤é†’<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">NSCondition </span>*<span class="keyword">cond</span> = [[<span class="constant">NSCondition </span>alloc] init];</span><br><span class="line">[<span class="keyword">cond</span> lock];</span><br><span class="line"><span class="keyword">while</span> (timeToDoWork &lt;= <span class="number">0</span>)</span><br><span class="line">[<span class="keyword">cond</span> wait];</span><br><span class="line">timeToDoWork--;</span><br><span class="line"><span class="regexp">//</span> <span class="constant">Do </span>real work here.</span><br><span class="line">[<span class="keyword">cond</span> unlock];</span><br></pre></td></tr></table></figure></p>
<p>åœ¨å…¶ä»–çº¿ç¨‹ä¸­å”¤é†’ï¼š<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="list">[<span class="keyword"><span class="built_in">cond</span></span> lock]<span class="comment">;</span></span><br><span class="line">timeToDoWork++<span class="comment">;</span></span><br><span class="line"><span class="list">[<span class="keyword"><span class="built_in">cond</span></span> signal]<span class="comment">;</span></span><br><span class="line"><span class="list">[<span class="keyword"><span class="built_in">cond</span></span> unlock]<span class="comment">;</span></span></span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="äº’æ–¥é”ã€è·¨è¿›ç¨‹çš„åˆ†å¸ƒå¼é”_NSDistributedLock">äº’æ–¥é”ã€è·¨è¿›ç¨‹çš„åˆ†å¸ƒå¼é” NSDistributedLock</h4><p>NSDistributedLockæ˜¯MACå¼€å‘ä¸­çš„è·¨è¿›ç¨‹çš„åˆ†å¸ƒå¼é”ï¼Œåº•å±‚æ˜¯ç”¨æ–‡ä»¶ç³»ç»Ÿå®ç°çš„äº’æ–¥é”ã€‚NSDistributedLockæ²¡æœ‰å®ç°NSLockingåè®®ï¼Œæ‰€ä»¥æ²¡æœ‰lockæ–¹æ³•ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯éé˜»å¡çš„tryLockæ–¹æ³•ã€‚<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NSDistributedLock *<span class="keyword">lock</span> = [[NSDistributedLock alloc] initWithPath:<span class="string">@"/Users/mac/Desktop/lock.lock"</span>];</span><br><span class="line"><span class="keyword">while</span> (![<span class="keyword">lock</span> tryLock]) &#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//do something</span></span><br><span class="line">[<span class="keyword">lock</span> unlock];</span><br></pre></td></tr></table></figure></p>
<p>NSDistributedLockåªæœ‰åœ¨é”æŒæœ‰è€…æ˜¾å¼åœ°é‡Šæ”¾åæ‰ä¼šè¢«é‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æŒæœ‰é”çš„åº”ç”¨å´©æºƒåï¼Œå…¶ä»–åº”ç”¨å°±ä¸èƒ½è®¿é—®å—ä¿æŠ¤çš„å…±äº«èµ„æºäº†ã€‚<br>å¦‚å½“æ‰§è¡Œåˆ°do somethingæ—¶ç¨‹åºé€€å‡º,ç¨‹åºå†æ¬¡å¯åŠ¨ä¹‹åtryLockå°±å†ä¹Ÿä¸èƒ½æˆåŠŸäº†,é™·å…¥æ­»é”çŠ¶æ€.å…¶ä»–åº”ç”¨ä¹Ÿä¸èƒ½è®¿é—®å—ä¿æŠ¤çš„å…±äº«èµ„æºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨breadLockæ–¹æ³•æ¥æ‰“ç ´ç°å­˜çš„é”ä»¥ä¾¿ä½ å¯ä»¥è·å–å®ƒã€‚ä½†æ˜¯é€šå¸¸åº”è¯¥é¿å…æ‰“ç ´é”ï¼Œé™¤éä½ ç¡®å®šæ‹¥æœ‰è¿›ç¨‹å·²ç»æ­»äº¡å¹¶ä¸å¯èƒ½å†é‡Šæ”¾è¯¥é”ã€‚</p>
<h4 id="è‡ªæ—‹é”OSSpinLock">è‡ªæ—‹é”OSSpinLock</h4><p>é¦–å…ˆè¦æçš„æ˜¯OSSpinLockå·²ç»å‡ºç°äº†BUGï¼Œå¯¼è‡´å¹¶ä¸èƒ½å®Œå…¨ä¿è¯æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<blockquote>
<p>æ–°ç‰ˆ iOS ä¸­ï¼Œç³»ç»Ÿç»´æŠ¤äº† 5 ä¸ªä¸åŒçš„çº¿ç¨‹ä¼˜å…ˆçº§/QoS: backgroundï¼Œutilityï¼Œdefaultï¼Œuser-initiatedï¼Œuser-interactiveã€‚é«˜ä¼˜å…ˆçº§çº¿ç¨‹å§‹ç»ˆä¼šåœ¨ä½ä¼˜å…ˆçº§çº¿ç¨‹å‰æ‰§è¡Œï¼Œä¸€ä¸ªçº¿ç¨‹ä¸ä¼šå—åˆ°æ¯”å®ƒæ›´ä½ä¼˜å…ˆçº§çº¿ç¨‹çš„å¹²æ‰°ã€‚è¿™ç§çº¿ç¨‹è°ƒåº¦ç®—æ³•ä¼šäº§ç”Ÿæ½œåœ¨çš„ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼Œä»è€Œç ´åäº† spin lockã€‚<br>å…·ä½“æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªä½ä¼˜å…ˆçº§çš„çº¿ç¨‹è·å¾—é”å¹¶è®¿é—®å…±äº«èµ„æºï¼Œè¿™æ—¶ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¹Ÿå°è¯•è·å¾—è¿™ä¸ªé”ï¼Œå®ƒä¼šå¤„äº spin lock çš„å¿™ç­‰çŠ¶æ€ä»è€Œå ç”¨å¤§é‡ CPUã€‚æ­¤æ—¶ä½ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•ä¸é«˜ä¼˜å…ˆçº§çº¿ç¨‹äº‰å¤º CPU æ—¶é—´ï¼Œä»è€Œå¯¼è‡´ä»»åŠ¡è¿Ÿè¿Ÿå®Œä¸æˆã€æ— æ³•é‡Šæ”¾ lockã€‚è¿™å¹¶ä¸åªæ˜¯ç†è®ºä¸Šçš„é—®é¢˜ï¼Œlibobjc å·²ç»é‡åˆ°äº†å¾ˆå¤šæ¬¡è¿™ä¸ªé—®é¢˜äº†ï¼Œäºæ˜¯è‹¹æœçš„å·¥ç¨‹å¸ˆåœç”¨äº† OSSpinLockã€‚<br>è‹¹æœå·¥ç¨‹å¸ˆ Greg Parker æåˆ°ï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ç”¨ truly unbounded backoff ç®—æ³•ï¼Œè¿™èƒ½é¿å… livelock é—®é¢˜ï¼Œä½†å¦‚æœç³»ç»Ÿè´Ÿè½½é«˜æ—¶ï¼Œå®ƒä»æœ‰å¯èƒ½å°†é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹é˜»å¡æ•°åç§’ä¹‹ä¹…ï¼›å¦ä¸€ç§æ–¹æ¡ˆæ˜¯ä½¿ç”¨ handoff lock ç®—æ³•ï¼Œè¿™ä¹Ÿæ˜¯ libobjc ç›®å‰æ­£åœ¨ä½¿ç”¨çš„ã€‚é”çš„æŒæœ‰è€…ä¼šæŠŠçº¿ç¨‹ ID ä¿å­˜åˆ°é”å†…éƒ¨ï¼Œé”çš„ç­‰å¾…è€…ä¼šä¸´æ—¶è´¡çŒ®å‡ºå®ƒçš„ä¼˜å…ˆçº§æ¥é¿å…ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ã€‚ç†è®ºä¸Šè¿™ç§æ¨¡å¼ä¼šåœ¨æ¯”è¾ƒå¤æ‚çš„å¤šé”æ¡ä»¶ä¸‹äº§ç”Ÿé—®é¢˜ï¼Œä½†å®è·µä¸Šç›®å‰è¿˜ä¸€åˆ‡éƒ½å¥½ã€‚<br>OSSpinLock è‡ªæ—‹é”ï¼Œæ€§èƒ½æœ€é«˜çš„é”ã€‚åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ç›´ do while å¿™ç­‰ã€‚å®ƒçš„ç¼ºç‚¹æ˜¯å½“ç­‰å¾…æ—¶ä¼šæ¶ˆè€—å¤§é‡ CPU èµ„æºï¼Œæ‰€ä»¥å®ƒä¸é€‚ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚å¯¹äºå†…å­˜ç¼“å­˜çš„å­˜å–æ¥è¯´ï¼Œå®ƒéå¸¸åˆé€‚ã€‚<br>-æ‘˜è‡ª<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="external">ibireme-ä¸å†å®‰å…¨çš„ OSSpinLock</a></p>
</blockquote>
<p>ç¤ºä¾‹ï¼š<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#import &lt;libkern/OSAtomic.h&gt;</span></span><br><span class="line"><span class="comment">@interface OSSpinLockViewController () &#123;</span></span><br><span class="line">    OSSpinLock spinlock;  //å£°æ˜pthread_mutex_tçš„ç»“æ„</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">@implementation OSSpinLockViewController</span></span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    /<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line">     <span class="keyword">*</span>  åˆå§‹åŒ–</span><br><span class="line">     <span class="keyword">*</span></span><br><span class="line">     <span class="keyword">*</span>/</span><br><span class="line">    spinlock = OS_SPINLOCK_INIT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)run &#123;</span><br><span class="line">    /<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line">     <span class="keyword">*</span>  åŠ é”</span><br><span class="line">     <span class="keyword">*</span>/</span><br><span class="line">    OSSpinLockLock(&amp;spinlock);</span><br><span class="line">    //do something</span><br><span class="line">    /<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line">     <span class="keyword">*</span>  è§£é”</span><br><span class="line">     <span class="keyword">*</span>/</span><br><span class="line">    OSSpinLockUnlock(&amp;spinlock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">@end</span></span><br></pre></td></tr></table></figure></p>
<p>iOS 10 ä¹‹åï¼Œè‹¹æœç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ç”¨ os_unfair_lock ä»£æ›¿ OSSpinLock</p>
<p><code>&#39;OSSpinLockLock&#39; is deprecated: first deprecated in iOS 10.0 - Use os_unfair_lock_lock() from &lt;os/lock.h&gt; instead</code></p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;os/lock.h&gt;</span><br><span class="line"></span><br><span class="line">__block os_unfair_lock lock = OS_UNFAIR_LOCK_INIT<span class="comment">;</span></span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">   os_unfair_lock_lock(&amp;lock)<span class="comment">;</span></span><br><span class="line">   NSLog(@"ç¬¬ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æ“ä½œå¼€å§‹")<span class="comment">;</span></span><br><span class="line">   sleep(8)<span class="comment">;</span></span><br><span class="line">   NSLog(@"ç¬¬ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æ“ä½œç»“æŸ")<span class="comment">;</span></span><br><span class="line">   os_unfair_lock_unlock(&amp;lock)<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">   sleep(1)<span class="comment">;</span></span><br><span class="line">   os_unfair_lock_lock(&amp;lock)<span class="comment">;</span></span><br><span class="line">   NSLog(@"ç¬¬äºŒä¸ªçº¿ç¨‹åŒæ­¥æ“ä½œå¼€å§‹")<span class="comment">;</span></span><br><span class="line">   os_unfair_lock_unlock(&amp;lock)<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">//æ‰§è¡Œç»“æœ</span><br><span class="line">//<span class="number">2017-11-30</span> <span class="number">15:12:31.70</span><span class="number">1180+0800</span> ç¬¬ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æ“ä½œå¼€å§‹</span><br><span class="line">//<span class="number">2017-11-30</span> <span class="number">15:12:39.70</span><span class="number">5473+0800</span> ç¬¬ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æ“ä½œç»“æŸ</span><br><span class="line">//<span class="number">2017-11-30</span> <span class="number">15:12:39.70</span><span class="number">5820+0800</span> ç¬¬äºŒä¸ªçº¿ç¨‹åŒæ­¥æ“ä½œå¼€å§‹</span><br></pre></td></tr></table></figure>
<p>è‡ªæ—‹é”å’Œäº’æ–¥é”å¼‚åŒ</p>
<p>ç›¸åŒç‚¹ï¼šéƒ½èƒ½ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºã€‚éƒ½èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>ä¸åŒç‚¹ï¼š</p>
<p>äº’æ–¥é”ï¼šå¦‚æœå…±äº«æ•°æ®å·²ç»æœ‰å…¶ä»–çº¿ç¨‹åŠ é”äº†ï¼Œçº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ç­‰å¾…é”ã€‚ä¸€æ—¦è¢«è®¿é—®çš„èµ„æºè¢«è§£é”ï¼Œåˆ™ç­‰å¾…èµ„æºçš„çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚</p>
<p>è‡ªæ—‹é”ï¼šå¦‚æœå…±äº«æ•°æ®å·²ç»æœ‰å…¶ä»–çº¿ç¨‹åŠ é”äº†ï¼Œçº¿ç¨‹ä¼šä»¥æ­»å¾ªç¯çš„æ–¹å¼ç­‰å¾…é”ï¼Œä¸€æ—¦è¢«è®¿é—®çš„èµ„æºè¢«è§£é”ï¼Œåˆ™ç­‰å¾…èµ„æºçš„çº¿ç¨‹ä¼šç«‹å³æ‰§è¡Œã€‚</p>
<p>è‡ªæ—‹é”çš„æ•ˆç‡é«˜äºäº’æ–¥é”ã€‚</p>
<h4 id="GCDçº¿ç¨‹é˜»æ–­dispatch_barrier_async/dispatch_barrier_sync">GCDçº¿ç¨‹é˜»æ–­dispatch_barrier_async/dispatch_barrier_sync</h4><p>dispatch_barrier_async/dispatch_barrier_syncåœ¨ä¸€å®šçš„åŸºç¡€ä¸Šä¹Ÿå¯ä»¥åšçº¿ç¨‹åŒæ­¥ï¼Œä¼šåœ¨çº¿ç¨‹é˜Ÿåˆ—ä¸­æ‰“æ–­å…¶ä»–çº¿ç¨‹æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´<code>åªæœ‰ç”¨åœ¨å¹¶å‘çš„çº¿ç¨‹é˜Ÿåˆ—ä¸­</code>æ‰ä¼šæœ‰æ•ˆï¼Œå› ä¸ºä¸²è¡Œé˜Ÿåˆ—æœ¬æ¥å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ‰§è¡Œçš„ï¼Œä½ æ‰“æ–­æ‰§è¡Œä¸€ä¸ªå’Œæ’å…¥ä¸€ä¸ªæ˜¯ä¸€æ ·çš„æ•ˆæœã€‚ä¸¤ä¸ªçš„åŒºåˆ«æ˜¯æ˜¯å¦ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šå¦‚æœåœ¨å½“å‰çº¿ç¨‹è°ƒç”¨dispatch_barrier_syncæ‰“æ–­ä¼šå‘ç”Ÿæ­»é”ã€‚</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">__block <span class="keyword">double</span> then, now;</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line">synchronizationQueue = dispatch_queue_create([@<span class="string">"com.mac.synchronization"</span> cStringUsingEncoding:NSASCIIStringEncoding], DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)getData:(NSMutableArray *)data &#123;</span><br><span class="line">    NSString *str;</span><br><span class="line">    <span class="keyword">if</span> (data.count&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        str = [data firstObject];</span><br><span class="line">        [data removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        now = CFAbsoluteTimeGetCurrent();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"thread_lock: %f sec\n data count: %ld\n"</span>, now-then, data.count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)getDataWithMultiThread &#123;</span><br><span class="line">    NSMutableArray *data = [NSMutableArray <span class="keyword">new</span>];</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">1024</span>*<span class="number">11</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</span><br><span class="line">        [data addObject:[NSString stringWithFormat:@<span class="string">"%d"</span>, i]];</span><br><span class="line">    &#125;</span><br><span class="line">    then = CFAbsoluteTimeGetCurrent();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count+<span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//100æ¥æµ‹è¯•é”æœ‰æ²¡æœ‰æ­£ç¡®çš„æ‰§è¡Œ</span></span><br><span class="line">        dispatch_barrier_async(synchronizationQueue, ^&#123;</span><br><span class="line">             [self getData:data];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å„ç§é”æ€§èƒ½">å„ç§é”æ€§èƒ½</h4><p><img src="https://user-gold-cdn.xitu.io/2017/12/8/1603542bc602d97f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p>
<h4 id="æ€»ç»“">æ€»ç»“</h4><ul>
<li><code>POSIX</code>(pthread_mutex)ï¼šåº•å±‚çš„apiï¼Œå¤æ‚çš„å¤šçº¿ç¨‹å¤„ç†å»ºè®®ä½¿ç”¨ï¼Œå¹¶ä¸”å¯ä»¥å°è£…è‡ªå·±çš„å¤šçº¿ç¨‹</li>
<li><code>@synchronized</code>ï¼šé€‚ç”¨çº¿ç¨‹ä¸å¤šï¼Œä»»åŠ¡é‡ä¸å¤§çš„å¤šçº¿ç¨‹åŠ é”</li>
<li><code>NSLock</code>ï¼šå…¶å®NSLockå¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆå·®ï¼Œä¸çŸ¥é“å¤§å®¶ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨</li>
<li><code>dispatch_semaphore_t</code>ï¼šä½¿ç”¨ä¿¡å·æ¥åšåŠ é”ï¼Œæ€§èƒ½æå‡æ˜¾è‘—</li>
<li><code>NSCondition</code>ï¼šä½¿ç”¨å…¶åšå¤šçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡è°ƒç”¨ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li><code>NSConditionLock</code>ï¼šå•çº¯åŠ é”æ€§èƒ½éå¸¸ä½ï¼Œæ¯”NSLockä½å¾ˆå¤šï¼Œä½†æ˜¯å¯ä»¥ç”¨æ¥åšå¤šçº¿ç¨‹å¤„ç†ä¸åŒä»»åŠ¡çš„é€šä¿¡è°ƒç”¨</li>
<li><code>NSRecursiveLock</code>ï¼šé€’å½’é”çš„æ€§èƒ½å‡ºå¥‡çš„é«˜ï¼Œä½†æ˜¯åªèƒ½ä½œä¸ºé€’å½’ä½¿ç”¨,æ‰€ä»¥é™åˆ¶äº†ä½¿ç”¨åœºæ™¯</li>
<li><code>NSDistributedLock</code>ï¼šå› ä¸ºæ˜¯MACå¼€å‘çš„ï¼Œå°±ä¸è®¨è®ºäº†</li>
<li><code>OSSpinLock</code>ï¼šæ€§èƒ½ä¹Ÿéå¸¸é«˜ï¼Œå¯æƒœå‡ºç°äº†çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ï¼Œä½¿ç”¨ os_unfair_lock æ¥ä»£æ›¿</li>
<li><code>dispatch_barrier_async/dispatch_barrier_sync</code>ï¼šæµ‹è¯•ä¸­å‘ç°dispatch_barrier_syncæ¯”dispatch_barrier_asyncæ€§èƒ½è¦é«˜</li>
</ul>
<h6 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h6><blockquote>
<p><a href="https://www.jianshu.com/p/35dd92bcfe8c" target="_blank" rel="external">https://www.jianshu.com/p/35dd92bcfe8c</a><br><a href="http://www.bijishequ.com/detail/354750" target="_blank" rel="external">http://www.bijishequ.com/detail/354750</a><br><a href="https://github.com/YasinZhou/ThreadLockDemo" target="_blank" rel="external">https://github.com/YasinZhou/ThreadLockDemo</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="iOSé”">iOSé”</h2><h4 id="æ­»é”">æ­»é”</h4><p>ä¸€ä¸ªç¤ºä¾‹<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1<]]>
    </summary>
    
      <category term="Lock" scheme="https://litt1e-p.github.io/tags/Lock/"/>
    
      <category term="Objective-C" scheme="https://litt1e-p.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Runloop]]></title>
    <link href="https://litt1e-p.github.io/2017/05/07/Runloop/"/>
    <id>https://litt1e-p.github.io/2017/05/07/Runloop/</id>
    <published>2017-05-07T12:01:37.000Z</published>
    <updated>2018-03-07T12:02:48.148Z</updated>
    <content type="html"><![CDATA[<h5 id="ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ">ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ</h5><p>ä»å­—é¢æ„ä¹‰çœ‹ï¼šè¿è¡Œå¾ªç¯ï¼Œå…¶å®å®ƒå†…éƒ¨å°±æ˜¯do-whileå¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯å†…éƒ¨ä¸æ–­åœ°å¤„ç†å„ç§ä»»åŠ¡ï¼ˆæ¯”å¦‚Sourceã€Timerã€Observerï¼‰<br>ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªRunLoopï¼Œä¸»çº¿ç¨‹çš„RunLoopé»˜è®¤å·²ç»å¯åŠ¨ï¼Œå­çº¿ç¨‹çš„RunLoopå¾—æ‰‹åŠ¨å¯åŠ¨ï¼ˆè°ƒç”¨runæ–¹æ³•ï¼‰<br>RunLoopåªèƒ½é€‰æ‹©ä¸€ä¸ªModeå¯åŠ¨ï¼Œå¦‚æœå½“å‰Modeä¸­æ²¡æœ‰ä»»ä½•Source(Sources0ã€Sources1)ã€Timerï¼Œé‚£ä¹ˆå°±ç›´æ¥é€€å‡ºRunLoop</p>
<h4 id="åŸºæœ¬ä½œç”¨">åŸºæœ¬ä½œç”¨</h4><p>ä¿æŒç¨‹åºçš„è¿è¡Œå¾ªç¯<br>å¤„ç†appä¸­çš„å„ç§æ—¶é—´ï¼ˆæ¯”å¦‚è§¦æ‘¸äº‹ä»¶ã€å®šæ—¶å™¨äº‹ä»¶ã€selectoräº‹ä»¶ï¼‰<br>èŠ‚çœCPUèµ„æºï¼Œæé«˜ç¨‹åºæ€§èƒ½ï¼šè¯¥åšäº‹æ—¶åšäº‹ï¼Œè¯¥ä¼‘æ¯æ—¶ä¼‘æ¯</p>
<h4 id="RunLoopå¯¹è±¡">RunLoopå¯¹è±¡</h4><p>iOSä¸­æœ‰2å¥—APIæ¥è®¿é—®å’Œä½¿ç”¨RunLoop</p>
<ul>
<li>Foundation</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">- </span>NSRunLoop</span><br></pre></td></tr></table></figure>
<ul>
<li>Core Foundation</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">- </span>CFRunLoopRef</span><br></pre></td></tr></table></figure>
<p>NSRunLoopå’ŒCFRunLoopReféƒ½ä»£è¡¨ç€RunLoopå¯¹è±¡<br>NSRunLoopæ˜¯åŸºäºCFRunLoopRefçš„ä¸€å±‚OCåŒ…è£…ï¼Œæ‰€ä»¥è¦äº†è§£RunLoopå†…éƒ¨ç»“æ„ï¼Œéœ€è¦å¤šç ”ç©¶CFRunLoopRefå±‚é¢çš„APIï¼ˆCore Foundationå±‚é¢ï¼‰</p>
<h4 id="RunLoopä¸çº¿ç¨‹é—´å…³ç³»">RunLoopä¸çº¿ç¨‹é—´å…³ç³»</h4><p>æ¯æ¡çº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„RunLoopå¯¹è±¡<br>ä¸»çº¿ç¨‹çš„RunLoopå·²ç»è‡ªåŠ¨åˆ›å»ºå¥½äº†ï¼Œå­çº¿ç¨‹çš„RunLoopéœ€è¦ä¸»åŠ¨åˆ›å»º<br>RunLoopåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶åˆ›å»ºï¼Œåœ¨çº¿ç¨‹ç»“æŸæ—¶é”€æ¯</p>
<h4 id="è·å¾—RunLoopå¯¹è±¡çš„æ–¹æ³•">è·å¾—RunLoopå¯¹è±¡çš„æ–¹æ³•</h4><ul>
<li>Foundation</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr_selector">[NSRunLoop currentRunLoop]</span>;  <span class="comment">//è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br><span class="line"><span class="attr_selector">[NSRunLoop mainRunLoop]</span>;  <span class="comment">//è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Core Foundation</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFRunLoopGetCurrent</span>();  <span class="comment">//è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br><span class="line"><span class="built_in">CFRunLoopGetMain</span>();  <span class="comment">//è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br></pre></td></tr></table></figure>
<h4 id="RunLoopçš„ç»“æ„ç»„æˆ">RunLoopçš„ç»“æ„ç»„æˆ</h4><p>Core Foundationä¸­å…³äºRunLoopçš„5ä¸ªç±»<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFRunLoopRef</span>          <span class="comment">// RunLoopå¯¹è±¡è‡ªèº«</span></span><br><span class="line"><span class="built_in">CFRunLoopModeRef</span>      <span class="comment">// RunLoopçš„è¿è¡Œæ¨¡å¼</span></span><br><span class="line"><span class="built_in">CFRunLoopSourceRef</span>    <span class="comment">// æ•°æ®æºã€äº‹ä»¶æº</span></span><br><span class="line"><span class="built_in">CFRunLoopTimerRef</span>     <span class="comment">// NSTimer</span></span><br><span class="line"><span class="built_in">CFRunLoopObserverRef</span>  <span class="comment">// è§‚å¯Ÿã€ç›‘å¬RunLoop</span></span><br></pre></td></tr></table></figure></p>
<p>åœ¨RunLoopä¸­æœ‰å¤šä¸ªè¿è¡Œæ¨¡å¼ï¼Œä½†æ˜¯RunLoopåªèƒ½é€‰æ‹©ä¸€ç§æ¨¡å¼è¿è¡Œ<br>modeé‡Œé¢è‡³å°‘è¦æœ‰ä¸€ä¸ªtimeræˆ–è€…sourceï¼Œobserverå¯æœ‰å¯æ— ï¼ˆåªæ˜¯ç”¨æ¥è§‚å¯Ÿï¼ç›‘å¬RunLoopï¼‰</p>
<h4 id="RunLoopçš„è¿è¡Œæ¨¡å¼Mode">RunLoopçš„è¿è¡Œæ¨¡å¼Mode</h4><p>ä¸€ä¸ªRunLoopåŒ…å«è‹¥å¹²ä¸ªModeï¼Œæ¯ä¸ªModeåˆåŒ…å«è‹¥å¹²ä¸ªSource/Timer/Observer<br>æ¯æ¬¡RunLoopå¯åŠ¨æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ªModeï¼Œè¿™ä¸ªModeè¢«ç§°ä½œCurrentMode<br>è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„Source/Timer/Observerï¼Œè®©å…¶äº’ä¸å½±å“</p>
<p>ç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode</p>
<ul>
<li>kCFRunLoopDefaultModeï¼šAppçš„é»˜è®¤Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªModeä¸‹è¿è¡Œï¼ˆå¸¸ç”¨ï¼‰</li>
<li>UITrackingRunLoopMode: ç•Œé¢è¿½è¸ªModeï¼Œç”¨äºtableViewã€ScrollViewè¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“ï¼ˆå¸¸ç”¨ï¼‰</li>
<li>UIInitializationRunLoopModeï¼šåœ¨åˆšå¯åŠ¨Appæ—¶ï¼Œè¿›å…¥çš„ç¬¬ä¸€ä¸ªmodeï¼Œå¯åŠ¨åå°±ä¸å†ä½¿ç”¨</li>
<li>GSEventReceiveRunLoopModeï¼šæ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°</li>
<li>kCFRunLoopCommonModesï¼šè¿™æ˜¯ä¸€ä¸ªå ä½ç”¨çš„Modeï¼Œä¸æ˜¯çœŸæ­£çš„Mode</li>
</ul>
<h4 id="ä¸»çº¿ç¨‹ä¸­(mainå‡½æ•°)çš„runLoop">ä¸»çº¿ç¨‹ä¸­(mainå‡½æ•°)çš„runLoop</h4><p>1.Objective-Cä¸­<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>UIApplicationMainå‡½æ•°å†…éƒ¨å°±å¯åŠ¨äº†ä¸€ä¸ªRunLoop<br>æ‰€ä»¥UIApplicationå‡½æ•°ä¸€ç›´æ²¡æœ‰è¿”å›ï¼Œä¿æŒäº†ç¨‹åºçš„æŒç»­è¿è¡Œ<br>è¿™ä¸ªé»˜è®¤å¯åŠ¨çš„RunLoopæ˜¯è·Ÿä¸»çº¿ç¨‹ç›¸å…³è”çš„</p>
<p>2.Swiftä¸­<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@UIApplicationMain</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppDelegate</span>: <span class="typename">UIResponder</span>, <span class="typename">UIApplicationDelegate &#123;&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>Swiftåœ¨AppDelegate.swiftä¸­ç”¨æ ‡ç­¾<code>@UIApplicationMain</code>æ¥å–ä»£äº†mainå‡½æ•°ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œåˆ›å»ºmain.swiftæ¥å½“åšç¨‹åºçš„å…¥å£ï¼Œè¿™æ—¶å€™è¦å°†æ ‡ç­¾@UIApplicationMainæ³¨é‡Šï¼Œmain.swiftä»£ç å¦‚ä¸‹<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UIApplicationMain<span class="list">(<span class="keyword">CommandLine</span>.argc, UnsafeMutableRawPointer<span class="list">(<span class="keyword">CommandLine</span>.unsafeArgv)</span>.bindMemory<span class="list">(<span class="keyword">to</span>: UnsafeMutablePointer&lt;Int8&gt;.self, capacity: Int<span class="list">(<span class="keyword">CommandLine</span>.argc)</span>)</span>, <span class="literal">nil</span>, NSStringFromClass<span class="list">(<span class="keyword">AppDelegate</span>.self)</span>)</span></span><br></pre></td></tr></table></figure></p>
<h4 id="å­çº¿ç¨‹ä¸­çš„runloop">å­çº¿ç¨‹ä¸­çš„runloop</h4><p>eg.timer: éœ€è¦æ‰‹åŠ¨åˆ›å»ºrunloopå¹¶é™„åŠ åˆ°å½“å‰å­çº¿ç¨‹è¿è¡Œ</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(timer) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)timer &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨æ­¤timeråˆ›å»ºæ–¹å¼ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨åˆ›å»ºrunLoop</span></span><br><span class="line">    <span class="built_in">NSRunLoop</span> *currentRunLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯¥æ–¹æ³•å†…éƒ¨è‡ªåŠ¨æ·»åŠ åˆ°runLoopä¸­ï¼Œå¹¶ä¸”è®¾ç½®è¿è¡Œæ¨¡å¼ä¸ºé»˜è®¤</span></span><br><span class="line">    [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">2.0</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­çº¿ç¨‹ä¸­åˆ›å»ºrunLoopä¹‹åä¸ä¼šæ‰§è¡Œï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯runLoop</span></span><br><span class="line">    [currentRunLoop run];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‹¥åœ¨ä¸»çº¿ç¨‹çš„runloopåˆ›å»ºtimerï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSTimer *timer = [NSTimer <span class="string">timerWithTimeInterval:</span><span class="number">2.0</span> <span class="string">target:</span>self <span class="string">selector:</span><span class="annotation">@selector</span>(run) <span class="string">userInfo:</span>nil <span class="string">repeats:</span>YES];</span><br><span class="line"></span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>NSDefaultRunLoopMode];<span class="comment">//é»˜è®¤æ¨¡å¼</span></span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>UITrackingRunLoopMode];<span class="comment">//é¡µé¢è¿½è¸ªæ¨¡å¼</span></span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>NSRunLoopCommonModes]; <span class="comment">//commonæ¨¡å¼</span></span><br></pre></td></tr></table></figure></p>
<p><code>*æ³¨æ„ï¼šNSRunLoopCommonModes = NSDefaultRunLoopMode + UITrackingRunLoopMode</code></p>
<h4 id="åœ¨å¼€å‘ä¸­å¦‚ä½•ä½¿ç”¨RunLoopï¼Ÿä»€ä¹ˆåº”ç”¨åœºæ™¯ï¼Ÿ">åœ¨å¼€å‘ä¸­å¦‚ä½•ä½¿ç”¨RunLoopï¼Ÿä»€ä¹ˆåº”ç”¨åœºæ™¯ï¼Ÿ</h4><ul>
<li>å¼€å¯ä¸€ä¸ªå¸¸é©»çº¿ç¨‹ï¼ˆè®©ä¸€ä¸ªå­çº¿ç¨‹ä¸è¿›å…¥æ¶ˆäº¡çŠ¶æ€ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹å‘æ¥æ¶ˆæ¯ï¼Œå¤„ç†å…¶ä»–äº‹ä»¶ï¼‰</li>
<li>åœ¨å­çº¿ç¨‹ä¸­å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨</li>
<li>åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œä¸€äº›é•¿æœŸç›‘æ§</li>
<li>å¯ä»¥æ§åˆ¶å®šæ—¶å™¨åœ¨ç‰¹å®šæ¨¡å¼ä¸‹æ‰§è¡Œ</li>
<li>å¯ä»¥è®©æŸäº›äº‹ä»¶ï¼ˆè¡Œä¸ºã€ä»»åŠ¡ï¼‰åœ¨ç‰¹å®šæ¨¡å¼ä¸‹æ‰§è¡Œ</li>
<li>å¯ä»¥æ·»åŠ Observerç›‘å¬RunLoopçš„çŠ¶æ€ï¼Œæ¯”å¦‚ç›‘å¬ç‚¹å‡»äº‹ä»¶çš„å¤„ç†ï¼ˆåœ¨æ‰€æœ‰ç‚¹å‡»äº‹ä»¶ä¹‹å‰åšä¸€äº›äº‹æƒ…ï¼‰</li>
</ul>
<h4 id="è‡ªåŠ¨é‡Šæ”¾æ± ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ">è‡ªåŠ¨é‡Šæ”¾æ± ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ</h4><ul>
<li>ç¬¬ä¸€æ¬¡åˆ›å»ºåœ¨ï¼šå¯åŠ¨runLoopçš„æ—¶å€™</li>
<li>æœ€åä¸€æ¬¡é”€æ¯åœ¨ï¼šrunLoopé€€å‡ºçš„æ—¶å€™</li>
<li>å…¶ä»–æ—¶å€™çš„åˆ›å»ºå’Œé”€æ¯ï¼šå½“runLoopå³å°†ç¡çœ çš„æ—¶å€™é”€æ¯ä¹‹å‰çš„é‡Šæ”¾æ± ï¼Œå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„</li>
</ul>
<hr>
<h6 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h6><blockquote>
<p><a href="http://www.bijishequ.com/detail/228372" target="_blank" rel="external">http://www.bijishequ.com/detail/228372</a><br><a href="http://www.bijishequ.com/detail/234634" target="_blank" rel="external">http://www.bijishequ.com/detail/234634</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h5 id="ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ">ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ</h5><p>ä»å­—é¢æ„ä¹‰çœ‹ï¼šè¿è¡Œå¾ªç¯ï¼Œå…¶å®å®ƒå†…éƒ¨å°±æ˜¯do-whileå¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯å†…éƒ¨ä¸æ–­åœ°å¤„ç†å„ç§ä»»åŠ¡ï¼ˆæ¯”å¦‚Sourceã€Timerã€Observerï¼‰<br>ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªRunLoopï¼Œä¸»çº¿ç¨‹çš„RunLo]]>
    </summary>
    
      <category term="Objective-C" scheme="https://litt1e-p.github.io/tags/Objective-C/"/>
    
      <category term="Runloop" scheme="https://litt1e-p.github.io/tags/Runloop/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Runtime]]></title>
    <link href="https://litt1e-p.github.io/2017/03/06/Runtime/"/>
    <id>https://litt1e-p.github.io/2017/03/06/Runtime/</id>
    <published>2017-03-06T12:32:31.000Z</published>
    <updated>2018-03-06T12:35:02.224Z</updated>
    <content type="html"><![CDATA[<h4 id="ç®€ä»‹">ç®€ä»‹</h4><p>Objective-C æ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œå®ƒçš„åŠ¨æ€æ€§ä½“ç°åœ¨å®ƒå°†å¾ˆå¤šç¼–è¯‘å’Œé“¾æ¥æ—¶åšçš„äº‹æ¨å»¶åˆ°è¿è¡Œæ—¶å¤„ç†ï¼Œè€Œè¿™ä¸€æœºåˆ¶ä¸»è¦ä¾èµ–ç³»ç»Ÿæä¾›çš„ runtime åº“ã€‚åˆ©ç”¨ runtime åº“ï¼Œæˆ‘ä»¬èƒ½åœ¨è¿è¡Œæ—¶åšå¾ˆå¤šäº‹ï¼Œä¾‹å¦‚ objc_setAssociatedObject åŠ¨æ€ç»‘å®šå±æ€§ã€method swizzlingã€class_copyIvarList åŠ¨æ€è·å–å±æ€§å®ç° ORMï¼ˆObject Relational Mappingï¼‰ã€æ¶ˆæ¯è½¬å‘ç­‰ã€‚</p>
<h4 id="æ¶ˆæ¯è½¬å‘">æ¶ˆæ¯è½¬å‘</h4><p>Objective-C ä¸­çš„æ–¹æ³•è°ƒç”¨æœ€ç»ˆéƒ½æ˜¯æ‰§è¡Œæ¶ˆæ¯å‘é€ï¼Œå¦‚</p>
<p><code>[receiver message]</code></p>
<p>æœ€åä¼šè½¬æ¢æˆ</p>
<p><code>objc_msgSend(receiver, selector)</code></p>
<p>å¦‚æœ receiver ä¸å“åº” message æ¶ˆæ¯ï¼Œåˆ™ä¼šå»çˆ¶ç±»æŸ¥æ‰¾ï¼Œçˆ¶ç±»è¿˜ä¸å“åº”ç»§ç»­å»çˆ¶ç±»æŸ¥æ‰¾ï¼Œå¦‚æœä¸€ç›´æŸ¥æ‰¾åˆ° NSObject è¿˜ä¸å“åº”ï¼Œåˆ™ä¼šè¿›å…¥æ¶ˆæ¯åŠ¨æ€å¤„ç†æµç¨‹ã€‚</p>
<h4 id="æ¶ˆæ¯åŠ¨æ€å¤„ç†">æ¶ˆæ¯åŠ¨æ€å¤„ç†</h4><p>å¦‚æœä¸€ä¸ªç±»ä¸å“åº”æŸä¸ªå…·ä½“çš„æ–¹æ³•ï¼Œåœ¨è¿›å…¥æ¶ˆæ¯è½¬å‘æµç¨‹å‰è¿˜æœ‰ä¸¤ä¸ªæ—¶æœºå¤„ç†ï¼Œç¬¬ä¸€æ˜¯è¯¢é—®æ˜¯å¦æœ‰åŠ¨æ€æ·»åŠ æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ï¼ˆ<code>resolveInstanceMethod/resolveClassMethod</code>ï¼‰, è‹¥æ²¡æœ‰åˆ™è¯¢é—®æœ‰æ²¡æœ‰åˆ«äººèƒ½å¤Ÿå¸®å¿™å¤„ç†ä¸€ä¸‹å•Šï¼Œè°ƒç”¨çš„æ˜¯<code>forwardingTargetForSelector</code>è¿™ä¸ªæ–¹æ³•ã€‚</p>
<ul>
<li>resolveInstanceMethod / resolveClassMethod</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="tag">BOOL</span>)<span class="tag">resolveInstanceMethod</span><span class="pseudo">:(SEL)sel</span>;</span><br><span class="line">+ (<span class="tag">BOOL</span>)<span class="tag">resolveClassMethod</span><span class="pseudo">:(SEL)sel</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨runtimeçš„ç‰¹æ€§åŠ¨æ€æ·»åŠ æ–¹æ³•æ¥å¤„ç†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A.m</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"sel is %@"</span>, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">    <span class="keyword">if</span>(sel == <span class="keyword">@selector</span>(setName:))&#123;</span><br><span class="line">        class_addMethod([<span class="keyword">self</span> class], sel, (IMP)a,<span class="string">"v@:"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŠ¨æ€å¤„ç†æ–¹æ³•</span></span><br><span class="line"><span class="keyword">void</span> a(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// implementation ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­class_addMethodçš„å››ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>Class cls ç»™å“ªä¸ªç±»æ·»åŠ æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­æ˜¯self</li>
<li>SEL name æ·»åŠ çš„æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­æ˜¯é‡å†™çš„æ‹¦æˆªè°ƒç”¨ä¼ è¿›æ¥çš„selectorã€‚</li>
<li>IMP imp æ–¹æ³•çš„å®ç°ï¼ŒCæ–¹æ³•çš„æ–¹æ³•å®ç°å¯ä»¥ç›´æ¥è·å¾—ã€‚å¦‚æœæ˜¯OCæ–¹æ³•ï¼Œå¯ä»¥ç”¨+ (IMP)instanceMethodForSelector:(SEL)aSelector;è·å¾—æ–¹æ³•çš„å®ç°ã€‚</li>
<li>â€œ<code>v@:*</code>â€œæ–¹æ³•çš„ç­¾åï¼Œä»£è¡¨æœ‰ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•ã€‚</li>
</ol>
<ul>
<li>forwardingTargetForSelector</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A.m</span></span><br><span class="line">- (id)<span class="string">forwardingTargetForSelector:</span>(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœä»£ç†å¯¹è±¡èƒ½å¤„ç†ï¼Œåˆ™è½¬æ¥ç»™ä»£ç†å¯¹è±¡</span></span><br><span class="line">    B *b = [[B alloc] init];</span><br><span class="line">    <span class="keyword">if</span> ([b <span class="string">respondsToSelector:</span>aSelector]) &#123;</span><br><span class="line">        <span class="keyword">return</span> proxyObj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸èƒ½å¤„ç†è¿›å…¥è½¬å‘æµç¨‹</span></span><br><span class="line">    <span class="keyword">return</span> nil;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//B.m</span></span><br><span class="line">- (<span class="typename">void</span>)b&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å¦‚æœ<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>ä¹Ÿæ‰¾ä¸åˆ°èƒ½å¤Ÿå¸®å¿™å¤„ç†è¿™æ¡æœªçŸ¥æ¶ˆæ¯ï¼Œé‚£å°±ä¼šèµ°åˆ°æœ€åä¸€æ­¥</p>
<ul>
<li>forwardInvocation &amp; methodSignatureForSelector</li>
</ul>
<p>è°ƒç”¨<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>ï¼Œåœ¨è°ƒç”¨forwardInvocation:ä¹‹å‰ä¼šè°ƒç”¨<code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>æ–¹æ³•æ¥è·å–è¿™ä¸ªé€‰æ‹©å­çš„æ–¹æ³•ç­¾åï¼Œç„¶ååœ¨<code>-(void)forwardInvocation:(NSInvocation *)anInvocation</code>æ–¹æ³•ä¸­ä½ å°±å¯ä»¥é€šè¿‡anInvocationæ‹¿åˆ°ç›¸åº”ä¿¡æ¯åšå¤„ç†ï¼Œå®ä¾‹ä»£ç å¦‚ä¸‹</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“Aç±» æ”¶åˆ°ä¸€æ¡`c`çš„æ¶ˆæ¯çš„æ—¶å€™ï¼Œå‰ä¸¤æ­¥å‘ç°éƒ½æ²¡åŠæ³•å¤„ç†æ‰ï¼Œèµ°åˆ°ç¬¬ä¸‰æ­¥ï¼š</span></span><br><span class="line"><span class="comment">//A.m</span></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"forwardInvocation: %@"</span>, <span class="built_in">NSStringFromSelector</span>([anInvocation selector]));</span><br><span class="line">    <span class="keyword">if</span> ([anInvocation selector] == <span class="keyword">@selector</span>(c)) &#123;</span><br><span class="line">        C *c = [[C alloc] init];</span><br><span class="line">        [anInvocation invokeWithTarget:c];</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"method signature for selector: %@"</span>, <span class="built_in">NSStringFromSelector</span>(aSelector));</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(c)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">"V@:@"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//C.m</span></span><br><span class="line">- (<span class="keyword">void</span>)c&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>æ¶ˆæ¯è½¬å‘æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/8/8/a65b266e187329db430c8120aab53ffc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p>
<p>é‚£ä¹ˆæœ€åæ¶ˆæ¯æœªèƒ½å¤„ç†çš„æ—¶å€™ï¼Œè¿˜ä¼šè°ƒç”¨åˆ°<br><code>- (void)doesNotRecognizeSelector:(SEL)aSelector</code>è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åšäº›æ–‡ç« ï¼Œé¿å…æ‰crashï¼Œä½†æ˜¯åªå»ºè®®åœ¨çº¿ä¸Šç¯å¢ƒçš„æ—¶å€™åšå¤„ç†ï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­è¿˜è¦æŠŠå¼‚å¸¸æŠ›å‡ºæ¥</p>
<h4 id="isaã€Class_å’Œ_MetaClass">isaã€Class å’Œ MetaClass</h4><p>Objective-C æ˜¯ C çš„è¶…é›†ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„æœºåˆ¶ï¼Œè€Œé¢å‘å¯¹è±¡æ€æƒ³é‡Œæœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼šç±»å’Œå®ä¾‹</p>
<p>åœ¨ runtime.h ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å®šä¹‰ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class isa  OBJC_ISA_<span class="built_in">AVAILABILITY</span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#if !__OBJC2__</span></span><br><span class="line">    Class super_class                                        OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                                         OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars                             OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list **methodLists                    OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache *cache                                 OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols                     OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="preprocessor">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></span><br></pre></td></tr></table></figure></p>
<p>isaï¼šæ˜¯ä¸€ä¸ªClass ç±»å‹çš„æŒ‡é’ˆ. æ¯ä¸ªå®ä¾‹å¯¹è±¡æœ‰ä¸ªisaçš„æŒ‡é’ˆ, å®ƒ<code>æŒ‡å‘å¯¹è±¡çš„ç±»</code>ï¼Œè€ŒClassé‡Œä¹Ÿæœ‰ä¸ªisaçš„æŒ‡é’ˆ, æŒ‡å‘MeteClass(å…ƒç±»)ã€‚<br>å…ƒç±»ä¹Ÿæœ‰isaæŒ‡é’ˆ,å®ƒçš„isaæŒ‡é’ˆæœ€ç»ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ ¹å…ƒç±»(root meteClass).æ ¹å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘æœ¬èº«ï¼Œè¿™æ ·å½¢æˆäº†ä¸€ä¸ªå°é—­çš„å†…å¾ªç¯ã€‚</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//B.h</span></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">B</span>: NSObject</span><br><span class="line"></span><br><span class="line">+ (void)classFuncB;</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//A.h</span></span><br><span class="line">#import <span class="string">"B.h"</span></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">A</span>: B</span><br><span class="line"></span><br><span class="line">+ (void)classFuncA;</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line">#import <span class="string">"A.m"</span></span><br><span class="line"></span><br><span class="line">A *a = [[A alloc] init];</span><br><span class="line"><span class="comment">//æ­¤æ—¶açš„isaæŒ‡å‘ç±»A(Class A)</span></span><br><span class="line"><span class="comment">//ç±»Açš„isaæŒ‡å‘ç±»Açš„metaClassï¼Œç±»Açš„metaClasså‚¨å­˜ç€ç±»æ–¹æ³•`classFuncA`</span></span><br><span class="line"></span><br><span class="line"><span class="attr_selector">[A classFuncB]</span>;</span><br><span class="line"><span class="comment">//æ­¤æ—¶ç±»Aè°ƒç”¨ç±»æ–¹æ³•`classFuncB`, ä½†ç±»Açš„metaClassæ‰¾ä¸åˆ°`classFuncB`, åˆ™ä¼šå»Açš„çˆ¶ç±»Bçš„metaClassé‡Œæ‰¾åˆ°`classFuncB`ï¼Œ</span></span><br></pre></td></tr></table></figure>
<p>ç»§æ‰¿å…³ç³»ï¼š</p>
<ol>
<li>ç±»ç»§æ‰¿ï¼ˆClassï¼‰ï¼š<code>A--&gt;B--&gt;NSObject--&gt;nil</code></li>
<li>å…ƒç±»ç»§æ‰¿ ï¼ˆMetaClassï¼‰ï¼š<code>MetaA--&gt;MetaB--&gt;RootMeta--&gt;NSObject(Class)--&gt;nil</code></li>
<li>isaç»§æ‰¿ï¼š<code>å®ä¾‹açš„isa--&gt;ç±»Açš„isa--&gt;å…ƒç±»Açš„isa--&gt;RootMeta(æ ¹å…ƒç±»)çš„isa--&gt;RootMeta(æ ¹å…ƒç±»)è‡ªèº«çš„isa</code>, ç±»BåŒç†ã€‚</li>
</ol>
<p><img src="http://upload-images.jianshu.io/upload_images/449095-3e972ec16703c54d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240/q/100" alt=""></p>
<ul>
<li><p>æ¯ä¸€ä¸ªå¯¹è±¡æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹ã€‚å…¶ä¸­ç±»å®šä¹‰äº†æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•çš„åˆ—è¡¨ã€‚å¯¹è±¡é€šè¿‡å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘ç±»ã€‚</p>
</li>
<li><p>æ¯ä¸€ä¸ªç±»æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç±»å…¶å®æ˜¯å…ƒç±»ï¼ˆmeteClassï¼‰çš„å®ä¾‹ã€‚å…ƒç±»å®šä¹‰äº†ç±»æ–¹æ³•çš„åˆ—è¡¨ã€‚ç±»é€šè¿‡ç±»çš„isaæŒ‡é’ˆæŒ‡å‘å…ƒç±»ã€‚</p>
</li>
<li><p>æ‰€æœ‰çš„å…ƒç±»æœ€ç»ˆç»§æ‰¿ä¸€ä¸ªæ ¹å…ƒç±»ï¼Œæ ¹å…ƒç±»isaæŒ‡é’ˆæŒ‡å‘æœ¬èº«ï¼Œå½¢æˆä¸€ä¸ªå°é—­çš„å†…å¾ªç¯ã€‚</p>
</li>
</ul>
<p>å…ƒç±»ä¿å­˜äº†<code>ç±»æ–¹æ³•</code>çš„åˆ—è¡¨ã€‚å½“ç±»æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå…ˆä¼šä»æœ¬èº«æŸ¥æ‰¾ç±»æ–¹æ³•çš„å®ç°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå…ƒç±»ä¼šå‘ä»–çˆ¶ç±»æŸ¥æ‰¾è¯¥æ–¹æ³•ã€‚</p>
<h4 id="loadä¸initialize">loadä¸initialize</h4><table>
<thead>
<tr>
<th></th>
<th>+ load</th>
<th>+ initialize</th>
</tr>
</thead>
<tbody>
<tr>
<td>è°ƒç”¨æ—¶æœº</td>
<td>è¢«æ·»åŠ åˆ° runtime æ—¶, é€šå¸¸å°±æ˜¯Appå¯åŠ¨æ—¶è¿›è¡ŒåŠ è½½</td>
<td>æ”¶åˆ°ç¬¬ä¸€æ¡æ¶ˆæ¯å‰(ä¸»åŠ¨ä½¿ç”¨è¯¥ç±»æ—¶)ï¼Œå¯èƒ½æ°¸è¿œä¸è°ƒç”¨</td>
</tr>
<tr>
<td>è°ƒç”¨é¡ºåº</td>
<td>çˆ¶ç±»-&gt;å­ç±»-&gt;åˆ†ç±»</td>
<td>çˆ¶ç±»-&gt;å­ç±»</td>
</tr>
<tr>
<td>è°ƒç”¨æ¬¡æ•°</td>
<td>1æ¬¡</td>
<td>å¤šæ¬¡</td>
</tr>
<tr>
<td>æ˜¯å¦éœ€è¦æ˜¾å¼è°ƒç”¨çˆ¶ç±»å®ç°</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>æ˜¯å¦æ²¿ç”¨çˆ¶ç±»çš„å®ç°</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>åˆ†ç±»ä¸­çš„å®ç°</td>
<td>ç±»å’Œåˆ†ç±»éƒ½æ‰§è¡Œ</td>
<td>è¦†ç›–ç±»ä¸­çš„æ–¹æ³•ï¼Œåªæ‰§è¡Œåˆ†ç±»çš„å®ç°</td>
</tr>
<tr>
<td>å¸¸è§åº”ç”¨</td>
<td>runtime method swizzling</td>
<td>å¯ç”¨æ¥åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå¦‚å•ä¾‹æ¨¡å¼ã€‚</td>
</tr>
</tbody>
</table>
<h4 id="method_swizzling">method swizzling</h4><p>æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li>éœ€è¦åœ¨<code>+(void)load</code>æ–¹æ³•é‡Œ</li>
<li>ä½¿ç”¨<code>dispatch_once</code>åªäº¤æ¢ä¸€æ¬¡</li>
</ul>
<p>ç¤ºä¾‹ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">swizzling</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//loadæ–¹æ³•ä¼šåœ¨ç±»ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™è¢«è°ƒç”¨</span></span><br><span class="line"><span class="comment">//è°ƒç”¨çš„æ—¶é—´æ¯”è¾ƒé å‰ï¼Œé€‚åˆåœ¨è¿™ä¸ªæ–¹æ³•é‡Œåšæ–¹æ³•äº¤æ¢</span></span><br><span class="line">+ (<span class="keyword">void</span>)load&#123;</span><br><span class="line">    <span class="comment">//æ–¹æ³•äº¤æ¢åº”è¯¥è¢«ä¿è¯ï¼Œåœ¨ç¨‹åºä¸­åªä¼šæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">//è·å¾—viewControllerçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„selector</span></span><br><span class="line">        SEL systemSel = <span class="keyword">@selector</span>(viewWillAppear:);</span><br><span class="line">        <span class="comment">//è‡ªå·±å®ç°çš„å°†è¦è¢«äº¤æ¢çš„æ–¹æ³•çš„selector</span></span><br><span class="line">        SEL swizzSel = <span class="keyword">@selector</span>(swiz_viewWillAppear:);</span><br><span class="line">        <span class="comment">//ä¸¤ä¸ªæ–¹æ³•çš„Method</span></span><br><span class="line">        Method systemMethod = class_getInstanceMethod([<span class="keyword">self</span> class], systemSel);</span><br><span class="line">        Method swizzMethod = class_getInstanceMethod([<span class="keyword">self</span> class], swizzSel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é¦–å…ˆåŠ¨æ€æ·»åŠ æ–¹æ³•ï¼Œå®ç°æ˜¯è¢«äº¤æ¢çš„æ–¹æ³•ï¼Œè¿”å›å€¼è¡¨ç¤ºæ·»åŠ æˆåŠŸè¿˜æ˜¯å¤±è´¥</span></span><br><span class="line">        <span class="built_in">BOOL</span> isAdd = class_addMethod(<span class="keyword">self</span>, systemSel, method_getImplementation(swizzMethod), method_getTypeEncoding(swizzMethod));</span><br><span class="line">        <span class="keyword">if</span> (isAdd) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæˆåŠŸï¼Œè¯´æ˜ç±»ä¸­ä¸å­˜åœ¨è¿™ä¸ªæ–¹æ³•çš„å®ç°</span></span><br><span class="line">            <span class="comment">//å°†è¢«äº¤æ¢æ–¹æ³•çš„å®ç°æ›¿æ¢åˆ°è¿™ä¸ªå¹¶ä¸å­˜åœ¨çš„å®ç°</span></span><br><span class="line">            class_replaceMethod(<span class="keyword">self</span>, swizzSel, method_getImplementation(systemMethod), method_getTypeEncoding(systemMethod));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œäº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°</span></span><br><span class="line">            method_exchangeImplementations(systemMethod, swizzMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)swiz_viewWillAppear:(<span class="built_in">BOOL</span>)animated&#123;</span><br><span class="line">    <span class="comment">//è¿™æ—¶å€™è°ƒç”¨è‡ªå·±ï¼Œçœ‹èµ·æ¥åƒæ˜¯æ­»å¾ªç¯</span></span><br><span class="line">    <span class="comment">//ä½†æ˜¯å…¶å®è‡ªå·±çš„å®ç°å·²ç»è¢«æ›¿æ¢äº†</span></span><br><span class="line">    [<span class="keyword">self</span> swiz_viewWillAppear:animated];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"swizzle"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<h4 id="å…³è”å¯¹è±¡AssociatedObject">å…³è”å¯¹è±¡AssociatedObject</h4><p>å¸¸ç”¨äºå¯¹è±¡åŠ¨æ€æ·»åŠ å±æ€§</p>
<ul>
<li>ç”¨ç»™å®šçš„keyå’Œpolicyæ¥ä¸ºæŒ‡å®šå¯¹è±¡(object)è®¾ç½®å…³è”å¯¹è±¡å€¼(value)</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_setAssociatedObject</span>(<span class="params">id <span class="keyword">object</span>, <span class="keyword">const</span> <span class="keyword">void</span> *key, id <span class="keyword">value</span>, objc_AssociationPolicy policy</span>)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æ ¹æ®ç»™å®šçš„keyä»æŒ‡å®šå¯¹è±¡(object)ä¸­è·å–ç›¸å¯¹åº”çš„å…³è”å¯¹è±¡å€¼</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> objc_getAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span><br></pre></td></tr></table></figure>
<ul>
<li>ç§»é™¤æŒ‡å®šå¯¹è±¡çš„å…¨éƒ¨å…³è”å¯¹è±¡</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void <span class="function"><span class="title">objc_removeAssociatedObjects</span><span class="params">(id object)</span></span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li><code>*key</code>:ä½¿ç”¨<code>static char kAssociatedObjectKey</code> (&amp;kAssociatedObjectKey) æˆ–è€… @selector(associatedObject)ï¼<code>_cmd</code></li>
</ul>
<p>ç¤ºä¾‹: ä¸ºUITableViewå¢åŠ ä¸€ä¸ªå±æ€§cellHeight</p>
<ul>
<li><code>AssociationPolicy</code>:</li>
</ul>
<p>å®šä¹‰</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">enum &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>, //ç»™å…³è”å¯¹è±¡æŒ‡å®šå¼±å¼•ç”¨,ç›¸å½“äº@<span class="keyword">property</span><span class="title"></span>(assign)æˆ–@<span class="keyword">property</span><span class="title"></span>(unsafe_unretained)</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, //ç»™å…³è”å¯¹è±¡æŒ‡å®šéåŸå­çš„å¼ºå¼•ç”¨,ç›¸å½“äº@<span class="keyword">property</span><span class="title"></span>(nonatomic,strong)æˆ–@<span class="keyword">property</span><span class="title"></span>(nonatomic,retain)</span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>, //ç»™å…³è”å¯¹è±¡æŒ‡å®šéåŸå­çš„copyç‰¹æ€§,ç›¸å½“äº@<span class="keyword">property</span><span class="title"></span>(nonatomic,copy)</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>, //ç»™å…³è”å¯¹è±¡æŒ‡å®šåŸå­å¼ºå¼•ç”¨,ç›¸å½“äº@<span class="keyword">property</span><span class="title"></span>(atomic,strong)æˆ–@<span class="keyword">property</span><span class="title"></span>(atomic,retain)</span><br><span class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span> //ç»™å…³è”å¯¹è±¡æŒ‡å®šåŸå­copyç‰¹æ€§,ç›¸å½“äº@<span class="keyword">property</span><span class="title"></span>(atomic,copy)</span><br><span class="line">&#125;;</span><br><span class="line">typedef uintptr_t objc_AssociationPolicy;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UITableView+Height.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableView</span> (<span class="title">Height</span>)</span></span><br><span class="line"><span class="comment">/** height */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> cellHeight;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//UITableView+Height.m</span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"UITableView+HeightManager.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UITableView</span> (<span class="title">Height</span>)</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)setCellHeight:(<span class="built_in">CGFloat</span>)cellHeight &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(cellHeight), @(cellHeight), OBJC_ASSO<span class="built_in">CIATION_ASSIGN_NONATOMIC</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)cellHeight &#123;</span><br><span class="line">    <span class="built_in">NSNumber</span> * number = objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">    <span class="keyword">return</span> number<span class="variable">.floatValue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>_cmd</code>åœ¨Objective-Cçš„æ–¹æ³•ä¸­è¡¨ç¤ºå½“å‰æ–¹æ³•çš„selector</p>
</blockquote>
<h4 id="éå†ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜å˜é‡_class_copyIvarList">éå†ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜å˜é‡ class_copyIvarList</h4><p>æœ‰æ—¶å€™æˆ‘ä»¬è¦å¯¹ä¸€äº›ä¿¡æ¯è¿›è¡Œå½’æ¡£ï¼Œå¦‚ç”¨æˆ·ä¿¡æ¯ç±»UserInfoï¼Œè¿™å°†éœ€è¦é‡å†™initWithCoderå’ŒencodeWithCoderæ–¹æ³•ï¼Œå¹¶å¯¹æ¯ä¸ªå±æ€§è¿›è¡Œencodeå’Œdecodeæ“ä½œã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå½“å±æ€§åªæœ‰å‡ ä¸ªçš„æ—¶å€™å¯ä»¥è½»æ¾å†™å®Œï¼Œå¦‚æœæœ‰å‡ åä¸ªå±æ€§å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ ç”¨runtimeæä¾›çš„å‡½æ•°éå†Modelè‡ªèº«æ‰€æœ‰å±æ€§ï¼Œå¹¶å¯¹å±æ€§è¿›è¡Œencodeå’Œdecodeæ“ä½œã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount;</span><br><span class="line">        <span class="comment">//è·å¾—æ‰€ä¼ å…¥ç±»çš„æˆå‘˜å˜é‡</span></span><br><span class="line">        Ivar *ivars = class_copyIvarList([<span class="keyword">self</span> class], &amp;outCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">            Ivar ivar = ivars[i];</span><br><span class="line">            <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</span><br><span class="line">            [<span class="keyword">self</span> setValue:[aDecoder decodeObjectForKey:key] forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">        free(ivars);<span class="comment">//åˆ«å¿˜è®°é‡Šæ”¾</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount;</span><br><span class="line">    Ivar *ivars = class_copyIvarList([<span class="keyword">self</span> class], &amp;outCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</span><br><span class="line">        [aCoder encodeObject:[<span class="keyword">self</span> valueForKey:key] forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    free(ivars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åŒç†ï¼Œå­—å…¸è½¬æ¨¡å‹ç”¨çš„ä¹Ÿæ˜¯è¿™ç§æ–¹æ³•ã€‚</p>
</blockquote>
<h4 id="è®¿é—®è‹¹æœç§æœ‰å±æ€§_class_copyPropertyList">è®¿é—®è‹¹æœç§æœ‰å±æ€§ class_copyPropertyList</h4><p>åˆ©ç”¨runtimeè·å–ç§æœ‰å±æ€§å</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œæƒ³æ”¹å˜è¾“å…¥æ¡†ä¸­å ä½æ–‡å­—çš„é¢œè‰²ï¼Œç”¨runtimeçš„è¿™ä¸ªä½œç”¨å¯ä»¥è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿çš„å®ç°ï¼š</p>
<p>å…ˆå°†è¾“å…¥æ¡†æ‰€åŒ…å«çš„å±æ€§æ‰“å°å‡ºæ¥ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)getProperties &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">objc_property_t</span> *properties = class_copyPropertyList([UITextField <span class="keyword">class</span>], &amp;count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;count; i++) &#123;</span><br><span class="line">        <span class="comment">// å–å‡ºå±æ€§</span></span><br><span class="line">        <span class="keyword">objc_property_t</span> property = properties[i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å°å±æ€§åå­—</span></span><br><span class="line">        NSLog(@<span class="string">"%s   &lt;----&gt;   %s"</span>, property_getName(property), property_getAttributes(property));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(properties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€ä¸ªå±æ€§ï¼š<br><img src="http://static.open-open.com/lib/uploadImg/20161218/20161218094612_594.png" alt=""></p>
<p>é¡¾åæ€ä¹‰ï¼Œè¿™å°±æ˜¯å ä½çš„Labelï¼Œæˆ‘ä»¬åªè¦åˆ©ç”¨KVCå°±å¯ä»¥å°†å…¶æ”¹æˆæˆ‘ä»¬æƒ³è¦çš„æ ·å­ï¼š</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="literal">self</span> <span class="built_in">set</span>Value:[UIColor whiteColor] <span class="keyword">for</span>KeyPath:@<span class="string">"_placeholderLabel.textColor"</span>];</span><br></pre></td></tr></table></figure>
<h4 id="ç±»ç°‡Class_Clustersä¸runtime">ç±»ç°‡Class Clustersä¸runtime</h4><p>ç±»ç°‡æ˜¯æŠ½è±¡å·¥å‚æ¨¡å¼åœ¨iOSä¸‹çš„ä¸€ç§å®ç°ï¼Œä¼—å¤šå¸¸ç”¨ç±»ï¼Œå¦‚NSStringï¼ŒNSArrayï¼ŒNSDictionaryï¼ŒNSNumberéƒ½è¿ä½œåœ¨è¿™ä¸€æ¨¡å¼ä¸‹ï¼Œå®ƒæ˜¯æ¥å£ç®€å•æ€§å’Œæ‰©å±•æ€§çš„æƒè¡¡ä½“ç°ï¼Œåœ¨æˆ‘ä»¬å®Œå…¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ï¼Œå·å·éšè—äº†å¾ˆå¤šå…·ä½“çš„å®ç°ç±»ï¼Œåªæš´éœ²å‡ºç®€å•çš„æ¥å£ã€‚è€Œåˆ©ç”¨runtimeçš„NSClassFromStringå¯ä»¥åŠ¨æ€åœ°å®ç°ç±»ç°‡åº”ç”¨ã€‚</p>
<h6 id="runtimeâ€“NSClassFromString_ç»“åˆç±»ç°‡åº”ç”¨ç¤ºä¾‹">runtimeâ€“NSClassFromString ç»“åˆç±»ç°‡åº”ç”¨ç¤ºä¾‹</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¦æ±‚å®ç°ï¼šiOS7æ˜¾ç¤ºç§æœ‰ç±»Açš„viewAï¼ŒiOS8-10æ˜¾ç¤ºç§æœ‰ç±»Bçš„viewBï¼ŒiOS11æ˜¾ç¤ºç§æœ‰ç±»Cçš„viewC</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ClusterView</span> : <span class="title">UIView</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨ClusterView.mé‡Œåˆ›å»º3ä¸ªç§æœ‰ç±»ï¼šViewAã€ViewBã€ViewC</span></span><br><span class="line"><span class="comment">//ClustersView.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ClusterView</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//1.å¸¸è§„æ–¹æ³•ï¼šåœ¨ClusterView.mä¸­é‡å†™allocçš„æ–¹æ³•</span></span><br><span class="line">+ (instancetype)alloc&#123;</span><br><span class="line">    <span class="keyword">if</span>([<span class="keyword">self</span> class] == [ClusterView class]) &#123;</span><br><span class="line">        <span class="keyword">float</span> v = [[[<span class="built_in">UIDevice</span> currentDevice] systemVersion] floatValue];</span><br><span class="line">        <span class="keyword">if</span>(v &lt;= <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="comment">//iOS7</span></span><br><span class="line">            <span class="keyword">return</span> [ViewA alloc];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(v &gt;= <span class="number">8</span> &amp;&amp; v &lt;= <span class="number">10</span> ) &#123;</span><br><span class="line">            <span class="comment">//iOS8-10</span></span><br><span class="line">            <span class="keyword">return</span> [ViewB alloc];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//iOS11</span></span><br><span class="line">            <span class="keyword">return</span> [ViewC alloc];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> alloc];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2.åˆ©ç”¨runtimeï¼Œé‡å†™initæ–¹æ³•</span></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        <span class="keyword">float</span> v = [[[<span class="built_in">UIDevice</span> currentDevice] systemVersion] floatValue];</span><br><span class="line">        <span class="built_in">NSString</span> *className = <span class="string">@"ViewC"</span>;</span><br><span class="line">        <span class="keyword">if</span>(v &lt;= <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="comment">//iOS7</span></span><br><span class="line">            className = <span class="string">@"ViewA"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(v &gt;= <span class="number">8</span> &amp;&amp; v &lt;= <span class="number">10</span> ) &#123;</span><br><span class="line">            <span class="comment">//iOS8-10</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">@"ViewB"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class class = <span class="built_in">NSClassFromString</span>(className);</span><br><span class="line">        <span class="keyword">self</span> = [[class alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for iOS7</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewA</span> : <span class="title">ClusterView</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewA</span></span></span><br><span class="line">- (<span class="keyword">void</span>)drawRect: (<span class="built_in">CGRect</span>)rect&#123;</span><br><span class="line">    <span class="comment">/* Custom iOS7 drawing code */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for iOS8-10</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewB</span> : <span class="title">ClusterView</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewB</span></span></span><br><span class="line">- (<span class="keyword">void</span>)drawRect: (<span class="built_in">CGRect</span>)rect&#123;</span><br><span class="line">    <span class="comment">/* Custom iOS8-11 drawing code */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for iOS11</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewC</span> : <span class="title">ClusterView</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewC</span></span></span><br><span class="line">- (<span class="keyword">void</span>)drawRect: (<span class="built_in">CGRect</span>)rect&#123;</span><br><span class="line">    <span class="comment">/* Custom iOS11 drawing code */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h6 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h6><blockquote>
<p><a href="https://juejin.im/entry/59888a8d6fb9a03c5e4408a3" target="_blank" rel="external">https://juejin.im/entry/59888a8d6fb9a03c5e4408a3</a><br><a href="https://github.com/maligh/ML-Objective-C-Demo/blob/master/MessageForwarding" target="_blank" rel="external">https://github.com/maligh/ML-Objective-C-Demo/blob/master/MessageForwarding</a><br><a href="http://blog.csdn.net/yst19910702/article/details/51443901" target="_blank" rel="external">http://blog.csdn.net/yst19910702/article/details/51443901</a><br><a href="https://www.jianshu.com/p/8036f15c91c6" target="_blank" rel="external">https://www.jianshu.com/p/8036f15c91c6</a><br><a href="http://blog.devzeng.com/blog/ios-class-cluster-design-pattern.html" target="_blank" rel="external">http://blog.devzeng.com/blog/ios-class-cluster-design-pattern.html</a><br><a href="http://www.cocoachina.com/ios/20150104/10826.html" target="_blank" rel="external">http://www.cocoachina.com/ios/20150104/10826.html</a><br><a href="http://nshipster.com/method-swizzling/" target="_blank" rel="external">http://nshipster.com/method-swizzling/</a><br><a href="http://nshipster.com/associated-objects/" target="_blank" rel="external">http://nshipster.com/associated-objects/</a><br><a href="http://blog.devzeng.com/blog/oc-associated-objects.html" target="_blank" rel="external">http://blog.devzeng.com/blog/oc-associated-objects.html</a><br><a href="https://www.jianshu.com/p/872447c6dc3f" target="_blank" rel="external">https://www.jianshu.com/p/872447c6dc3f</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h4 id="ç®€ä»‹">ç®€ä»‹</h4><p>Objective-C æ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œå®ƒçš„åŠ¨æ€æ€§ä½“ç°åœ¨å®ƒå°†å¾ˆå¤šç¼–è¯‘å’Œé“¾æ¥æ—¶åšçš„äº‹æ¨å»¶åˆ°è¿è¡Œæ—¶å¤„ç†ï¼Œè€Œè¿™ä¸€æœºåˆ¶ä¸»è¦ä¾èµ–ç³»ç»Ÿæä¾›çš„ runtime åº“ã€‚åˆ©ç”¨ runtime åº“ï¼Œæˆ‘ä»¬èƒ½åœ¨è¿è¡Œæ—¶åšå¾ˆå¤šäº‹ï¼Œä¾‹å¦‚ objc_setAssocia]]>
    </summary>
    
      <category term="Objective-C" scheme="https://litt1e-p.github.io/tags/Objective-C/"/>
    
      <category term="Runtime" scheme="https://litt1e-p.github.io/tags/Runtime/"/>
    
      <category term="method swizzling" scheme="https://litt1e-p.github.io/tags/method-swizzling/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Timer]]></title>
    <link href="https://litt1e-p.github.io/2017/03/04/Timer/"/>
    <id>https://litt1e-p.github.io/2017/03/04/Timer/</id>
    <published>2017-03-04T11:17:57.000Z</published>
    <updated>2018-03-04T11:19:36.812Z</updated>
    <content type="html"><![CDATA[<h2 id="å®šæ—¶å™¨">å®šæ—¶å™¨</h2><h4 id="1-_RunLoopå®šæ—¶å™¨">1. RunLoopå®šæ—¶å™¨</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¬¬ä¸€ç§æ–¹æ³• æ‰‹åŠ¨åŠ å…¥runloop</span></span><br><span class="line">NSTimer *timer = [NSTimer <span class="string">timerWithTimeInterval:</span><span class="number">2.0</span> <span class="string">target:</span>self <span class="string">selector:</span><span class="annotation">@selector</span>(action) <span class="string">userInfo:</span>nil <span class="string">repeats:</span>YES];</span><br><span class="line"></span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>NSDefaultRunLoopMode];<span class="comment">//é»˜è®¤æ¨¡å¼</span></span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>UITrackingRunLoopMode];<span class="comment">//é¡µé¢è¿½è¸ªæ¨¡å¼</span></span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>NSRunLoopCommonModes]; <span class="comment">//commonæ¨¡å¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¬¬äºŒç§æ–¹æ³• è‡ªåŠ¨åŠ å…¥runloop(NSDefaultRunLoopMode)</span></span><br><span class="line">NSTimer *timer = [NSTimer <span class="string">scheduledTimerWithTimeInterval:</span><span class="number">2.0</span> <span class="string">target:</span>self <span class="string">selector:</span><span class="annotation">@selector</span>(<span class="string">action:</span>) <span class="string">userInfo:</span>nil <span class="string">repeats:</span>NO];</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡Šæ”¾</span></span><br><span class="line">[timer invalidate];</span><br></pre></td></tr></table></figure>
<h6 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h6><ul>
<li>å­˜åœ¨å»¶è¿Ÿ</li>
</ul>
<p>ä¸ç®¡æ˜¯ä¸€æ¬¡æ€§çš„è¿˜æ˜¯å‘¨æœŸæ€§çš„timerçš„å®é™…è§¦å‘äº‹ä»¶çš„æ—¶é—´ï¼Œéƒ½ä¼šä¸æ‰€åŠ å…¥çš„RunLoopå’ŒRunLoop Modeæœ‰å…³ï¼Œå¦‚æœæ­¤RunLoopæ­£åœ¨æ‰§è¡Œä¸€ä¸ªè¿ç»­æ€§çš„è¿ç®—ï¼Œtimerå°±ä¼šè¢«å»¶æ—¶å‡ºå‘ã€‚é‡å¤æ€§çš„timeré‡åˆ°è¿™ç§æƒ…å†µï¼Œå¦‚æœå»¶è¿Ÿè¶…è¿‡äº†ä¸€ä¸ªå‘¨æœŸï¼Œåˆ™ä¼šåœ¨å»¶æ—¶ç»“æŸåç«‹åˆ»æ‰§è¡Œï¼Œå¹¶æŒ‰ç…§ä¹‹å‰æŒ‡å®šçš„å‘¨æœŸç»§ç»­æ‰§è¡Œã€‚</p>
<ul>
<li>å¿…é¡»åŠ å…¥Runloop(æ‰‹åŠ¨æˆ–è‡ªåŠ¨)</li>
</ul>
<h4 id="2-_GCDå®šæ—¶å™¨">2. GCDå®šæ—¶å™¨</h4><ul>
<li>å¾ªç¯timer</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> 1.åˆ›å»ºGCDä¸­çš„å®šæ—¶å™¨</span><br><span class="line"> <span class="doctag">@param</span> DISPATCH_SOURCE_TYPE_TIMER sourceçš„ç±»å‹ï¼Œè¡¨ç¤ºæ˜¯å®šæ—¶å™¨</span><br><span class="line"> <span class="doctag">@param</span> 0 æè¿°ä¿¡æ¯ï¼Œçº¿ç¨‹ID</span><br><span class="line"> <span class="doctag">@param</span> 0 æ›´è¯¦ç»†çš„æè¿°ä¿¡æ¯</span><br><span class="line"> <span class="doctag">@param</span> dispatchQueue é˜Ÿåˆ—ï¼Œç¡®å®šGCDå®šæ—¶å™¨ä¸­çš„ä»»åŠ¡åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ</span><br><span class="line"> */</span></span><br><span class="line">dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> 2.è®¾ç½®å®šæ—¶å™¨ï¼ˆèµ·å§‹æ—¶é—´|é—´éš”æ—¶é—´|ç²¾å‡†åº¦ï¼‰</span><br><span class="line"> <span class="doctag">@param</span> timer å®šæ—¶å™¨å¯¹è±¡</span><br><span class="line"> <span class="doctag">@param</span> DISPATCH_TIME_NOW èµ·å§‹æ—¶é—´ï¼ŒDISPATCH_TIME_NOW ä»ç°åœ¨å¼€å§‹è®¡æ—¶</span><br><span class="line"> <span class="doctag">@param</span> intervalInSeconds * NSEC_PER_SEC é—´éš”æ—¶é—´</span><br><span class="line"> <span class="doctag">@param</span> leewayInSeconds * NSEC_PER_SEC ç²¾å‡†åº¦ï¼Œç»å¯¹ç²¾å‡†0</span><br><span class="line"> */</span></span><br><span class="line">dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, <span class="number">2.0</span> * NSEC_PER_SEC, <span class="number">0</span> * NSEC_PER_SEC);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.è®¾ç½®å®šæ—¶å™¨æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">    NSLog(@<span class="string">"------------%@"</span>, [NSThread currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.å¯åŠ¨æ‰§è¡Œ</span></span><br><span class="line">dispatch_resume(timer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.æš‚åœ</span></span><br><span class="line">dispatch_suspend(timer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.é‡Šæ”¾</span></span><br><span class="line">dispatch_source_cancel(timer);</span><br></pre></td></tr></table></figure>
<ul>
<li>å•æ¬¡timer</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">dispatch_after</span>(<span class="function">dispatch_time</span>(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * NSEC_PER_SEC)), <span class="tag">dispatch_get_main_queue</span>(), ^(void)&#123;</span><br><span class="line">    <span class="attr_selector">[self action]</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h6 id="ç‰¹ç‚¹-1">ç‰¹ç‚¹</h6><p>GCDå®šæ—¶å™¨å’ŒNSTimeræ˜¯ä¸ä¸€æ ·çš„ï¼ŒNSTimerå—RunLoopå½±å“ï¼Œä½†æ˜¯GCDçš„å®šæ—¶å™¨ä¸å—å½±å“ï¼Œå› ä¸ºé€šè¿‡æºç å¯çŸ¥RunLoopä¹Ÿæ˜¯åŸºäºGCDçš„å®ç°çš„ï¼Œæ‰€ä»¥GCDå®šæ—¶å™¨æœ‰éå¸¸é«˜çš„ç²¾åº¦</p>
<h4 id="3-_CADisplayLink">3. CADisplayLink</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CADisplayLink *displayLink = [CADisplayLink <span class="string">displayLinkWithTarget:</span>self <span class="string">selector:</span><span class="annotation">@selector</span>(<span class="string">action:</span>)];  </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯éš”2å¸§è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">displayLink.frameInterval = <span class="number">2</span>;  </span><br><span class="line"></span><br><span class="line">[displayLink <span class="string">addToRunLoop:</span>[NSRunLoop currentRunLoop] <span class="string">forMode:</span>NSDefaultRunLoopMode];</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾</span></span><br><span class="line">[displayLink invalidate];</span><br></pre></td></tr></table></figure>
<h6 id="ç‰¹ç‚¹-2">ç‰¹ç‚¹</h6><ul>
<li>åˆ·æ–°é¢‘ç‡å›ºå®š</li>
</ul>
<p>æ­£å¸¸æƒ…å†µiOSè®¾å¤‡çš„å±å¹•åˆ·æ–°é¢‘ç‡æ˜¯å›ºå®š60Hz,å¦‚æœCPUè¿‡äºç¹å¿™ï¼Œæ— æ³•ä¿è¯å±å¹•60æ¬¡/ç§’çš„åˆ·æ–°ç‡ï¼Œå°±ä¼šå¯¼è‡´è·³è¿‡è‹¥å¹²æ¬¡è°ƒç”¨å›è°ƒæ–¹æ³•çš„æœºä¼šï¼Œè·³è¿‡æ¬¡æ•°å–å†³CPUçš„å¿™ç¢Œç¨‹åº¦ã€‚</p>
<ul>
<li>å±å¹•åˆ·æ–°æ—¶è°ƒç”¨</li>
</ul>
<p>CADisplayLinkåœ¨æ­£å¸¸æƒ…å†µä¸‹ä¼šåœ¨æ¯æ¬¡åˆ·æ–°ç»“æŸéƒ½è¢«è°ƒç”¨ï¼Œç²¾ç¡®åº¦ç›¸å½“é«˜ã€‚ä½†å¦‚æœè°ƒç”¨çš„æ–¹æ³•æ¯”è¾ƒè€—æ—¶ï¼Œè¶…è¿‡äº†å±å¹•åˆ·æ–°å‘¨æœŸï¼Œå°±ä¼šå¯¼è‡´è·³è¿‡è‹¥å¹²æ¬¡å›è°ƒè°ƒç”¨æœºä¼š</p>
<ul>
<li>é€‚åˆåšç•Œé¢æ¸²æŸ“</li>
</ul>
<p>CADisplayLinkå¯ä»¥ç¡®ä¿ç³»ç»Ÿæ¸²æŸ“æ¯ä¸€å¸§çš„æ—¶å€™æˆ‘ä»¬çš„æ–¹æ³•éƒ½è¢«è°ƒç”¨ï¼Œä»è€Œä¿è¯äº†åŠ¨ç”»çš„æµç•…æ€§</p>
<hr>
<h6 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h6><blockquote>
<p><a href="https://www.jianshu.com/p/21d351116587" target="_blank" rel="external">https://www.jianshu.com/p/21d351116587</a><br><a href="http://www.bijishequ.com/detail/234634" target="_blank" rel="external">http://www.bijishequ.com/detail/234634</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="å®šæ—¶å™¨">å®šæ—¶å™¨</h2><h4 id="1-_RunLoopå®šæ—¶å™¨">1. RunLoopå®šæ—¶å™¨</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span clas]]>
    </summary>
    
      <category term="RunLoop" scheme="https://litt1e-p.github.io/tags/RunLoop/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Singleton]]></title>
    <link href="https://litt1e-p.github.io/2017/01/05/Singleton/"/>
    <id>https://litt1e-p.github.io/2017/01/05/Singleton/</id>
    <published>2017-01-05T12:52:38.000Z</published>
    <updated>2018-03-07T12:32:59.948Z</updated>
    <content type="html"><![CDATA[<h4 id="Objective-C">Objective-C</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Singleton.h</span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Singleton</span> : <span class="title">NSObject</span>&lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line">+(instancetype)shared;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Singleton.m</span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Singleton.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Singleton</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Singleton *_instance = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">+ (instancetype)shared &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken,^&#123;</span><br><span class="line">        _instance = [[<span class="keyword">super</span> allocWithZone:<span class="literal">NULL</span>]init];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">id</span>)allocWithZone:(<span class="keyword">struct</span> _<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    <span class="keyword">return</span> [Singleton shared];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    <span class="keyword">return</span> [Singleton shared];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>è®°å¾—éµå¾ªNSCopyingåè®®</p>
</blockquote>
<h4 id="Swift">Swift</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Can't init is singleton</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">init</span>() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shared = <span class="type">Singleton</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Singleton_å®">Singleton å®</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">//for .h</span><br><span class="line"><span class="comment">#define SYNTHESIZE_SINGLETON_FOR_HEADER(classname)\</span></span><br><span class="line">+ (classname *)shared<span class="comment">##classname;</span></span><br><span class="line"></span><br><span class="line">//</span><span class="keyword">for</span> .m</span><br><span class="line"><span class="comment">#define SYNTHESIZE_SINGLETON_FOR_CLASS(classname) \</span></span><br><span class="line"><span class="string">\</span></span><br><span class="line">static classname *shared<span class="comment">##classname = nil; \</span></span><br><span class="line"><span class="string">\</span></span><br><span class="line">+ (classname *)shared<span class="comment">##classname \</span></span><br><span class="line">&#123; <span class="string">\</span></span><br><span class="line"><span class="property">@synchronized</span>(self) <span class="string">\</span></span><br><span class="line">&#123; <span class="string">\</span></span><br><span class="line"><span class="keyword">if</span> (shared<span class="comment">##classname == nil) \</span></span><br><span class="line">&#123; <span class="string">\</span></span><br><span class="line">shared<span class="comment">##classname = [[super allocWithZone:NULL] init]; \</span></span><br><span class="line">&#125; <span class="string">\</span></span><br><span class="line">&#125; <span class="string">\</span></span><br><span class="line"><span class="string">\</span></span><br><span class="line"><span class="keyword">return</span> shared<span class="comment">##classname; \</span></span><br><span class="line">&#125; <span class="string">\</span></span><br><span class="line"><span class="string">\</span></span><br><span class="line">+ (id)<span class="attribute">allocWithZone</span>:(NSZone *)zone <span class="string">\</span></span><br><span class="line">&#123; <span class="string">\</span></span><br><span class="line"><span class="keyword">return</span> [self shared<span class="comment">##classname];\</span></span><br><span class="line">&#125; <span class="string">\</span></span><br><span class="line"><span class="string">\</span></span><br><span class="line">- (id)<span class="attribute">copyWithZone</span>:(NSZone *)zone <span class="string">\</span></span><br><span class="line">&#123; <span class="string">\</span></span><br><span class="line"><span class="keyword">return</span> self; <span class="string">\</span></span><br><span class="line">&#125; <span class="string">\</span></span><br><span class="line"><span class="string">\</span></span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<h4 id="Objective-C">Objective-C</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br>]]>
    </summary>
    
      <category term="Objective-C" scheme="https://litt1e-p.github.io/tags/Objective-C/"/>
    
      <category term="Singleton" scheme="https://litt1e-p.github.io/tags/Singleton/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[GCD]]></title>
    <link href="https://litt1e-p.github.io/2016/12/29/GCD/"/>
    <id>https://litt1e-p.github.io/2016/12/29/GCD/</id>
    <published>2016-12-29T13:18:27.000Z</published>
    <updated>2018-03-07T12:53:05.893Z</updated>
    <content type="html"><![CDATA[<h4 id="é˜Ÿåˆ—_Dispatch_Queue">é˜Ÿåˆ— Dispatch Queue</h4><ul>
<li>ä¸²è¡Œé˜Ÿåˆ— Serial Dispatch Queue, å…ˆè¿›å…ˆå‡ºæ‰§è¡Œ(FIFO)</li>
<li>å¹¶è¡Œé˜Ÿåˆ— Concurrent Dispatch Queue</li>
</ul>
<blockquote>
<p>ä¸²è¡Œé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶è¡Œé˜Ÿåˆ—æœ‰å¤šä¸ªçº¿ç¨‹</p>
</blockquote>
<h4 id="å»ºç«‹Queue">å»ºç«‹Queue</h4><ul>
<li>è‡ªå»ºQueue</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_queue_create(<span class="string">"com.mac.queue"</span>, DISPATCH_QUEUE_SERIAL);<span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_queue_create(<span class="string">"com.mac.queue"</span>, DISPATCH_QUEUE_CONCURRENT);<span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ç³»ç»ŸQueue</li>
</ul>
<p>1.<code>Main Dispatch Queue</code>: åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„é˜Ÿåˆ—ã€‚å› ä¸ºä¸»çº¿ç¨‹åªæœ‰1ä¸ªï¼Œæ‰€ä»¥<code>Main Dispatch Queue</code>æ˜¯ä¸²è¡Œé˜Ÿåˆ—ã€‚åŠ å…¥åˆ°ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸€å®šä¸ä¼šç”Ÿæˆæ–°çš„çº¿ç¨‹ï¼Œå› ä¸ºä¸»é˜Ÿåˆ—å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€æ¡ä¸»çº¿ç¨‹ã€‚</p>
<p>2.<code>Global Dispatch Queue</code>: ä¸€ä¸ªæ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½èƒ½å¤Ÿä½¿ç”¨çš„å¹¶å‘é˜Ÿåˆ—ã€‚åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸ä¸€å®šä¼šç”Ÿæˆçº¿ç¨‹ã€‚å› ä¸ºæœ‰çº¿ç¨‹é‡ç”¨çš„ç°è±¡ã€‚</p>
<h4 id="dispatch_syncå’Œdispatch_async">dispatch_syncå’Œdispatch_async</h4><ul>
<li>dispatch_sync</li>
</ul>
<p>dispatch_syncå°†æŒ‡å®šçš„BlockåŒæ­¥çš„è¿½åŠ åˆ°æŒ‡å®šçš„Dispatch Queueã€‚æ­¤æ—¶dispatch_syncä¼šä¸€ç›´ç­‰å¾…Blockæ‰§è¡Œç»“æŸä¹‹åï¼Œæ‰ä¼šè¿”å›ã€‚çº¿ç¨‹æ‰èƒ½æ¥ç€ç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ã€‚</p>
<ul>
<li>dispatch_async</li>
</ul>
<p>dispatch_asyncå°†æŒ‡å®šçš„Blockå¼‚æ­¥çš„è¿½åŠ åˆ°æŒ‡å®šçš„Dispatch Queueä¸­ã€‚dispatch_asyncå‡½æ•°ä¸ä¼šåšä»»ä½•ç­‰å¾…ã€‚<br>dispatch_asyncä»£è¡¨å¼‚æ­¥ä»»åŠ¡ï¼Œæ„æ€ä¸æ˜¯ä¸€å®šä¼šç”Ÿæˆä¸€æ¡çº¿ç¨‹ã€‚å¦‚æœåœ¨MainQueueä¸­æ‰§è¡Œï¼Œåˆ™ä¸ä¼šç”Ÿæˆçº¿ç¨‹ï¼›å¦‚æœåœ¨Global Queueä¸­æœ‰å¯èƒ½ä¼šç”Ÿæˆã€‚å› ä¸ºçº¿ç¨‹æœ‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¼šé‡ç”¨å·²ç»å®Œæˆä»»åŠ¡äº†çš„çº¿ç¨‹ã€‚</p>
<h4 id="ä»»åŠ¡ç»„_Dispatch_Group">ä»»åŠ¡ç»„ Dispatch Group</h4><p><code>dispatch_group</code>æ˜¯GCDçš„ä¸€é¡¹ç‰¹æ€§ï¼Œèƒ½å¤ŸæŠŠä»»åŠ¡åˆ†ç»„ã€‚è°ƒç”¨è€…å¯ä»¥ç­‰å¾…è¿™ç»„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿå¯ä»¥æä¾›å›è°ƒå‡½æ•°ä¹‹åç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè¿™ç»„ä»»åŠ¡å®Œæˆæ—¶ï¼Œè°ƒç”¨è€…ä¼šå¾—åˆ°é€šçŸ¥ã€‚å¸¸ç”¨åœºæ™¯æ¯”å¦‚è¯´ï¼Œä¸‹è½½ä¸€ä¸ªå¤§çš„æ–‡ä»¶ï¼Œåˆ†å—ä¸‹è½½ï¼Œå…¨éƒ¨ä¸‹è½½å®Œæˆåå†åˆæˆä¸€ä¸ªæ–‡ä»¶ã€‚å†æ¯”å¦‚åŒæ—¶ä¸‹è½½å¤šä¸ªå›¾ç‰‡ï¼Œç›‘å¬å…¨éƒ¨ä¸‹è½½å®Œåçš„åŠ¨ä½œã€‚</p>
<ul>
<li>åˆ›å»ºgroup</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch_group_t <span class="keyword">group</span> <span class="title">= dispatch_group_create</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li>æ·»åŠ ä»»åŠ¡</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°æŒ‡å®šgroupä¸­</span></span><br><span class="line">dispatch_group_async(<span class="keyword">dispatch_group_t</span> group, <span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span>, <span class="keyword">dispatch_block_t</span> block);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™ä¸¤ä¸ªå‡½æ•°åŒä¸Šè¾¹ä¸€æ ·çš„æ•ˆæœï¼Œä¸è¿‡ä¸€å®šè¦æ³¨æ„è¿™ä¸¤ä¸ªå‡½æ•°å¿…é¡»æˆå¯¹å‡ºç°ï¼å¦åˆ™è¿™ä¸€ç»„ä»»åŠ¡å°±æ°¸è¿œæ‰§è¡Œä¸å®Œã€‚</span></span><br><span class="line">dispatch_group_enter(<span class="keyword">dispatch_group_t</span> group);</span><br><span class="line">dispatch_group_leave(<span class="keyword">dispatch_group_t</span> group);</span><br></pre></td></tr></table></figure>
<ul>
<li>ç›‘å¬ä»»åŠ¡å®Œæˆ</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dispatch_group_notify(<span class="keyword">dispatch_group_t</span> group, <span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span>, <span class="keyword">dispatch_block_t</span> block);</span><br><span class="line"><span class="comment">//å¼€å‘è€…å¯ä»¥ä¼ å…¥blockï¼Œç­‰dispatch group æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå—ä¼šåœ¨ç‰¹å®šçš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè€Œä¸é˜»å¡çº¿ç¨‹ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">dispatch_group_wait</span><span class="params">(dispatch_group_t group, dispatch_time_t timeout)</span></span>;</span><br><span class="line"><span class="comment">//timeoutå‚æ•°è¡¨ç¤ºå‡½æ•°åœ¨ç­‰å¾…dispatch groupæ‰§è¡Œå®Œæ¯•åï¼Œåº”è¯¥é˜»å¡å¤šä¹…ã€‚å¦‚æœæ‰§è¡Œdispatch groupæ‰€éœ€çš„æ—¶é—´å°äºtimeoutï¼Œåˆ™è¿”å›0ï¼Œå¦åˆ™è¿”å›é0å€¼.æ­¤å‚æ•°å¯ä»¥å–å¸¸é‡DISPATCH_TIME_FOREVERï¼Œè¿™è¡¨ç¤ºå‡½æ•°ä¼šä¸€ç›´ç­‰ç€dispatch group æ‰§è¡Œå®Œï¼Œè€Œä¸ä¼šè¶…æ—¶ã€‚æ­¤æ–¹æ³•ä¼šé˜»å¡çº¿ç¨‹ã€‚</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">dispatch_group_tÂ <span class="keyword">group</span>Â = dispatch_group_create();</span><br><span class="line">dispatch_queue_tÂ globalQueue = dispatch_get_global_queue(<span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨¡æ‹Ÿå¤šçº¿ç¨‹è€—æ—¶æ“ä½œ1</span></span><br><span class="line">dispatch_group_enter(<span class="keyword">group</span>);</span><br><span class="line">dispatch_group_async(<span class="keyword">group</span>,Â globalQueue,Â ^&#123;Â Â Â Â </span><br><span class="line">    sleep(<span class="number">3</span>);Â Â Â Â </span><br><span class="line">    NSLog(@<span class="string">"%@---block1ç»“æŸ"</span>, [NSThreadÂ currentThread]);Â Â Â Â </span><br><span class="line">    dispatch_group_leave(<span class="keyword">group</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨¡æ‹Ÿå¤šçº¿ç¨‹è€—æ—¶æ“ä½œ2</span></span><br><span class="line">dispatch_group_enter(<span class="keyword">group</span>);</span><br><span class="line">dispatch_group_async(<span class="keyword">group</span>,Â globalQueue,Â ^&#123;Â Â Â Â </span><br><span class="line">    sleep(<span class="number">3</span>);Â Â Â Â </span><br><span class="line">    NSLog(@<span class="string">"%@---block2ç»“æŸ"</span>, [NSThreadÂ currentThread]);Â Â Â Â </span><br><span class="line">    dispatch_group_leave(<span class="keyword">group</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.ä½¿ç”¨dispatch_group_notify</span></span><br><span class="line">dispatch_group_notify(<span class="keyword">group</span>, dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    NSLog(@<span class="string">"%@---å…¨éƒ¨ç»“æŸ"</span>,[NSThread currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.ä½¿ç”¨dispatch_group_wait</span></span><br><span class="line">dispatch_group_wait(<span class="keyword">group</span>, DISPATCH_TIME_FOREVER) <span class="comment">// dispatch_group_waité˜»å¡å½“å‰è¿›ç¨‹ï¼Œä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆç›´åˆ°è¶…æ—¶ã€‚å¦‚æœä»»åŠ¡å®Œæˆå‰å°±è¶…æ—¶äº†ï¼Œå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œå¯ä»¥é€šè¿‡è¿”å›å€¼åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚ä¹Ÿå¯ä»¥ç”¨DISPATCH_TIME_FOREVERè¡¨ç¤ºä¸€ç›´ç­‰ã€‚</span></span><br><span class="line">NSLog(@<span class="string">"%@---å…¨éƒ¨ç»“æŸ"</span>,[NSThread currentThread]);</span><br></pre></td></tr></table></figure></p>
<h4 id="dispatch_set_target_queueè®¾ç½®ä¼˜å…ˆçº§">dispatch_set_target_queueè®¾ç½®ä¼˜å…ˆçº§</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†myQueueä¼˜å…ˆçº§è®¾ç½®ä¸ºä¸globalQueueç›¸åŒ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> myQueue = dispatch_queue_create(<span class="string">"com.gcd.queue"</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">dispatch_queue_t</span> globalQueue = dispatch_get_global_queue(QOS_CLASS_DEFAULT, <span class="number">0</span>);</span><br><span class="line">dispatch_set_target_queue(myQueue, globalQueue)</span><br></pre></td></tr></table></figure>
<h4 id="æ …æ (dispatch_barrier_syncå’Œdispatch_barrier_async)">æ …æ (dispatch_barrier_syncå’Œdispatch_barrier_async)</h4><p>ä½œç”¨ï¼šä¸å¹¶å‘é˜Ÿåˆ—ç»“åˆï¼Œå¯ä»¥é«˜æ•ˆç‡çš„é¿å…æ•°æ®ç«äº‰çš„é—®é¢˜</p>
<p>ç›¸åŒç‚¹ï¼š<code>dispatch_barrier_sync</code>å’Œ<code>dispatch_barrier_async</code>å‡½æ•°åŠŸèƒ½ä¸€æ ·å°±æ˜¯åœ¨å¹¶å‘é˜Ÿåˆ—ä¸­å°†æ­¤ä»£ç æ’å…¥çš„åœ°æ–¹ä¸Šä¸‹éš”å¼€ï¼Œå¦‚æœæ …æ ä¸€æ ·ï¼Œä¸¤éƒ¨åˆ†ä¸å½±å“ã€‚åªæœ‰ä¸Šè¾¹çš„å¹¶å‘é˜Ÿåˆ—éƒ½æ‰§è¡Œç»“æŸä¹‹åï¼Œä¸‹è¾¹çš„å¹¶å‘é˜Ÿåˆ—æ‰èƒ½å¤Ÿæ‰§è¡Œã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/1/16/160ff2d8cb6ef975?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p>
<p>ä¸åŒç‚¹:<code>dispatch_barrier_sync</code>ä»£ç åè¾¹çš„ä»»åŠ¡ç›´åˆ°<code>dispatch_barrier_sync</code>æ‰§è¡Œå®Œæ‰èƒ½è¢«è¿½åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼›<code>dispatch_barrier_async</code>ä¸ç”¨ä»£ç æ‰§è¡Œå®Œï¼Œåè¾¹çš„ä»»åŠ¡ä¹Ÿä¼šè¢«è¿½åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚ä»£ç ä¸Šçš„ä½“ç°å°±æ˜¯<code>dispatch_barrier_sync</code>åè¾¹çš„ä»£ç ä¸ä¼šæ‰§è¡Œï¼Œ<code>dispatch_barrier_async</code>åè¾¹çš„ä»£ç ä¼šæ‰§è¡Œï¼Œä½†æ˜¯Blockä¸ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>dispatch_barrier_asyncå‡½æ•°çš„ä½œç”¨ä¸barrierçš„æ„æ€ç›¸åŒ,åœ¨è¿›ç¨‹ç®¡ç†ä¸­èµ·åˆ°ä¸€ä¸ªæ …æ çš„ä½œç”¨,å®ƒç­‰å¾…æ‰€æœ‰ä½äºbarrierå‡½æ•°ä¹‹å‰çš„æ“ä½œæ‰§è¡Œå®Œæ¯•åæ‰§è¡Œ,å¹¶ä¸”åœ¨barrierå‡½æ•°æ‰§è¡Œä¹‹å,barrierå‡½æ•°ä¹‹åçš„æ“ä½œæ‰ä¼šå¾—åˆ°æ‰§è¡Œ,<code>è¯¥å‡½æ•°éœ€è¦åŒdispatch_queue_createå‡½æ•°ç”Ÿæˆçš„concurrent Dispatch Queueé˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨</code>ï¼Œå¦åˆ™ä¸dispatch_barrier_syncæ— å¼‚ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<ul>
<li>dispatch_barrier_sync</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŒdispatch_queue_createå‡½æ•°ç”Ÿæˆçš„concurrent Dispatch Queueé˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.barrier.async"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----1-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----2-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_barrier_sync(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----barrier-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"ğŸˆğŸˆğŸˆ"</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----3-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"ğŸ‰ğŸ‰ğŸ‰"</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----4-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:1 2 â€“&gt; barrier â€“&gt; ğŸˆğŸˆğŸˆ ğŸ‰ğŸ‰ğŸ‰ â€“&gt;3 4ã€‚</p>
<ul>
<li>dispatch_barrier_async</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŒdispatch_queue_createå‡½æ•°ç”Ÿæˆçš„concurrent Dispatch Queueé˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.barrier.async"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----1-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----2-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----barrier-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"ğŸˆğŸˆğŸˆ"</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----3-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"ğŸ‰ğŸ‰ğŸ‰"</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----4-----%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:1 2 â€“&gt; ğŸˆğŸˆğŸˆ ğŸ‰ğŸ‰ğŸ‰â€“&gt; barrier â€“&gt;3 4  å…¶ä¸­12 ä¸ 34 ç”±äºå¹¶è¡Œå¤„ç†å…ˆåé¡ºåºä¸å®šã€‚</p>
<h4 id="dispatch_apply_å¿«é€Ÿéå†">dispatch_apply å¿«é€Ÿéå†</h4><p>ç±»ä¼¼forå¾ªç¯ï¼Œä½†æ˜¯åœ¨å¹¶å‘é˜Ÿåˆ—çš„æƒ…å†µä¸‹dispatch_applyä¼šå¹¶å‘æ‰§è¡Œblockä»»åŠ¡ã€‚<br>dispatch_applyèƒ½é¿å…çº¿ç¨‹çˆ†ç‚¸ï¼Œå› ä¸ºGCDä¼šç®¡ç†å¹¶å‘</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)run:(<span class="built_in">BOOL</span>)explode &#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">"com.starming.gcddemo.concurrentqueue"</span>,DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    <span class="keyword">if</span> (explode) &#123;</span><br><span class="line">        <span class="comment">//ä¼ ç»Ÿforå¾ªç¯ï¼Œæœ‰é—®é¢˜çš„æƒ…å†µï¼Œå¯èƒ½ä¼šæ­»é”</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">999</span> ; i++) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(concurrentQueue, ^&#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"wrong %d"</span>,i);</span><br><span class="line">                <span class="comment">//do something</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//dispatch_applyä¼šä¼˜åŒ–å¾ˆå¤šï¼Œèƒ½å¤Ÿåˆ©ç”¨GCDç®¡ç†</span></span><br><span class="line">        dispatch_apply(<span class="number">999</span>, concurrentQueue, ^(size_t i)&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"correct %zu"</span>,i);</span><br><span class="line">            <span class="comment">//do something</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"The end"</span>); <span class="comment">//è¿™é‡Œæœ‰ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdispatch_applyè¿™ä¸ªæ˜¯ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„ã€‚è¿™ä¸ªlogæ‰“å°ä¼šåœ¨dispatch_applyéƒ½ç»“æŸåæ‰å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">downloadPhotosWithCompletion</span><span class="params">(completion: CompletionClosure?)</span></span> &#123;</span><br><span class="line">     <span class="keyword">var</span> storedError: <span class="type">NSError</span>!</span><br><span class="line">     <span class="keyword">var</span> downloadGroup = dispatch_group_create()</span><br><span class="line">     <span class="keyword">let</span> urls = [url1, url2, url3]</span><br><span class="line"></span><br><span class="line">     dispatch_apply(<span class="type">UInt</span>(urls.<span class="built_in">count</span>), <span class="type">GlobalUserInitiatedQueue</span>) &#123;</span><br><span class="line">          i <span class="keyword">in</span></span><br><span class="line">          <span class="keyword">let</span> index = <span class="type">Int</span>(i)</span><br><span class="line">          <span class="keyword">let</span> address = urls[index]</span><br><span class="line">          <span class="keyword">let</span> url = <span class="type">NSURL</span>(string: address)</span><br><span class="line">          dispatch_group_enter(downloadGroup)</span><br><span class="line">          <span class="keyword">let</span> photo = <span class="type">DownloadPhoto</span>(url: url!) &#123;</span><br><span class="line">               image, error <span class="keyword">in</span></span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">                    storedError = error</span><br><span class="line">               &#125;</span><br><span class="line">               dispatch_group_leave(downloadGroup)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="type">PhotoManager</span>.sharedManager.addPhoto(photo)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     dispatch_group_notify(downloadGroup, <span class="type">GlobalMainQueue</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">let</span> completion = completion &#123;</span><br><span class="line">               completion(error: storedError)</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Dispatch_Block_è°ƒåº¦å—">Dispatch Block è°ƒåº¦å—</h4><p>é˜Ÿåˆ—æ‰§è¡Œä»»åŠ¡éƒ½æ˜¯blockçš„æ–¹å¼</p>
<ul>
<li>åˆ›å»ºblock</li>
</ul>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//normal way</span><br><span class="line">dispatch_queue_t concurrentQueue = dispatch_queue_create<span class="list">(<span class="string">"com.mac.gcd.block"</span>,DISPATCH_QUEUE_CONCURRENT)</span><span class="comment">;</span></span><br><span class="line">dispatch_block_t block = dispatch_block_create<span class="list">(<span class="number">0</span>, ^&#123;</span><br><span class="line">    NSLog<span class="list">(@<span class="string">"run block"</span>)</span><span class="comment">;</span></span><br><span class="line">&#125;)</span><span class="comment">;</span></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">concurrentQueue</span>, block)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">//QOS way</span><br><span class="line">dispatch_block_t qosBlock = dispatch_block_create_with_qos_class<span class="list">(<span class="number">0</span>, QOS_CLASS_USER_INITIATED, <span class="number">-1</span>, ^&#123;</span><br><span class="line">    NSLog<span class="list">(@<span class="string">"run qos block"</span>)</span><span class="comment">;</span></span><br><span class="line">&#125;)</span><span class="comment">;</span></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">concurrentQueue</span>, qosBlock)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>dispatch_block_wait</li>
</ul>
<p>å¯ä»¥æ ¹æ®dispatch blockæ¥è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œå‚æ•°DISPATCH_TIME_FOREVERä¼šä¸€ç›´ç­‰å¾…blockç»“æŸ</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ispatch_queue_t serialQueue = dispatch_queue_create(<span class="string">"com.mac.gcd.block"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">dispatch_block_t block = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"start"</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5.</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"end"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue, block);</span><br><span class="line"><span class="comment">//è®¾ç½®DISPATCH_TIME_FOREVERä¼šä¸€ç›´ç­‰åˆ°å‰é¢ä»»åŠ¡éƒ½å®Œæˆ</span></span><br><span class="line">dispatch_block_wait(block, DISPATCH_TIME_FOREVER);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"ok, now can go on"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>dispatch_block_notify</li>
</ul>
<p>å¯ä»¥ç›‘è§†æŒ‡å®šdispatch blockç»“æŸï¼Œç„¶åå†åŠ å…¥ä¸€ä¸ªblockåˆ°é˜Ÿåˆ—ä¸­ã€‚ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸ºï¼Œç¬¬ä¸€ä¸ªæ˜¯éœ€è¦ç›‘è§†çš„blockï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å¾…åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­çš„block</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"com.mac.gcd.block"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="keyword">dispatch_block_t</span> firstBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    NSLog(@<span class="string">"first block start"</span>);</span><br><span class="line">    [NSThread sleepForTimeInterval:<span class="number">2.f</span>];</span><br><span class="line">    NSLog(@<span class="string">"first block end"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(serialQueue, firstBlock);</span><br><span class="line"><span class="keyword">dispatch_block_t</span> secondBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    NSLog(@<span class="string">"second block run"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//first blockæ‰§è¡Œå®Œæ‰åœ¨serial queueä¸­æ‰§è¡Œsecond block</span></span><br><span class="line">dispatch_block_notify(firstBlock, serialQueue, secondBlock);</span><br></pre></td></tr></table></figure>
<ul>
<li>dispatch_block_cancel</li>
</ul>
<p>iOS8åGCDæ”¯æŒå¯¹dispatch blockçš„å–æ¶ˆ</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"com.mac.gcd.block"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">dispatch_block_t firstBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"first block start"</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"first block end"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_block_t secondBlock = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"second block run"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue, firstBlock);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue, secondBlock);</span><br><span class="line"><span class="comment">//å–æ¶ˆsecondBlock</span></span><br><span class="line">dispatch_block_cancel(secondBlock);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™ä¸ªåªèƒ½å‘ç”Ÿåœ¨blockè¿˜åœ¨é˜Ÿåˆ—ä¸­å¹¶æ²¡æœ‰å¼€å§‹çš„æƒ…å†µä¸‹ã€‚å› ä¸ºæŠŠblockå·²ç»æ”¾åˆ°äº†asyncå¼‚æ­¥è°ƒç”¨ä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ä¼šå…ˆæ‰§è¡Œï¼Œæ‰§è¡Œå®Œäº†æ‰ä¼šæ‰§è¡Œblock</p>
</blockquote>
<h4 id="Dispatch_Semaphore">Dispatch Semaphore</h4><p>ä¸€ç§ä¿è¯åŒæ­¥çš„æ–¹æ³•ã€‚ä½¿ç”¨dispatch_semaphore_signalåŠ 1dispatch_semaphore_waitå‡1ï¼Œä¸º0æ—¶ç­‰å¾…çš„è®¾ç½®æ–¹å¼æ¥è¾¾åˆ°çº¿ç¨‹åŒæ­¥çš„ç›®çš„å’ŒåŒæ­¥é”ä¸€æ ·èƒ½å¤Ÿè§£å†³èµ„æºæŠ¢å çš„é—®é¢˜ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºsemaphore</span></span><br><span class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"start"</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.</span>f];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"semaphore +1"</span>);</span><br><span class="line">    dispatch_semaphore_signal(semaphore); <span class="comment">//+1 semaphore</span></span><br><span class="line">&#125;);</span><br><span class="line">dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"continue"</span>);</span><br><span class="line"><span class="comment">//æ‰“å°ï¼š"start --&gt; semaphore +1 --&gt; continue"</span></span><br></pre></td></tr></table></figure>
<h4 id="GCDæ­»é”">GCDæ­»é”</h4><p><code>å½“å‰ä¸²è¡Œé˜Ÿåˆ—</code>é‡Œé¢<code>åŒæ­¥</code>æ‰§è¡Œ<code>å½“å‰ä¸²è¡Œé˜Ÿåˆ—</code>å°±ä¼šæ­»é”ï¼Œè§£å†³çš„æ–¹æ³•å°±æ˜¯å°†åŒæ­¥çš„ä¸²è¡Œé˜Ÿåˆ—æ”¾åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤Ÿè§£å†³ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¾‹å­1</span></span><br><span class="line"><span class="comment">//ä¸»é˜Ÿåˆ—çš„åŒæ­¥çº¿ç¨‹ï¼ŒæŒ‰ç…§FIFOçš„åŸåˆ™ï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰ï¼Œ2æ’åœ¨3åé¢ä¼šç­‰3æ‰§è¡Œå®Œï¼Œä½†å› ä¸ºåŒæ­¥çº¿ç¨‹ï¼Œ3åˆè¦ç­‰2æ‰§è¡Œå®Œï¼Œç›¸äº’ç­‰å¾…æˆä¸ºæ­»é”ã€‚</span></span><br><span class="line"><span class="comment">// æ­¤å¤„çš„å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸ºmain_queueï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œè€Œ`dispatch_get_main_queue`åˆæ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ä¼šæ­»é”</span></span><br><span class="line"><span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å­2</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">    <span class="comment">// æ­¤å¤„çš„å½“å‰é˜Ÿåˆ—ä¸ºglobal_queueï¼ˆå…¨å±€å¹¶å‘é˜Ÿåˆ—ï¼‰ï¼Œè€Œ`dispatch_get_main_queue`æ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸ä¼šæ­»é”</span></span><br><span class="line">    <span class="comment">//å°†åŒæ­¥çš„ä¸²è¡Œé˜Ÿåˆ—æ”¾åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤Ÿè§£å†³</span></span><br><span class="line">    <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"3"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"4"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"5"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å­3</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"com.mac.gcd.serialqueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">    <span class="comment">//ä¸²è¡Œé˜Ÿåˆ—é‡Œé¢åŒæ­¥åŒä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—å°±ä¼šæ­»é”</span></span><br><span class="line">    <span class="comment">// æ­¤å¤„çš„å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸ºserialQueueï¼ˆä¸²è¡Œé˜Ÿåˆ—ï¼‰ï¼Œè€Œ`dispatch_sync`åˆæ˜¯åœ¨åŒä¸€ä¸ªserialQueueï¼Œæ‰€ä»¥ä¼šæ­»é”</span></span><br><span class="line">    <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"3"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"4"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"5"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å­4</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"com.mac.gcd.serialqueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">    <span class="comment">//ä¸²è¡Œé˜Ÿåˆ—é‡Œé¢åŒæ­¥ä¸åŒçš„ä¸²è¡Œé˜Ÿåˆ—ä¸ä¼šæ­»é”</span></span><br><span class="line">    <span class="comment">// æ­¤å¤„çš„å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸ºserialQueueï¼ˆä¸²è¡Œé˜Ÿåˆ—ï¼‰ï¼Œè€Œ`dispatch_sync`åœ¨å¦ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—é‡Œï¼ˆdispatch_get_main_queueï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šæ­»é”</span></span><br><span class="line">    <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"3"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"4"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"5"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="dispatch_once">dispatch_once</h4><p>dispatch_once_tè¦æ˜¯å…¨å±€æˆ–staticå˜é‡ï¼Œä¿è¯dispatch_once_tåªæœ‰ä¸€ä»½å®ä¾‹</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åªè¿è¡Œä¸€æ¬¡</span></span><br><span class="line">+ (<span class="keyword">id</span>)shareInstance &#123;</span><br><span class="line">    <span class="keyword">static</span> TestClass *shareInstance = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        shareInstance = [[TestClass alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">   <span class="keyword">return</span> shareInstance;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch_after">dispatch_after</h4><p>dispatch_afteråªæ˜¯å»¶æ—¶æäº¤blockï¼Œä¸æ˜¯å»¶æ—¶ç«‹åˆ»æ‰§è¡Œ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> delayInSeconds = <span class="number">2.0</span>;</span><br><span class="line"><span class="keyword">dispatch_time_t</span> popTime = dispatch_time(DISPATCH_TIME_NOW, (<span class="keyword">int64_t</span>) (delayInSeconds * NSEC_PER_SEC));</span><br><span class="line">dispatch_after(popTime, dispatch_get_main_queue(), ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="dispatch_suspendå’Œdispatch_resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—">dispatch_suspendå’Œdispatch_resumeæŒ‚èµ·å’Œæ¢å¤é˜Ÿåˆ—</h4><p>dispatch_suspendè¿™é‡ŒæŒ‚èµ·ä¸ä¼šæš‚åœæ­£åœ¨æ‰§è¡Œçš„blockï¼Œåªæ˜¯èƒ½å¤Ÿæš‚åœè¿˜æ²¡æ‰§è¡Œçš„block</p>
<h6 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h6><blockquote>
<p><a href="http://blog.csdn.net/u013046795/article/details/47057585" target="_blank" rel="external">http://blog.csdn.net/u013046795/article/details/47057585</a><br><a href="https://github.com/ming1016/study/wiki/%E7%BB%86%E8%AF%B4GCD%EF%BC%88Grand-Central-Dispatch%EF%BC%89%E5%A6%82%E4%BD%95%E7%94%A8" target="_blank" rel="external">https://github.com/ming1016/study/wiki/%E7%BB%86%E8%AF%B4GCD%EF%BC%88Grand-Central-Dispatch%EF%BC%89%E5%A6%82%E4%BD%95%E7%94%A8</a><br><a href="https://juejin.im/post/5a5dff6a518825732c538dce" target="_blank" rel="external">https://juejin.im/post/5a5dff6a518825732c538dce</a></p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h4 id="é˜Ÿåˆ—_Dispatch_Queue">é˜Ÿåˆ— Dispatch Queue</h4><ul>
<li>ä¸²è¡Œé˜Ÿåˆ— Serial Dispatch Queue, å…ˆè¿›å…ˆå‡ºæ‰§è¡Œ(FIFO)</li>
<li>å¹¶è¡Œé˜Ÿåˆ— Concurrent Dispatch Queue</]]>
    </summary>
    
      <category term="GCD" scheme="https://litt1e-p.github.io/tags/GCD/"/>
    
      <category term="Objective-C" scheme="https://litt1e-p.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[change statusBar backgroundColor]]></title>
    <link href="https://litt1e-p.github.io/2016/12/03/change-statusBar-backgroundColor/"/>
    <id>https://litt1e-p.github.io/2016/12/03/change-statusBar-backgroundColor/</id>
    <published>2016-12-03T13:31:23.000Z</published>
    <updated>2016-12-03T13:32:25.000Z</updated>
    <content type="html"><![CDATA[<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//for swift</span></span><br><span class="line"></span><br><span class="line">let statWindow = <span class="built_in">UIApplication</span><span class="variable">.shared</span><span class="variable">.value</span>(forKey:<span class="string">"statusBarWindow"</span>) as! <span class="built_in">UIView</span></span><br><span class="line"></span><br><span class="line">let statusBar = statWindow<span class="variable">.subviews</span>[<span class="number">0</span>] as <span class="built_in">UIView</span></span><br><span class="line"></span><br><span class="line">statusBar<span class="variable">.backgroundColor</span> = <span class="built_in">UIColor</span><span class="variable">.red</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for Objective-C</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span> *statusWindow = [[<span class="built_in">UIApplication</span> sharedApplication] valueForKey:<span class="string">@"statusBarWindow"</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span> *statusBar = statusWindow<span class="variable">.subviews</span><span class="variable">.firstObject</span>;</span><br><span class="line"></span><br><span class="line">statusBar<span class="variable">.backgroundColor</span> = <span class="keyword">self</span><span class="variable">.statusBarBackgroundColor</span>;</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span ]]>
    </summary>
    
      <category term="Note" scheme="https://litt1e-p.github.io/tags/Note/"/>
    
      <category term="Objective-C" scheme="https://litt1e-p.github.io/tags/Objective-C/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[autoLayout for UIScrollView in Xib]]></title>
    <link href="https://litt1e-p.github.io/2016/11/26/autoLayout-for-UIScrollView-in-Xib/"/>
    <id>https://litt1e-p.github.io/2016/11/26/autoLayout-for-UIScrollView-in-Xib/</id>
    <published>2016-11-26T07:31:27.000Z</published>
    <updated>2016-11-26T07:32:46.000Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>Using UIScrollView in Xib or storyBoard is quite normal and frequent, but it is a little complicated by using autoLayout because of the complicated scrollViewâ€™s contentSize and contentInsets</p>
</blockquote>
<p>letâ€™s begin</p>
<h4 id="1-0_initial_a_scrollView">1.0 initial a scrollView</h4><ul>
<li>new a project, drag a UIScrollView into Storyboard or Xib and make some constraints:</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1418424-8450a58e55abcf98.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1418424-5881ada668a2f949.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h4 id="2-0_add_a_contenView">2.0 add a contenView</h4><ul>
<li>2.1 drag an UIView named: <code>containView</code> into scrollView and add the edge constraints. the contentSize of scrollView depend on this <code>containView</code> </li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1418424-21e23d2a8f18d687.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>by the way, Xcode interface builder will show some errors, just ignore them.</p>
<ul>
<li>2.2 add some extral constraints to <code>containView</code>  according to the scroll direction</li>
</ul>
<p>so firstly you should make sure that which scroll direction you want</p>
<p>you should not add the constraints like below shows if horizontal and vertical scroll direction are both wanted:</p>
<ul>
<li><p>2.2.1 add a <code>Horizontally in Container</code> and a <code>Vertically in Container</code> constraints</p>
</li>
<li><p>2.2.2 height or width constraints:</p>
</li>
</ul>
<p>for horizontal scroll direction: add a <code>width</code> constraint for <code>containView</code></p>
<p>for vertical scroll direction: add a <code>height</code> constraint for <code>containView</code></p>
<p>and done! ğŸ‰ğŸ‰</p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>Using UIScrollView in Xib or storyBoard is quite normal and frequent, but it is a little complicated by using autoLayout bec]]>
    </summary>
    
      <category term="Note" scheme="https://litt1e-p.github.io/tags/Note/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Cannot convert value of type `SecTrustResultType` to expected argument type `UInt32`]]></title>
    <link href="https://litt1e-p.github.io/2016/11/17/Cannot-convert-value-of-type-SecTrustResultType-to-expected-argument-type-UInt32/"/>
    <id>https://litt1e-p.github.io/2016/11/17/Cannot-convert-value-of-type-SecTrustResultType-to-expected-argument-type-UInt32/</id>
    <published>2016-11-17T14:58:33.000Z</published>
    <updated>2016-11-17T15:00:06.000Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>Cannot convert value of type â€˜SecTrustResultTypeâ€™ to expected argument type â€˜UInt32â€™</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//error example: </span></span><br><span class="line"><span class="keyword">var</span> result = <span class="type">SecTrustResultType</span>(rawValue: <span class="type">SecTrustResultType</span>.<span class="type">Invalid</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//solution:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = <span class="type">SecTrustResultType</span>.<span class="type">Invalid</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// for other enum values</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//let unspecified = SecTrustResultType(rawValue: SecTrustResultType.Unspecified)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//let proceed = SecTrustResultType(rawValue: SecTrustResultType.Proceed)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> unspecified = <span class="type">SecTrustResultType</span>.<span class="type">Unspecified</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> proceed = <span class="type">SecTrustResultType</span>.<span class="type">Proceed</span></span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>Cannot convert value of type â€˜SecTrustResultTypeâ€™ to expected argument type â€˜UInt32â€™</p>
</blockquote>
<figure class="highli]]>
    </summary>
    
      <category term="Note" scheme="https://litt1e-p.github.io/tags/Note/"/>
    
      <category term="swift" scheme="https://litt1e-p.github.io/tags/swift/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[build a https server for localhost]]></title>
    <link href="https://litt1e-p.github.io/2016/10/20/build-a-https-server-for-localhost/"/>
    <id>https://litt1e-p.github.io/2016/10/20/build-a-https-server-for-localhost/</id>
    <published>2016-10-20T13:48:08.000Z</published>
    <updated>2016-10-20T14:09:59.000Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>we need a local https server when https is required in product environment</p>
</blockquote>
<p>let us do it now ğŸ”¨</p>
<h3 id="0-_install_openssl_firstly!">0. install openssl firstly!</h3><h3 id="1-prepare_a_CA_request_files">1.prepare a CA request files</h3><h4 id="1-1_generate_a_RSA_server_key">1.1 generate a RSA server key</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out server<span class="class">.key</span> <span class="number">2048</span></span><br></pre></td></tr></table></figure>
<h4 id="1-2_generate_a_CA_request_file">1.2 generate a CA request file</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -out server<span class="class">.req</span> -key server<span class="class">.key</span> -subj</span><br><span class="line"> <span class="string">"/C=US/ST=LosAngeles/L=LA/O=Namido/CN=127.0.0.1"</span></span><br></pre></td></tr></table></figure>
<p><code>ps. &#39;-subj&#39; can be ignored and you can type them all in the command tool</code></p>
<p>now notice there are two files(server.key, server.req) in current directory, the <code>.key</code> is server private key and the <code>.req</code> is CA request file.</p>
<p>let us get CA signature with <code>server.req</code> if there is no error occured</p>
<h3 id="2-make_an_our_own_CA">2.make an our own CA</h3><h4 id="2-1_generate_a_RSA_key">2.1 generate a RSA key</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -<span class="keyword">out</span> <span class="keyword">ca</span>.key 2048</span><br></pre></td></tr></table></figure>
<h4 id="2-2_root_signature_for_self">2.2 root signature for self</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -days <span class="number">1000</span> -key ca<span class="class">.key</span> -out ca<span class="class">.crt</span> -sha256 -subj </span><br><span class="line"><span class="string">"/C=US/ST=LosAngeles/L=LA/O=Namido/CN=Namido CA"</span></span><br></pre></td></tr></table></figure>
<p>notice: <code>value of CN in -subj is the name of CA</code></p>
<h4 id="2-3_generate_a_server_certificate_with_this_root_signature">2.3 generate a server certificate with this root signature</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> server<span class="class">.req</span> -out server<span class="class">.crt</span> -CAkey ca<span class="class">.key</span> -CA ca<span class="class">.crt</span> -days <span class="number">1000</span> </span><br><span class="line">-sha256 -CAcreateserial -CAserial server.serial</span><br></pre></td></tr></table></figure>
<p>the <code>server.crt</code> file that via our own CA generated will exists in current directory if no error occur. </p>
<h3 id="3-0_finally_process">3.0 finally process</h3><h4 id="3-1_add_them_to_server_configuration">3.1 add them to server configuration</h4><p>copy <code>ca.crt</code>, <code>server.crt</code>, <code>server.key</code> three files to HTTPS server such as Nginx/Apache or other server by using <code>server.crt</code> as server certificate, <code>server.key</code> as server private key, <code>ca.crt</code> as keychain certificate.</p>
<p>for example:</p>
<p>this is a node.js server souce code</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line"></span><br><span class="line">	key: fs.readFileSync(<span class="string">'./keys/server.key'</span>),</span><br><span class="line"></span><br><span class="line">	ca: [fs.readFileSync(<span class="string">'./keys/ca.crt'</span>)],</span><br><span class="line"></span><br><span class="line">	cert: fs.readFileSync(<span class="string">'./keys/server.crt'</span>)</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">https.createServer(options, app).listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is running on port 3000'</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="3-2_make_it_valid">3.2 make it valid</h4><p>copy  <code>ca.crt</code> to your local computer somewhere and double click it and modify <code>always trust</code> in your keychain to make it valid.</p>
<p><img src="http://ww2.sinaimg.cn/large/006y8lVagw1f8mcm69ot9j30n60csq3i.jpg" alt=""></p>
<p>done! ğŸ‰</p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>we need a local https server when https is required in product environment</p>
</blockquote>
<p>let us do it now ğŸ”¨</p>
<h3 ]]>
    </summary>
    
      <category term="Node.js" scheme="https://litt1e-p.github.io/tags/Node-js/"/>
    
      <category term="RSA" scheme="https://litt1e-p.github.io/tags/RSA/"/>
    
      <category term="https" scheme="https://litt1e-p.github.io/tags/https/"/>
    
      <category term="openssl" scheme="https://litt1e-p.github.io/tags/openssl/"/>
    
  </entry>
  
</feed>
